# <!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** user relying on assistive technology,
**I want** comprehensive keyboard navigation, screen reader support, and WCAG AA compliance,
**so that** I can use the application independently and effectively

## Acceptance Criteria
1. Lighthouse Accessibility score ≥95
2. axe DevTools reports 0 violations
3. All interactive elements have ARIA labels
4. Focus indicators visible (3px outline, design token color)
5. Skip link to main content
6. ARIA live regions announce new messages
7. Landmark roles on all major sections
8. Color contrast ≥4.5:1 (WCAG AA)
9. All images have alt text
10. Form inputs have associated labels
11. Modal focus trap (Tab cycles within modal)
12. Screen reader announces loading states
13. VoiceOver testing passed (macOS)
14. NVDA testing passed (Windows)
15. Tab order logical and intuitive

## Tasks / Subtasks

- [ ] Task 1: Run axe DevTools audit (AC: 2)
  - [ ] Install axe DevTools browser extension
  - [ ] Run audit on every page of application
  - [ ] Document all violations found
  - [ ] Categorize by severity (critical, serious, moderate, minor)
  - [ ] Create action plan to fix all violations
  - [ ] Track violations in spreadsheet

- [ ] Task 2: Add ARIA labels to buttons without text (AC: 3)
  - [ ] Audit all icon-only buttons
  - [ ] Add `aria-label` to:
    - Theme toggle button
    - Menu toggle button
    - Close modal buttons
    - Expand/collapse panel buttons
  - [ ] Verify labels are descriptive
  - [ ] Test with screen reader

- [ ] Task 3: Add ARIA live region for new messages (AC: 6)
  - [ ] Create hidden live region div
  - [ ] Set `role="log"` and `aria-live="polite"`
  - [ ] Update with latest message content
  - [ ] Test announcements don't interrupt user
  - [ ] Verify only new messages announced
  - [ ] Test with VoiceOver and NVDA

- [ ] Task 4: Implement focus trap for modals (AC: 11)
  - [ ] Create `hooks/use-focus-trap.ts` hook
  - [ ] Capture focus when modal opens
  - [ ] Trap Tab/Shift+Tab within modal
  - [ ] Return focus to trigger element on close
  - [ ] Handle Escape key to close
  - [ ] Test with keyboard only (no mouse)

- [ ] Task 5: Add skip link to main content (AC: 5)
  - [ ] Add skip link at top of page
  - [ ] Style: hidden until focused
  - [ ] Position: top-left when visible
  - [ ] Link to `#main-content` anchor
  - [ ] Test keyboard navigation (Tab on page load)
  - [ ] Verify skip works

- [ ] Task 6: Update landmarks with proper roles (AC: 7)
  - [ ] Add `role="navigation"` to tab navigation
  - [ ] Add `role="main"` with `id="main-content"` to chat area
  - [ ] Add `role="complementary"` to agent panel
  - [ ] Add `role="complementary"` to log panel
  - [ ] Add `aria-label` to each landmark for clarity
  - [ ] Test landmark navigation with screen reader

- [ ] Task 7: Verify color contrast (AC: 8)
  - [ ] Install color contrast checker tool
  - [ ] Check all text/background combinations
  - [ ] Verify contrast ratio ≥4.5:1
  - [ ] Fix any failing combinations
  - [ ] Document contrast ratios in design tokens
  - [ ] Test with Chrome DevTools (inspect → contrast)

- [ ] Task 8: Add focus indicators to all interactive elements (AC: 4)
  - [ ] Update `globals.css` with focus styles
  - [ ] Add `*:focus-visible` selector
  - [ ] Style: 3px outline, primary color, 2px offset
  - [ ] Test on all interactive elements:
    - Buttons
    - Links
    - Inputs
    - Cards (if clickable)
  - [ ] Ensure high contrast (visible on all backgrounds)

- [ ] Task 9: Create focus management utility (AC: 4, 11)
  - [ ] Create `lib/utils/focus.ts`
  - [ ] Implement `trapFocus(element)` function
  - [ ] Implement `restoreFocus(element)` function
  - [ ] Implement `getFocusableElements(container)` helper
  - [ ] Export utilities
  - [ ] Write tests

- [ ] Task 10: Add loading announcements (AC: 12)
  - [ ] Add `aria-busy="true"` to loading components
  - [ ] Add visually hidden "Loading..." text
  - [ ] Use ARIA live region for loading state changes
  - [ ] Test screen reader announces loading
  - [ ] Test announces when loading completes

- [ ] Task 11: Test with VoiceOver (macOS/iOS) (AC: 13)
  - [ ] Enable VoiceOver (Cmd+F5)
  - [ ] Navigate entire application with keyboard
  - [ ] Verify all content announced correctly
  - [ ] Test form inputs (labels announced)
  - [ ] Test modals (focus trap works)
  - [ ] Test ARIA live regions (messages announced)
  - [ ] Document any issues found
  - [ ] Fix issues and re-test

- [ ] Task 12: Test with NVDA (Windows) (AC: 14)
  - [ ] Install NVDA (free screen reader)
  - [ ] Navigate entire application with keyboard
  - [ ] Verify all content announced correctly
  - [ ] Test form inputs
  - [ ] Test modals
  - [ ] Test ARIA live regions
  - [ ] Document any issues found
  - [ ] Fix issues and re-test

- [ ] Task 13: Verify tab order (AC: 15)
  - [ ] Navigate application with Tab key only
  - [ ] Verify logical order:
    1. Skip link
    2. Tab navigation
    3. Agent panel
    4. Chat input
    5. Messages
    6. Log panel
  - [ ] Fix any issues with `tabIndex`
  - [ ] Ensure no keyboard traps

- [ ] Task 14: Create accessibility documentation (AC: All)
  - [ ] Document accessibility features
  - [ ] Create testing checklist
  - [ ] Add WCAG compliance statement
  - [ ] Document known issues (if any)
  - [ ] Add to architecture docs

- [ ] Task 15: Write automated accessibility tests (AC: All)
  - [ ] Install @axe-core/react
  - [ ] Add axe checks to component tests
  - [ ] Test ARIA attributes present
  - [ ] Test focus management
  - [ ] Test keyboard navigation
  - [ ] Achieve 90%+ coverage

## Dev Notes

### Previous Story Context
From Story 5.4 (Keyboard Shortcuts):
- Comprehensive keyboard navigation implemented
- Shortcuts help modal with keyboard controls
- Tab navigation with keyboard support

From Story 5.3 (Reduced Motion):
- Animations respect prefers-reduced-motion
- Accessibility consideration for vestibular disorders

From All Stories:
- Components built with semantic HTML
- Some ARIA attributes already present
- Focus management partially implemented

### Architecture References

**WCAG 2.1 Level AA Requirements** [Source: W3C WCAG 2.1]

**Perceivable:**
- 1.4.3: Contrast (Minimum) - 4.5:1 for normal text
- 1.4.11: Non-text Contrast - 3:1 for UI components

**Operable:**
- 2.1.1: Keyboard - All functionality available via keyboard
- 2.1.2: No Keyboard Trap - Users can navigate away
- 2.4.3: Focus Order - Logical and intuitive
- 2.4.7: Focus Visible - Visible focus indicator

**Understandable:**
- 3.2.4: Consistent Identification - Consistent UI components
- 3.3.2: Labels or Instructions - Form inputs labeled

**Robust:**
- 4.1.2: Name, Role, Value - All UI components have accessible names
- 4.1.3: Status Messages - Use ARIA live regions

### Code Examples

**Skip Link** (app/layout.tsx):
```typescript
export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body>
        <a
          href="#main-content"
          className="skip-link"
        >
          Skip to main content
        </a>
        {children}
      </body>
    </html>
  );
}
```

**Skip Link Styles** (globals.css):
```css
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  z-index: 100;
  padding: 8px 16px;
  background: var(--color-primary);
  color: white;
  text-decoration: none;
  font-weight: 600;
}

.skip-link:focus {
  top: 4px;
  left: 4px;
}
```

**ARIA Live Region** (components/chat/chat-interface.tsx):
```typescript
export function ChatInterface() {
  const { state } = useChat();
  const latestMessage = state.messages[state.messages.length - 1];

  return (
    <>
      {/* Screen reader announcements */}
      <div
        role="log"
        aria-live="polite"
        aria-atomic="false"
        aria-relevant="additions"
        className="sr-only"
      >
        {latestMessage && (
          <p>
            {latestMessage.role === 'user' ? 'You said: ' : 'Assistant: '}
            {latestMessage.content}
          </p>
        )}
      </div>

      {/* Visible UI */}
      <MessageList messages={state.messages} />
    </>
  );
}
```

**Landmark Roles** (components/layout/three-panel-layout.tsx):
```typescript
export function ThreePanelLayout() {
  return (
    <div className="grid grid-cols-[250px_1fr_300px]">
      {/* Agent Panel */}
      <aside
        role="complementary"
        aria-label="Agent status panel"
        className="agent-panel"
      >
        <AgentPanel />
      </aside>

      {/* Chat Panel */}
      <main
        role="main"
        id="main-content"
        aria-label="Chat conversation"
        className="chat-panel"
      >
        <ChatInterface />
      </main>

      {/* Log Panel */}
      <aside
        role="complementary"
        aria-label="Retrieval logs panel"
        className="log-panel"
      >
        <RetrievalPanel />
      </aside>
    </div>
  );
}
```

**Focus Trap Hook** (hooks/use-focus-trap.ts):
```typescript
'use client';

import { useEffect, useRef } from 'react';

/**
 * Traps focus within a container element
 * Used for modal dialogs to meet WCAG 2.1 requirements
 *
 * @param isActive - Whether focus trap is active
 */
export function useFocusTrap(isActive: boolean) {
  const containerRef = useRef<HTMLDivElement>(null);
  const previousFocusRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    if (!isActive || !containerRef.current) return;

    const container = containerRef.current;

    // Save previously focused element
    previousFocusRef.current = document.activeElement as HTMLElement;

    // Get all focusable elements
    const getFocusableElements = (): HTMLElement[] => {
      const selector = [
        'a[href]',
        'button:not([disabled])',
        'input:not([disabled])',
        'textarea:not([disabled])',
        'select:not([disabled])',
        '[tabindex]:not([tabindex="-1"])',
      ].join(',');

      return Array.from(container.querySelectorAll(selector));
    };

    // Focus first element
    const focusableElements = getFocusableElements();
    if (focusableElements.length > 0) {
      focusableElements[0].focus();
    }

    // Handle Tab key
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key !== 'Tab') return;

      const focusable = getFocusableElements();
      const firstElement = focusable[0];
      const lastElement = focusable[focusable.length - 1];

      if (event.shiftKey) {
        // Shift+Tab: Focus last if on first
        if (document.activeElement === firstElement) {
          event.preventDefault();
          lastElement?.focus();
        }
      } else {
        // Tab: Focus first if on last
        if (document.activeElement === lastElement) {
          event.preventDefault();
          firstElement?.focus();
        }
      }
    };

    container.addEventListener('keydown', handleKeyDown);

    // Cleanup: Restore focus
    return () => {
      container.removeEventListener('keydown', handleKeyDown);
      previousFocusRef.current?.focus();
    };
  }, [isActive]);

  return containerRef;
}
```

**Focus Trap Usage** (components/modals/shortcuts-help.tsx):
```typescript
import { useFocusTrap } from '@/hooks/use-focus-trap';

export function ShortcutsHelp({ isOpen, onClose }: Props) {
  const containerRef = useFocusTrap(isOpen);

  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div
      ref={containerRef}
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
      className="modal"
    >
      <h2 id="modal-title">Keyboard Shortcuts</h2>
      {/* Modal content */}
      <button onClick={onClose} aria-label="Close modal">
        <X size={20} />
      </button>
    </div>
  );
}
```

**Focus Indicator Styles** (globals.css):
```css
/**
 * Focus indicators for keyboard navigation
 * WCAG 2.1 Level AA compliance
 */
*:focus-visible {
  outline: 3px solid var(--color-primary);
  outline-offset: 2px;
}

/* Higher contrast for dark backgrounds */
[data-theme='dark'] *:focus-visible {
  outline-color: var(--color-primary-light);
}

/* Remove default browser outline */
*:focus {
  outline: none;
}

/* Only show custom outline on keyboard focus */
*:focus:not(:focus-visible) {
  outline: none;
}
```

**Screen Reader Only Class** (globals.css):
```css
/**
 * Visually hidden but available to screen readers
 * WCAG technique for accessible labels
 */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Show on focus for keyboard users */
.sr-only:focus {
  position: static;
  width: auto;
  height: auto;
  padding: inherit;
  margin: inherit;
  overflow: visible;
  clip: auto;
  white-space: normal;
}
```

**Loading State Announcement** (components/ui/loading-spinner.tsx):
```typescript
export function LoadingSpinner({ message = 'Loading...' }: Props) {
  return (
    <div role="status" aria-live="polite" aria-busy="true">
      <div className="spinner" aria-hidden="true">
        <Loader2 className="animate-spin" />
      </div>
      <span className="sr-only">{message}</span>
    </div>
  );
}
```

**ARIA Button Labels** (components/panels/agent-card.tsx):
```typescript
export function AgentCard({ agent, onViewGraph }: Props) {
  return (
    <div className="agent-card">
      <h3>{agent}</h3>

      {/* Icon-only button needs ARIA label */}
      <button
        onClick={onViewGraph}
        aria-label={`View ${agent} dependency graph`}
      >
        <GitGraph size={20} aria-hidden="true" />
      </button>
    </div>
  );
}
```

**Color Contrast Documentation** (design tokens):
```css
:root {
  /* Text on background: 4.52:1 ✓ */
  --color-text: #1a1a1a;
  --color-background: #ffffff;

  /* Primary button: 4.59:1 ✓ */
  --color-primary: #0066cc;
  --color-primary-text: #ffffff;

  /* Secondary button: 5.12:1 ✓ */
  --color-secondary: #6c757d;
  --color-secondary-text: #ffffff;

  /* Link: 4.86:1 ✓ */
  --color-link: #0056b3;

  /* All combinations meet WCAG AA (4.5:1 minimum) */
}
```

**Test Example** (components/__tests__/accessibility.test.tsx):
```typescript
import { render } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { ChatInterface } from '../chat/chat-interface';

expect.extend(toHaveNoViolations);

describe('Accessibility', () => {
  it('has no axe violations', async () => {
    const { container } = render(<ChatInterface />);
    const results = await axe(container);

    expect(results).toHaveNoViolations();
  });

  it('has skip link', () => {
    const { getByText } = render(<RootLayout />);
    const skipLink = getByText('Skip to main content');

    expect(skipLink).toBeInTheDocument();
    expect(skipLink).toHaveAttribute('href', '#main-content');
  });

  it('has landmark roles', () => {
    const { getByRole } = render(<ThreePanelLayout />);

    expect(getByRole('main')).toBeInTheDocument();
    expect(getByRole('complementary', { name: /agent/i })).toBeInTheDocument();
    expect(getByRole('complementary', { name: /log/i })).toBeInTheDocument();
  });

  it('has ARIA live region for messages', () => {
    const { container } = render(<ChatInterface />);
    const liveRegion = container.querySelector('[role="log"][aria-live="polite"]');

    expect(liveRegion).toBeInTheDocument();
  });

  it('icon buttons have ARIA labels', () => {
    const { getByLabelText } = render(<AgentCard agent="BILLING" />);

    expect(getByLabelText(/view.*graph/i)).toBeInTheDocument();
  });

  it('modal has focus trap', () => {
    const { getByRole } = render(<ShortcutsHelp isOpen={true} />);
    const modal = getByRole('dialog');

    expect(modal).toHaveAttribute('aria-modal', 'true');
    expect(modal).toHaveAttribute('aria-labelledby');
  });
});
```

**Lighthouse CI Check** (.github/workflows/accessibility.yml):
```yaml
name: Accessibility Check

on:
  pull_request:
    branches: [main]

jobs:
  a11y:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install
        working-directory: orchestratai_client

      - name: Build
        run: bun run build
        working-directory: orchestratai_client

      - name: Run Lighthouse
        run: |
          npm install -g @lhci/cli
          lhci autorun --collect.settings.onlyCategories=accessibility
        working-directory: orchestratai_client

      - name: Check score
        run: |
          # Fail if accessibility score < 95
          score=$(jq '.categories.accessibility.score' .lighthouseci/manifest.json)
          if (( $(echo "$score < 0.95" | bc -l) )); then
            echo "Accessibility score $score is below 95"
            exit 1
          fi
```

### File Structure
[Source: architecture/source-tree.md]

```
orchestratai_client/src/
├── hooks/
│   ├── use-focus-trap.ts               # NEW: Focus trap for modals
│   └── __tests__/
│       └── use-focus-trap.test.ts      # NEW: Focus trap tests
├── lib/
│   └── utils/
│       └── focus.ts                    # NEW: Focus management utilities
├── app/
│   ├── layout.tsx                      # UPDATE: Add skip link
│   └── globals.css                     # UPDATE: Focus styles, sr-only class
├── components/
│   ├── layout/
│   │   └── three-panel-layout.tsx      # UPDATE: Add landmark roles
│   ├── chat/
│   │   └── chat-interface.tsx          # UPDATE: Add ARIA live region
│   ├── modals/
│   │   └── shortcuts-help.tsx          # UPDATE: Add focus trap
│   └── ui/
│       └── loading-spinner.tsx         # UPDATE: Add ARIA busy
└── __tests__/
    └── accessibility.test.tsx          # NEW: Accessibility tests
```

### Integration Points
- Affects ALL components across application
- Keyboard shortcuts from Story 5.4 enhance accessibility
- Modal components need focus trap
- Forms need proper labels
- Loading states need ARIA announcements

### Testing Requirements
- **Automated Tests**: jest-axe for zero violations
- **Manual Testing**: VoiceOver (Mac) and NVDA (Windows)
- **Lighthouse**: Accessibility score ≥95
- **Coverage Target**: 90%+
- **Real User Testing**: Test with actual screen reader users (if possible)

**Testing Checklist:**
- [ ] Lighthouse Accessibility score ≥95
- [ ] axe DevTools: 0 violations
- [ ] All buttons have labels
- [ ] Focus indicators visible
- [ ] Skip link works
- [ ] ARIA live regions announce
- [ ] Landmarks labeled correctly
- [ ] Color contrast ≥4.5:1
- [ ] Images have alt text
- [ ] Forms have labels
- [ ] Modal focus trap works
- [ ] Loading states announced
- [ ] VoiceOver test passed
- [ ] NVDA test passed
- [ ] Tab order logical

### Performance Considerations
- ARIA attributes don't impact performance
- Screen reader announcements are async (non-blocking)
- Focus trap adds minimal JavaScript
- Accessibility improves UX for everyone (not just disabled users)

### Accessibility Testing Tools

**Browser Extensions:**
- axe DevTools (free, comprehensive)
- WAVE (visual feedback)
- Lighthouse (built into Chrome DevTools)

**Screen Readers:**
- VoiceOver (macOS/iOS, free, built-in)
- NVDA (Windows, free, open-source)
- JAWS (Windows, paid, industry standard)

**Automated Testing:**
- jest-axe (unit tests)
- @axe-core/react (runtime checking)
- pa11y (CLI tool)

**Manual Testing:**
- Keyboard only (no mouse)
- Color blindness simulators
- Zoom to 200% (text should still be readable)

### Common Accessibility Issues and Fixes

**Issue 1: Missing alt text on images**
```typescript
// ❌ Bad
<img src="/logo.png" />

// ✅ Good
<img src="/logo.png" alt="OrchestratAI Logo" />
```

**Issue 2: Icon-only buttons without labels**
```typescript
// ❌ Bad
<button onClick={onClose}>
  <X size={20} />
</button>

// ✅ Good
<button onClick={onClose} aria-label="Close dialog">
  <X size={20} aria-hidden="true" />
</button>
```

**Issue 3: Form inputs without labels**
```typescript
// ❌ Bad
<input type="text" placeholder="Enter message" />

// ✅ Good
<label htmlFor="message-input">
  Enter message
</label>
<input id="message-input" type="text" />
```

**Issue 4: Low color contrast**
```css
/* ❌ Bad: 2.5:1 contrast */
color: #999;
background: #fff;

/* ✅ Good: 4.5:1 contrast */
color: #666;
background: #fff;
```

**Issue 5: Keyboard trap (can't Tab out)**
```typescript
// ❌ Bad
<div onKeyDown={(e) => e.preventDefault()}>

// ✅ Good: Allow Tab to navigate
<div onKeyDown={(e) => {
  if (e.key !== 'Tab') e.preventDefault();
}}>
```

### WCAG 2.1 Level AA Checklist

**Perceivable:**
- [x] 1.4.3: Color contrast ≥4.5:1
- [x] 1.4.11: Non-text contrast ≥3:1
- [x] 1.1.1: All images have alt text

**Operable:**
- [x] 2.1.1: All functionality available via keyboard
- [x] 2.1.2: No keyboard traps
- [x] 2.4.3: Logical focus order
- [x] 2.4.7: Visible focus indicators

**Understandable:**
- [x] 3.2.4: Consistent UI components
- [x] 3.3.2: Form inputs have labels

**Robust:**
- [x] 4.1.2: All components have accessible names
- [x] 4.1.3: Status messages use ARIA live regions

### Dependencies
```json
{
  "devDependencies": {
    "jest-axe": "^8.0.0",
    "@axe-core/react": "^4.8.0",
    "@types/jest-axe": "^3.5.9"
  }
}
```

Install with:
```bash
cd orchestratai_client
bun add -d jest-axe @axe-core/react @types/jest-axe
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
