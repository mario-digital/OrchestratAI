# <!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** user,
**I want** smooth, polished animations when messages appear and panels collapse,
**so that** the application feels premium and professional like commercial SaaS products

## Acceptance Criteria
1. Messages fade in with slide-up motion (300ms duration)
2. Panel collapse/expand uses spring animation (smooth, natural feel)
3. Panels have staggered reveal on initial page load (100ms delay between each)
4. Message list auto-scrolls smoothly to newest message
5. Typing indicator has bouncing dots animation
6. All animations run at 60fps (no jank or frame drops)
7. Animations use GPU acceleration (transform and opacity only)
8. Animation variants are centralized in reusable file
9. Spring animations have natural physics (stiffness: 300, damping: 30)
10. Smooth scroll behavior uses ease-out curve

## Tasks / Subtasks

- [ ] Task 1: Create centralized animations library (AC: 8, 9)
  - [ ] Create `lib/animations.ts` file
  - [ ] Define `fadeSlideUp` variant (opacity 0→1, y 20→0, 300ms)
  - [ ] Define `panelSlide` variant (x -300→0, spring physics)
  - [ ] Define `staggerContainer` variant (100ms stagger children)
  - [ ] Define `cardHover` variant for agent cards (scale 1→1.02)
  - [ ] Define `bounceAnimation` for typing indicator dots
  - [ ] Export all variants with TypeScript types
  - [ ] Add JSDoc comments explaining each variant
  - [ ] Write unit tests for animation configurations

- [ ] Task 2: Add fade-slide animation to messages (AC: 1, 6, 7)
  - [ ] Open `components/chat/message-bubble.tsx`
  - [ ] Import `motion` from framer-motion
  - [ ] Import `fadeSlideUp` from lib/animations
  - [ ] Wrap message content in `<motion.div {...fadeSlideUp}>`
  - [ ] Add unique key prop for AnimatePresence
  - [ ] Test animation performance with Chrome DevTools (60fps check)
  - [ ] Ensure only transform and opacity are animated (GPU accelerated)
  - [ ] Write tests for message animation rendering

- [ ] Task 3: Update panel collapse with spring animation (AC: 2, 9)
  - [ ] Open `components/panels/collapsible-panel.tsx` from Story 1.8
  - [ ] Replace existing transition with `panelSlide` variant
  - [ ] Use motion.div instead of regular div for collapsible content
  - [ ] Add spring physics: `transition={{ type: 'spring', stiffness: 300, damping: 30 }}`
  - [ ] Test collapse/expand feels natural (not too bouncy)
  - [ ] Adjust stiffness/damping if needed based on feel
  - [ ] Write tests for panel animation

- [ ] Task 4: Implement staggered panel reveal on load (AC: 3)
  - [ ] Open `components/layout/three-panel-layout.tsx`
  - [ ] Wrap panel container in motion.div with `staggerContainer` variant
  - [ ] Wrap each panel (agent, chat, log) in motion.div as children
  - [ ] Add `variants={fadeSlideUp}` to each panel
  - [ ] Set stagger delay to 100ms (0.1s between panels)
  - [ ] Test that panels appear sequentially on page load
  - [ ] Ensure stagger only happens on initial mount (not on every render)
  - [ ] Write tests for stagger animation

- [ ] Task 5: Add smooth auto-scroll to newest message (AC: 4, 10)
  - [ ] Open `components/chat/message-list.tsx`
  - [ ] Add ref to message list container: `const listRef = useRef<HTMLDivElement>(null)`
  - [ ] Create `scrollToBottom` function with smooth behavior
  - [ ] Use `scrollIntoView({ behavior: 'smooth', block: 'end' })`
  - [ ] Call scrollToBottom when new message added (useEffect)
  - [ ] Add ease-out curve to scroll animation (CSS `scroll-behavior: smooth`)
  - [ ] Test scroll doesn't interrupt user if they've scrolled up
  - [ ] Only auto-scroll if user is near bottom (within 100px threshold)
  - [ ] Write tests for auto-scroll behavior

- [ ] Task 6: Enhance typing indicator animation (AC: 5)
  - [ ] Open `components/chat/typing-indicator.tsx` from Story 2.5
  - [ ] Import bounceAnimation variant
  - [ ] Wrap each dot in motion.span
  - [ ] Add staggered bounce animation (each dot delayed by 150ms)
  - [ ] Use spring animation for natural bounce
  - [ ] Animation loops infinitely: `transition={{ repeat: Infinity }}`
  - [ ] Test indicator looks smooth and professional
  - [ ] Write tests for typing indicator animation

- [ ] Task 7: Optimize animation performance (AC: 6, 7)
  - [ ] Add `will-change: transform` CSS hint to animated elements
  - [ ] Remove will-change after animation completes (prevent memory overhead)
  - [ ] Use `layoutId` prop for shared element transitions (if needed)
  - [ ] Profile with Chrome DevTools Performance tab
  - [ ] Verify 60fps during all animations (no dropped frames)
  - [ ] Test on low-end device (CPU throttling 6x slowdown)
  - [ ] Ensure no more than 3 animations run simultaneously

- [ ] Task 8: Add AnimatePresence for exit animations (AC: 1)
  - [ ] Wrap message list in `<AnimatePresence mode="popLayout">`
  - [ ] Add exit animation to fadeSlideUp: `exit: { opacity: 0, y: -20 }`
  - [ ] Test messages smoothly exit when cleared
  - [ ] Ensure no layout shift during exit animations
  - [ ] Write tests for exit animations

- [ ] Task 9: Test animation consistency across browsers (AC: 6)
  - [ ] Test on Chrome (desktop + mobile)
  - [ ] Test on Safari (desktop + iOS)
  - [ ] Test on Firefox
  - [ ] Verify 60fps on all browsers
  - [ ] Check animations don't cause layout shifts (CLS score)
  - [ ] Document any browser-specific issues

- [ ] Task 10: Write comprehensive tests (AC: All)
  - [ ] Test animation variants are applied correctly
  - [ ] Test stagger timing (100ms between panels)
  - [ ] Test auto-scroll triggers on new message
  - [ ] Test auto-scroll respects user scroll position
  - [ ] Test typing indicator animation loops
  - [ ] Test panel spring animation feels natural
  - [ ] Achieve 90%+ coverage

## Dev Notes

### Previous Story Context
From Story 1.8 (Collapsible Panel):
- CollapsiblePanel component has basic slide animation
- Uses Tailwind transition classes
- Needs upgrade to Framer Motion spring physics

From Story 2.5 (Message Components):
- MessageBubble displays individual messages
- TypingIndicator shows three dots
- Both need animation enhancements

From Story 4.2 (Tab Switching Animations):
- Framer Motion already installed
- Tab switching uses slide animations (100ms duration)
- Pattern established for motion.div usage

### Framer Motion Library
**[Source: Epic 5 spec, architecture/3-tech-stack.md]**
- Already installed in Story 4.2: `framer-motion` (latest)
- No additional installation needed
- Import: `import { motion, AnimatePresence } from 'framer-motion'`

### Animation Variants Library Structure
**[Source: Epic 5 spec]**

```typescript
// lib/animations.ts
import type { Variants, Transition } from 'framer-motion';

/**
 * Fade in with slide up motion
 * Use for: Messages, cards, any content appearing
 */
export const fadeSlideUp: Variants = {
  initial: {
    opacity: 0,
    y: 20,
  },
  animate: {
    opacity: 1,
    y: 0,
  },
  exit: {
    opacity: 0,
    y: -20,
  },
  transition: {
    duration: 0.3,
    ease: 'easeOut',
  } as Transition,
};

/**
 * Panel slide with spring physics
 * Use for: Collapsible panels, sidebars
 */
export const panelSlide: Variants = {
  initial: {
    x: -300,
    opacity: 0,
  },
  animate: {
    x: 0,
    opacity: 1,
  },
  exit: {
    x: -300,
    opacity: 0,
  },
  transition: {
    type: 'spring',
    stiffness: 300,
    damping: 30,
  } as Transition,
};

/**
 * Stagger children animations
 * Use for: Sequential reveals (panels, list items)
 */
export const staggerContainer: Variants = {
  animate: {
    transition: {
      staggerChildren: 0.1, // 100ms between children
    },
  },
};

/**
 * Card hover effect
 * Use for: Agent cards, interactive elements
 */
export const cardHover: Variants = {
  hover: {
    scale: 1.02,
    boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
    transition: {
      duration: 0.2,
    },
  },
};

/**
 * Bouncing animation for typing indicator dots
 * Use for: Loading indicators, typing dots
 */
export const bounceAnimation: Variants = {
  initial: {
    y: 0,
  },
  animate: {
    y: [0, -10, 0],
    transition: {
      duration: 0.6,
      ease: 'easeInOut',
      repeat: Infinity,
      repeatDelay: 0,
    },
  },
};
```

### MessageBubble Animation Integration
**[Source: Epic 5 spec, Story 2.5]**

```tsx
// components/chat/message-bubble.tsx
'use client';

import { motion } from 'framer-motion';
import { fadeSlideUp } from '@/lib/animations';
import type { Message } from '@/lib/types';

interface MessageBubbleProps {
  message: Message;
}

export function MessageBubble({ message }: MessageBubbleProps) {
  return (
    <motion.div
      {...fadeSlideUp}
      key={message.id} // Important for AnimatePresence
      className={/* existing classes */}
    >
      {/* existing message content */}
    </motion.div>
  );
}
```

### Panel Collapse Spring Animation
**[Source: Epic 5 spec, Story 1.8]**

```tsx
// components/panels/collapsible-panel.tsx
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { panelSlide } from '@/lib/animations';

export function CollapsiblePanel({ isOpen, children }: Props) {
  return (
    <AnimatePresence mode="wait">
      {isOpen && (
        <motion.div
          {...panelSlide}
          key="panel-content"
        >
          {children}
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

### Staggered Panel Reveal
**[Source: Epic 5 spec]**

```tsx
// components/layout/three-panel-layout.tsx
'use client';

import { motion } from 'framer-motion';
import { staggerContainer, fadeSlideUp } from '@/lib/animations';

export function ThreePanelLayout() {
  return (
    <motion.div
      className="grid grid-cols-[250px_1fr_300px]"
      variants={staggerContainer}
      initial="initial"
      animate="animate"
    >
      {/* Agent Panel */}
      <motion.div variants={fadeSlideUp}>
        <AgentPanel />
      </motion.div>

      {/* Chat Panel */}
      <motion.div variants={fadeSlideUp}>
        <ChatInterface />
      </motion.div>

      {/* Log Panel */}
      <motion.div variants={fadeSlideUp}>
        <RetrievalPanel />
      </motion.div>
    </motion.div>
  );
}
```

**Important:** Only animate on initial mount, not on every render. Use `initial="initial"` only on first render.

### Smooth Auto-Scroll Implementation
**[Source: Epic 5 spec, Web APIs]**

```tsx
// components/chat/message-list.tsx
'use client';

import { useEffect, useRef } from 'react';

export function MessageList({ messages }: Props) {
  const listRef = useRef<HTMLDivElement>(null);
  const lastMessageRef = useRef<HTMLDivElement>(null);

  const isNearBottom = () => {
    if (!listRef.current) return true;

    const { scrollTop, scrollHeight, clientHeight } = listRef.current;
    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;

    return distanceFromBottom < 100; // Within 100px of bottom
  };

  const scrollToBottom = () => {
    if (!lastMessageRef.current) return;

    // Only auto-scroll if user is near bottom
    if (isNearBottom()) {
      lastMessageRef.current.scrollIntoView({
        behavior: 'smooth',
        block: 'end',
      });
    }
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages.length]); // Trigger on new message

  return (
    <div ref={listRef} className="overflow-y-auto scroll-smooth">
      {messages.map((msg, index) => (
        <div
          key={msg.id}
          ref={index === messages.length - 1 ? lastMessageRef : null}
        >
          <MessageBubble message={msg} />
        </div>
      ))}
    </div>
  );
}
```

**CSS Enhancement:**
```css
/* globals.css - add to existing */
.scroll-smooth {
  scroll-behavior: smooth;
}
```

### Typing Indicator Bouncing Dots
**[Source: Epic 5 spec, Story 2.5]**

```tsx
// components/chat/typing-indicator.tsx
'use client';

import { motion } from 'framer-motion';
import { bounceAnimation } from '@/lib/animations';

export function TypingIndicator({ agent }: Props) {
  return (
    <div className="flex gap-1 items-center">
      <span className="text-sm">{agent} is typing</span>
      <div className="flex gap-1">
        {[0, 1, 2].map((i) => (
          <motion.span
            key={i}
            className="w-2 h-2 bg-primary rounded-full"
            variants={bounceAnimation}
            initial="initial"
            animate="animate"
            transition={{
              delay: i * 0.15, // Stagger each dot by 150ms
            }}
          />
        ))}
      </div>
    </div>
  );
}
```

### GPU Acceleration with will-change
**[Source: Web Performance best practices]**

```css
/* Apply to animated elements */
.message-bubble {
  will-change: transform, opacity;
}

/* Remove after animation completes */
.message-bubble.animation-complete {
  will-change: auto;
}
```

**JavaScript approach:**
```typescript
const element = ref.current;
element.style.willChange = 'transform, opacity';

// After animation (300ms)
setTimeout(() => {
  element.style.willChange = 'auto';
}, 300);
```

**Important:** Don't set will-change on too many elements (causes memory overhead). Apply only during animation.

### Spring Physics Parameters
**[Source: Epic 5 spec, Framer Motion docs]**

```typescript
// Natural, snappy feel (recommended for panels)
{ type: 'spring', stiffness: 300, damping: 30 }

// Softer, more gentle (for cards)
{ type: 'spring', stiffness: 200, damping: 25 }

// Bouncy, playful (for small elements)
{ type: 'spring', stiffness: 400, damping: 20 }
```

**Stiffness:** How quickly animation responds (higher = faster)
**Damping:** How much bounce/oscillation (lower = more bouncy)

### Performance Optimization
**[Source: Epic 5 spec, Performance budgets]**

**Only animate transform and opacity:**
- ✅ `transform: translateY()` - GPU accelerated
- ✅ `opacity` - GPU accelerated
- ❌ `height`, `width` - Triggers layout (slow)
- ❌ `top`, `left` - Triggers layout (slow)
- ❌ `margin`, `padding` - Triggers layout (slow)

**Limit concurrent animations:**
- Maximum 3 animations running simultaneously
- Stagger instead of parallel (100ms delay between)
- Use `AnimatePresence mode="wait"` for sequential exits

**Profile with Chrome DevTools:**
1. Open DevTools → Performance tab
2. Start recording
3. Trigger animation
4. Stop recording
5. Check FPS (should be 60fps, green line)
6. Check for layout thrashing (red marks)

### AnimatePresence for Exit Animations
**[Source: Framer Motion docs]**

```tsx
import { AnimatePresence, motion } from 'framer-motion';

<AnimatePresence mode="popLayout">
  {messages.map((msg) => (
    <motion.div
      key={msg.id}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3 }}
    >
      <MessageBubble message={msg} />
    </motion.div>
  ))}
</AnimatePresence>
```

**Important:**
- Wrap parent container in `AnimatePresence`
- Each child needs unique `key` prop
- Add `exit` variant for smooth removal
- Use `mode="popLayout"` to prevent layout shift

### File Structure
**[Source: architecture/source-tree.md]**

```
orchestratai_client/src/
├── lib/
│   ├── animations.ts                # NEW: Centralized animation variants
│   └── __tests__/
│       └── animations.test.ts       # NEW: Animation config tests
└── components/
    ├── chat/
    │   ├── message-bubble.tsx       # UPDATE: Add fade-slide animation
    │   ├── message-list.tsx         # UPDATE: Add auto-scroll
    │   └── typing-indicator.tsx     # UPDATE: Add bounce animation
    ├── panels/
    │   └── collapsible-panel.tsx    # UPDATE: Spring animation
    └── layout/
        └── three-panel-layout.tsx   # UPDATE: Staggered reveal
```

### Testing

**[Source: architecture/15-testing-strategy.md]**

**Test File Locations:**
- `orchestratai_client/src/lib/__tests__/animations.test.ts` (NEW)
- Update: `orchestratai_client/src/components/chat/__tests__/message-bubble.test.tsx`
- Update: `orchestratai_client/src/components/chat/__tests__/message-list.test.tsx`
- Update: `orchestratai_client/src/components/chat/__tests__/typing-indicator.test.tsx`

**Testing Framework:**
- Vitest for unit tests
- React Testing Library for components
- Mock framer-motion for faster tests (optional)
- Use `jest-axe` for accessibility in animations

**Test Coverage Requirements:**
- Minimum 90% coverage required
- Test animation variants are correct
- Test stagger timing
- Test auto-scroll behavior
- Test typing indicator animation loops

**Example Test Structure:**
```typescript
import { render, screen } from '@testing-library/react';
import { MessageBubble } from '../message-bubble';

// Mock framer-motion to avoid animation delays in tests
jest.mock('framer-motion', () => ({
  motion: {
    div: ({ children, ...props }: any) => <div {...props}>{children}</div>,
  },
  AnimatePresence: ({ children }: any) => <>{children}</>,
}));

describe('MessageBubble animations', () => {
  it('renders with motion.div wrapper', () => {
    render(<MessageBubble message={mockMessage} />);
    expect(screen.getByText(mockMessage.content)).toBeInTheDocument();
  });

  it('applies fadeSlideUp variant', () => {
    const { container } = render(<MessageBubble message={mockMessage} />);
    // Verify animation props are applied
    // Note: Actual animation testing requires visual regression tests
  });
});
```

**Performance Testing:**
```typescript
describe('Animation performance', () => {
  it('maintains 60fps during message animation', () => {
    // Use Chrome DevTools Puppeteer for automated FPS testing
    // Or manual testing with Performance tab
  });

  it('limits concurrent animations to 3', () => {
    // Render multiple messages simultaneously
    // Verify stagger ensures max 3 animating at once
  });
});
```

### Browser Compatibility
**[Source: Can I Use, Epic 5 spec]**

- Framer Motion: All modern browsers (Chrome 90+, Firefox 88+, Safari 14+)
- CSS `scroll-behavior: smooth`: 94% support (fallback: instant scroll, still works)
- `will-change`: 97% support
- `scrollIntoView`: 100% support

### Cumulative Layout Shift (CLS)
**[Source: Web Vitals, Epic 5 acceptance criteria]**

- Target: CLS < 0.1
- Prevent layout shift by:
  - Reserve space for animated elements
  - Use `transform` instead of `top/left`
  - Set explicit dimensions on containers
  - Use `AnimatePresence mode="popLayout"`

**Measure CLS:**
```typescript
// Use web-vitals library
import { getCLS } from 'web-vitals';

getCLS(console.log); // Log CLS score
```

### Design Token Integration
**[Source: Story 1.2, Epic 1]**

```typescript
// Use design tokens for animation values
export const fadeSlideUp: Variants = {
  transition: {
    duration: 0.3,
    // Could use: var(--transition-fast) from design tokens
    // But Framer Motion needs numeric values, so keep hardcoded
  },
};
```

**Shadow for cardHover:**
```typescript
export const cardHover: Variants = {
  hover: {
    boxShadow: 'var(--shadow-lg)', // Use design token
    // Or: '0 10px 30px rgba(0, 0, 0, 0.3)'
  },
};
```

### Accessibility Considerations
**[Source: WCAG 2.1, prefers-reduced-motion]**

- Animations should not interfere with screen readers
- Don't rely solely on animation to convey information
- Provide alternative feedback (text, ARIA announcements)
- Story 5.3 will handle `prefers-reduced-motion` (disable animations)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
