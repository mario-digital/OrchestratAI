# <!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** power user,
**I want** keyboard shortcuts for common actions,
**so that** I can navigate and use the application efficiently without relying on mouse clicks

## Acceptance Criteria
1. `Ctrl+/` (or `Cmd+/` on Mac) opens keyboard shortcuts help modal
2. `Ctrl+K` (or `Cmd+K`) focuses the message input field
3. `Ctrl+L` (or `Cmd+L`) clears chat history (with confirmation)
4. `Esc` clears message input OR closes open modal
5. `Enter` sends message (already implemented in Story 2.6)
6. `Shift+Enter` adds new line in message (already implemented)
7. `Ctrl+1`, `Ctrl+2`, `Ctrl+3` toggle panels on desktop
8. Arrow keys navigate tabs on mobile (`←` previous, `→` next)
9. Help modal displays all shortcuts in organized table
10. Shortcuts work on both Mac (Cmd) and Windows/Linux (Ctrl)
11. Shortcuts don't interfere with browser defaults
12. All shortcuts have visual indicators (tooltips showing shortcut key)

## Tasks / Subtasks

- [ ] Task 1: Create keyboard shortcuts hook (AC: 1, 2, 3, 4, 10, 11)
  - [ ] Create `hooks/use-keyboard-shortcuts.ts` file
  - [ ] Detect platform (Mac vs Windows/Linux): `navigator.platform`
  - [ ] Create event listener for keydown events
  - [ ] Check modifier key: `e.metaKey` (Mac) or `e.ctrlKey` (Win/Linux)
  - [ ] Implement `Ctrl+/`: Open help modal
  - [ ] Implement `Ctrl+K`: Focus input field
  - [ ] Implement `Ctrl+L`: Clear history (with confirmation dialog)
  - [ ] Implement `Esc`: Clear input or close modal
  - [ ] Prevent default browser behavior: `e.preventDefault()`
  - [ ] Add cleanup on unmount
  - [ ] Write tests for each shortcut

- [ ] Task 2: Create panel toggle shortcuts (desktop only) (AC: 7)
  - [ ] In useKeyboardShortcuts hook, add `Ctrl+1/2/3` handlers
  - [ ] `Ctrl+1`: Focus/scroll to chat panel
  - [ ] `Ctrl+2`: Toggle agent panel collapsed state
  - [ ] `Ctrl+3`: Toggle log panel collapsed state
  - [ ] Only activate on desktop (≥1024px width)
  - [ ] Use useMobile hook from Story 4.1 to check viewport
  - [ ] Provide visual feedback when panel toggles
  - [ ] Write tests for panel shortcuts

- [ ] Task 3: Implement mobile tab navigation shortcuts (AC: 8)
  - [ ] In TabNavigation component from Story 4.1, add arrow key handling
  - [ ] Listen for `ArrowLeft` and `ArrowRight` keys
  - [ ] `ArrowLeft`: Switch to previous tab (if not first)
  - [ ] `ArrowRight`: Switch to next tab (if not last)
  - [ ] Only activate on mobile (<768px width)
  - [ ] Update active tab state on key press
  - [ ] Provide visual focus indicator on active tab
  - [ ] Write tests for arrow key navigation

- [ ] Task 4: Create shortcuts help modal (AC: 9, 12)
  - [ ] Install shadcn Dialog if not installed: `bunx shadcn@latest add dialog`
  - [ ] Create `components/modals/shortcuts-help.tsx` file
  - [ ] Define SHORTCUTS constant with all shortcuts
  - [ ] Group shortcuts by category (General, Navigation, Panel Controls)
  - [ ] Display shortcuts in table format (Key Combination | Description)
  - [ ] Show platform-specific keys (⌘ for Mac, Ctrl for Windows)
  - [ ] Add close button and Esc to close
  - [ ] Style with design tokens
  - [ ] Write tests for modal rendering

- [ ] Task 5: Add shortcut detection utility (AC: 10)
  - [ ] Create `lib/utils/keyboard.ts` file
  - [ ] Implement `isMac()` function: Check `navigator.platform`
  - [ ] Implement `getModifierKey()`: Returns 'Cmd' or 'Ctrl'
  - [ ] Implement `formatShortcut(keys: string[])`: Format for display
  - [ ] Implement `matchesShortcut(event, keys)`: Check if event matches
  - [ ] Export utilities for reuse
  - [ ] Write tests for utilities

- [ ] Task 6: Integrate shortcuts into ChatProvider (AC: 2, 3, 4)
  - [ ] Import useKeyboardShortcuts in ChatProvider
  - [ ] Pass callback functions from ChatProvider:
    - `clearHistory` (existing method)
    - `focusInput` (new method, uses ref)
    - `openHelpModal` (new state: showHelpModal)
  - [ ] Add inputRef to ChatProvider for focus management
  - [ ] Expose inputRef through context
  - [ ] Update ChatInterface to use inputRef
  - [ ] Write tests for shortcuts integration

- [ ] Task 7: Add input focus management (AC: 2)
  - [ ] Create ref for input: `const inputRef = useRef<HTMLTextAreaElement>(null)`
  - [ ] Pass ref to Textarea component in InputArea
  - [ ] Implement focusInput function: `inputRef.current?.focus()`
  - [ ] Export inputRef from ChatProvider context
  - [ ] Test focus works with `Ctrl+K`

- [ ] Task 8: Add clear history confirmation (AC: 3)
  - [ ] Install shadcn AlertDialog if needed: `bunx shadcn@latest add alert-dialog`
  - [ ] Create confirmation dialog for clear history
  - [ ] Show dialog when `Ctrl+L` pressed
  - [ ] Buttons: "Cancel" and "Clear History"
  - [ ] Call clearMessages only if confirmed
  - [ ] Test confirmation flow

- [ ] Task 9: Add keyboard shortcut tooltips (AC: 12)
  - [ ] Install shadcn Tooltip if needed: `bunx shadcn@latest add tooltip`
  - [ ] Add tooltip to Send button: "Enter to send, Shift+Enter for new line"
  - [ ] Add tooltip to Clear History button: `Ctrl+L`
  - [ ] Add tooltip to panel collapse buttons: `Ctrl+2` / `Ctrl+3`
  - [ ] Show platform-specific shortcuts (Cmd vs Ctrl)
  - [ ] Style tooltips with design tokens
  - [ ] Write tests for tooltips

- [ ] Task 10: Prevent default browser shortcuts (AC: 11)
  - [ ] In keydown handler, call `e.preventDefault()` for app shortcuts
  - [ ] Don't prevent: `Ctrl+R` (reload), `Ctrl+W` (close tab), `Ctrl+T` (new tab)
  - [ ] Don't prevent: `Ctrl+C`, `Ctrl+V`, `Ctrl+X` (copy/paste/cut)
  - [ ] Allow: `Ctrl+F` (find), `Ctrl+P` (print) to work normally
  - [ ] Test shortcuts don't break browser functionality
  - [ ] Document which shortcuts are safe to use

- [ ] Task 11: Add visual feedback for shortcuts (AC: 12)
  - [ ] Show toast when shortcut action performed:
    - "Chat history cleared" (Ctrl+L)
    - "Focus on input" (Ctrl+K) - subtle
  - [ ] Highlight panel briefly when toggled via shortcut
  - [ ] Add ripple effect or flash animation
  - [ ] Don't show feedback for every shortcut (avoid spam)
  - [ ] Write tests for visual feedback

- [ ] Task 12: Write comprehensive tests (AC: All)
  - [ ] Test Ctrl+/ opens help modal
  - [ ] Test Cmd+/ on Mac (mock navigator.platform)
  - [ ] Test Ctrl+K focuses input
  - [ ] Test Ctrl+L clears history with confirmation
  - [ ] Test Esc closes modal and clears input
  - [ ] Test Ctrl+1/2/3 toggle panels (desktop only)
  - [ ] Test Arrow keys navigate tabs (mobile only)
  - [ ] Test shortcuts don't fire when typing in input
  - [ ] Test platform detection (Mac vs Windows)
  - [ ] Achieve 90%+ coverage

## Dev Notes

### Previous Story Context
From Story 2.6 (Message Input Area):
- Textarea component accepts Enter and Shift+Enter
- Send button triggers message send
- Input validation already implemented

From Story 4.1 (Tab Navigation):
- TabNavigation component with mobile tabs
- Tab switching via click implemented
- Arrow key navigation needs to be added

From Story 1.8 (Collapsible Panel):
- Panels can be collapsed/expanded via button
- Need keyboard shortcut integration

### Keyboard Event Handling
**[Source: Epic 5 spec, Web APIs]**

```typescript
// hooks/use-keyboard-shortcuts.ts
'use client';

import { useEffect, useState } from 'react';
import { isMac } from '@/lib/utils/keyboard';

interface ShortcutCallbacks {
  onOpenHelp: () => void;
  onFocusInput: () => void;
  onClearHistory: () => void;
  onToggleAgentPanel?: () => void;
  onToggleLogPanel?: () => void;
}

export function useKeyboardShortcuts(callbacks: ShortcutCallbacks) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      const modifier = isMac() ? e.metaKey : e.ctrlKey;

      // Don't trigger shortcuts when typing in input/textarea
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
        // Allow Esc to clear input
        if (e.key === 'Escape') {
          target.blur();
          (target as HTMLInputElement).value = '';
        }
        return;
      }

      // Ctrl+/ or Cmd+/: Open help
      if (modifier && e.key === '/') {
        e.preventDefault();
        callbacks.onOpenHelp();
      }

      // Ctrl+K or Cmd+K: Focus input
      else if (modifier && e.key === 'k') {
        e.preventDefault();
        callbacks.onFocusInput();
      }

      // Ctrl+L or Cmd+L: Clear history
      else if (modifier && e.key === 'l') {
        e.preventDefault();
        callbacks.onClearHistory();
      }

      // Ctrl+1/2/3: Toggle panels (desktop only)
      else if (modifier && ['1', '2', '3'].includes(e.key)) {
        e.preventDefault();
        if (e.key === '2') callbacks.onToggleAgentPanel?.();
        if (e.key === '3') callbacks.onToggleLogPanel?.();
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [callbacks]);
}
```

### Platform Detection Utility
**[Source: Epic 5 spec]**

```typescript
// lib/utils/keyboard.ts

/**
 * Check if running on Mac
 */
export function isMac(): boolean {
  if (typeof window === 'undefined') return false;
  return navigator.platform.toUpperCase().indexOf('MAC') >= 0;
}

/**
 * Get modifier key name for current platform
 */
export function getModifierKey(): 'Cmd' | 'Ctrl' {
  return isMac() ? 'Cmd' : 'Ctrl';
}

/**
 * Format keyboard shortcut for display
 * Example: formatShortcut(['Ctrl', 'K']) => "Ctrl+K" or "⌘K" on Mac
 */
export function formatShortcut(keys: string[]): string {
  const modKey = getModifierKey();

  return keys
    .map((key) => {
      if (key === 'Ctrl') return isMac() ? '⌘' : 'Ctrl';
      if (key === 'Shift') return '⇧';
      if (key === 'Alt') return isMac() ? '⌥' : 'Alt';
      return key.toUpperCase();
    })
    .join(isMac() ? '' : '+');
}

/**
 * Check if keyboard event matches shortcut
 */
export function matchesShortcut(
  event: KeyboardEvent,
  keys: { key: string; modifier?: boolean; shift?: boolean }
): boolean {
  const modifier = isMac() ? event.metaKey : event.ctrlKey;

  if (keys.modifier && !modifier) return false;
  if (keys.shift && !event.shiftKey) return false;
  if (event.key.toLowerCase() !== keys.key.toLowerCase()) return false;

  return true;
}
```

### Shortcuts Help Modal
**[Source: Epic 5 spec, shadcn Dialog]**

```tsx
// components/modals/shortcuts-help.tsx
'use client';

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { formatShortcut } from '@/lib/utils/keyboard';

interface ShortcutsHelpProps {
  isOpen: boolean;
  onClose: () => void;
}

const SHORTCUTS = [
  {
    category: 'General',
    shortcuts: [
      { keys: ['Ctrl', '/'], description: 'Show this help' },
      { keys: ['Enter'], description: 'Send message' },
      { keys: ['Shift', 'Enter'], description: 'New line in message' },
      { keys: ['Esc'], description: 'Clear input / Close modal' },
    ],
  },
  {
    category: 'Navigation',
    shortcuts: [
      { keys: ['Ctrl', 'K'], description: 'Focus message input' },
      { keys: ['Ctrl', 'L'], description: 'Clear chat history' },
      { keys: ['→'], description: 'Next tab (mobile)' },
      { keys: ['←'], description: 'Previous tab (mobile)' },
    ],
  },
  {
    category: 'Panel Controls (Desktop)',
    shortcuts: [
      { keys: ['Ctrl', '1'], description: 'Focus chat panel' },
      { keys: ['Ctrl', '2'], description: 'Toggle agent panel' },
      { keys: ['Ctrl', '3'], description: 'Toggle log panel' },
    ],
  },
];

export function ShortcutsHelp({ isOpen, onClose }: ShortcutsHelpProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Keyboard Shortcuts</DialogTitle>
        </DialogHeader>

        <div className="space-y-6 mt-4">
          {SHORTCUTS.map((group) => (
            <div key={group.category}>
              <h3 className="text-sm font-semibold mb-2">{group.category}</h3>
              <table className="w-full">
                <tbody>
                  {group.shortcuts.map((shortcut, i) => (
                    <tr key={i} className="border-b last:border-0">
                      <td className="py-2 pr-4">
                        <kbd className="px-2 py-1 bg-muted rounded text-sm font-mono">
                          {formatShortcut(shortcut.keys)}
                        </kbd>
                      </td>
                      <td className="py-2 text-sm">{shortcut.description}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ))}
        </div>

        <div className="mt-4 text-xs text-muted-foreground">
          Press <kbd className="px-1 py-0.5 bg-muted rounded">Esc</kbd> to close
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### Clear History Confirmation Dialog
**[Source: shadcn AlertDialog]**

```tsx
// components/modals/clear-history-dialog.tsx
'use client';

import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';

interface ClearHistoryDialogProps {
  isOpen: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export function ClearHistoryDialog({
  isOpen,
  onConfirm,
  onCancel,
}: ClearHistoryDialogProps) {
  return (
    <AlertDialog open={isOpen} onOpenChange={onCancel}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Clear Chat History?</AlertDialogTitle>
          <AlertDialogDescription>
            This will permanently delete all messages in this conversation. This
            action cannot be undone.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction onClick={onConfirm}>
            Clear History
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

### ChatProvider Integration
**[Source: Story 2.7, Epic 5 spec]**

```typescript
// components/providers/chat-provider.tsx
'use client';

import { useRef, useState } from 'react';
import { useKeyboardShortcuts } from '@/hooks/use-keyboard-shortcuts';

export function ChatProvider({ children }: Props) {
  const [state, dispatch] = useReducer(chatReducer, initialState);
  const [showHelpModal, setShowHelpModal] = useState(false);
  const [showClearConfirm, setShowClearConfirm] = useState(false);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  // Keyboard shortcuts
  useKeyboardShortcuts({
    onOpenHelp: () => setShowHelpModal(true),
    onFocusInput: () => inputRef.current?.focus(),
    onClearHistory: () => setShowClearConfirm(true),
    onToggleAgentPanel: () => {
      // Toggle agent panel state
    },
    onToggleLogPanel: () => {
      // Toggle log panel state
    },
  });

  const handleClearConfirmed = () => {
    dispatch({ type: 'CLEAR_MESSAGES' });
    setShowClearConfirm(false);
    toast.success('Chat history cleared');
  };

  return (
    <ChatContext.Provider value={{ ...state, inputRef }}>
      {children}

      <ShortcutsHelp
        isOpen={showHelpModal}
        onClose={() => setShowHelpModal(false)}
      />

      <ClearHistoryDialog
        isOpen={showClearConfirm}
        onConfirm={handleClearConfirmed}
        onCancel={() => setShowClearConfirm(false)}
      />
    </ChatContext.Provider>
  );
}
```

### Arrow Key Navigation for Mobile Tabs
**[Source: Story 4.1, Epic 5 spec]**

```tsx
// components/mobile/tab-navigation.tsx
'use client';

import { useEffect } from 'react';

export function TabNavigation({ activeTab, onTabChange, tabs }: Props) {
  useEffect(() => {
    const handleArrowKey = (e: KeyboardEvent) => {
      if (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;

      const currentIndex = tabs.findIndex((tab) => tab.id === activeTab);

      if (e.key === 'ArrowLeft' && currentIndex > 0) {
        e.preventDefault();
        onTabChange(tabs[currentIndex - 1].id);
      } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
        e.preventDefault();
        onTabChange(tabs[currentIndex + 1].id);
      }
    };

    document.addEventListener('keydown', handleArrowKey);
    return () => document.removeEventListener('keydown', handleArrowKey);
  }, [activeTab, tabs, onTabChange]);

  return (/* existing tab navigation UI */);
}
```

### Tooltips with Shortcuts
**[Source: shadcn Tooltip]**

```tsx
// Example: Send button with tooltip
import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip';
import { formatShortcut } from '@/lib/utils/keyboard';

<Tooltip>
  <TooltipTrigger asChild>
    <Button onClick={handleSend}>Send</Button>
  </TooltipTrigger>
  <TooltipContent>
    <p>Send message</p>
    <kbd className="text-xs">{formatShortcut(['Enter'])}</kbd>
  </TooltipContent>
</Tooltip>
```

### File Structure
**[Source: architecture/source-tree.md]**

```
orchestratai_client/src/
├── hooks/
│   ├── use-keyboard-shortcuts.ts    # NEW
│   └── __tests__/
│       └── use-keyboard-shortcuts.test.ts  # NEW
├── lib/utils/
│   ├── keyboard.ts                  # NEW
│   └── __tests__/
│       └── keyboard.test.ts         # NEW
├── components/
│   ├── modals/                      # NEW directory
│   │   ├── shortcuts-help.tsx
│   │   ├── clear-history-dialog.tsx
│   │   └── __tests__/
│   │       ├── shortcuts-help.test.tsx
│   │       └── clear-history-dialog.test.tsx
│   ├── providers/
│   │   └── chat-provider.tsx        # UPDATE: Add shortcuts
│   └── mobile/
│       └── tab-navigation.tsx       # UPDATE: Add arrow keys
```

### shadcn Components to Install
**[Source: Epic 5 spec]**

```bash
# If not already installed
bunx shadcn@latest add dialog
bunx shadcn@latest add alert-dialog
bunx shadcn@latest add tooltip
```

### Testing

**[Source: architecture/15-testing-strategy.md]**

**Test File Locations:**
- `orchestratai_client/src/hooks/__tests__/use-keyboard-shortcuts.test.ts` (NEW)
- `orchestratai_client/src/lib/utils/__tests__/keyboard.test.ts` (NEW)
- `orchestratai_client/src/components/modals/__tests__/shortcuts-help.test.tsx` (NEW)

**Testing Framework:**
- Vitest for unit tests
- React Testing Library for components
- Mock keyboard events with `fireEvent.keyDown`
- Mock navigator.platform for Mac testing

**Test Coverage Requirements:**
- Minimum 90% coverage required
- Test all shortcut combinations
- Test platform detection (Mac vs Windows)
- Test modal open/close
- Test confirmation dialogs
- Test arrow key navigation

**Example Test Structure:**
```typescript
import { renderHook } from '@testing-library/react';
import { fireEvent } from '@testing-library/react';
import { useKeyboardShortcuts } from '../use-keyboard-shortcuts';

describe('useKeyboardShortcuts', () => {
  const mockCallbacks = {
    onOpenHelp: jest.fn(),
    onFocusInput: jest.fn(),
    onClearHistory: jest.fn(),
  };

  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('opens help on Ctrl+/', () => {
    renderHook(() => useKeyboardShortcuts(mockCallbacks));

    fireEvent.keyDown(document, {
      key: '/',
      ctrlKey: true,
    });

    expect(mockCallbacks.onOpenHelp).toHaveBeenCalled();
  });

  it('focuses input on Ctrl+K', () => {
    renderHook(() => useKeyboardShortcuts(mockCallbacks));

    fireEvent.keyDown(document, {
      key: 'k',
      ctrlKey: true,
    });

    expect(mockCallbacks.onFocusInput).toHaveBeenCalled();
  });

  it('uses Cmd on Mac', () => {
    // Mock Mac platform
    Object.defineProperty(navigator, 'platform', {
      value: 'MacIntel',
      writable: true,
    });

    renderHook(() => useKeyboardShortcuts(mockCallbacks));

    fireEvent.keyDown(document, {
      key: '/',
      metaKey: true, // Cmd key
    });

    expect(mockCallbacks.onOpenHelp).toHaveBeenCalled();
  });

  it('does not trigger when typing in input', () => {
    renderHook(() => useKeyboardShortcuts(mockCallbacks));

    const input = document.createElement('input');
    document.body.appendChild(input);

    fireEvent.keyDown(input, {
      key: 'k',
      ctrlKey: true,
    });

    expect(mockCallbacks.onFocusInput).not.toHaveBeenCalled();
  });
});
```

### Accessibility Considerations
**[Source: WCAG 2.1, Keyboard Accessibility]**

- All shortcuts should be documented and discoverable (help modal)
- Shortcuts should not conflict with screen reader shortcuts
- Provide alternative ways to perform actions (buttons + shortcuts)
- Focus indicators visible when navigating with keyboard
- Modal trap focus (Tab cycles through modal elements only)

### Browser Compatibility
**[Source: Can I Use]**

- Keyboard events: 100% support all modern browsers
- `metaKey` (Cmd): 100% support
- `navigator.platform`: 100% support (deprecated but widely supported)
- Alternative: Use `navigator.userAgentData.platform` (newer API)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
