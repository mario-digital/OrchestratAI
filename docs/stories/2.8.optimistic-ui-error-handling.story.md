# Story 2.8: Optimistic UI Updates and Error Handling

## Status
Draft

## Story
**As a** user,
**I want** my messages to appear immediately when I send them and see clear error notifications if something goes wrong,
**so that** the chat interface feels responsive and I'm informed of any issues without losing my messages.

## Acceptance Criteria
1. User messages appear instantly in chat (optimistic update)
2. Typing indicator displays while waiting for AI response
3. AI response appears after backend responds
4. Failed messages are removed from chat on error
5. Error toast notifications display for network/API failures
6. Error messages are user-friendly (no technical jargon)
7. Retry mechanism available for failed messages
8. Chat interface assembles all components into complete UI
9. Chat interface integrates with ChatProvider
10. End-to-end manual testing passes all user flows

## Tasks / Subtasks

- [ ] Update ChatProvider with optimistic updates (AC: 1, 4)
  - [ ] Modify sendMessage to add user message BEFORE API call
  - [ ] Generate temporary message ID for user message
  - [ ] Store message ID to remove on error
  - [ ] On API error: remove optimistic user message from state
  - [ ] Add new reducer action: REMOVE_MESSAGE with message ID
  - [ ] Update reducer to handle REMOVE_MESSAGE action

- [ ] Add typing indicator state to ChatProvider (AC: 2, 3)
  - [ ] Add typingAgent field to ChatState: `typingAgent: AgentId | null`
  - [ ] Add SET_TYPING_AGENT action to reducer
  - [ ] Dispatch SET_TYPING_AGENT(agentId) when API call starts
  - [ ] Dispatch SET_TYPING_AGENT(null) when response received or error
  - [ ] Expose typingAgent in ChatContextValue

- [ ] Create error toast notification system (AC: 5, 6)
  - [ ] Install or use shadcn/ui Toast/Sonner component
  - [ ] Create error message mapping utility in `lib/utils/error-messages.ts`
  - [ ] Map APIError status codes to user-friendly messages
  - [ ] Map NetworkError to "Unable to connect. Please check your connection."
  - [ ] Map TimeoutError to "Request timed out. Please try again."
  - [ ] Map ValidationError to "Invalid message format. Please try again."
  - [ ] Display toast when error occurs in ChatProvider

- [ ] Implement retry mechanism (AC: 7)
  - [ ] Add retryMessage(messageId) method to ChatProvider
  - [ ] Store failed message content in error state
  - [ ] On retry: clear error, call sendMessage with stored content
  - [ ] Add retry button to error toast notification
  - [ ] Clear failed message state after successful retry

- [ ] Create main ChatInterface component (AC: 8, 9)
  - [ ] Create `components/chat/chat-interface.tsx`
  - [ ] Add 'use client' directive
  - [ ] Import MessageList, InputArea, TypingIndicator components
  - [ ] Use useChatContext hook to access state and methods
  - [ ] Render MessageList with messages from context
  - [ ] Conditionally render TypingIndicator when typingAgent is set
  - [ ] Render InputArea with onSendMessage and isProcessing props
  - [ ] Add error display area (or rely on toasts)
  - [ ] Use design tokens for layout spacing

- [ ] Integrate ChatInterface in main page (AC: 9)
  - [ ] Wrap app/page.tsx with ChatProvider
  - [ ] Place ChatInterface in center panel of ThreePanelLayout (from Epic 1)
  - [ ] Ensure ChatProvider is above ChatInterface in component tree

- [ ] Add error boundary for chat section (AC: 5)
  - [ ] Create error boundary component for graceful error handling
  - [ ] Wrap ChatInterface with error boundary
  - [ ] Display fallback UI on critical errors
  - [ ] Log errors to console in development

- [ ] Create user-friendly error messages (AC: 6)
  - [ ] NetworkError: "Couldn't reach the server. Check your connection and try again."
  - [ ] TimeoutError: "The request took too long. Please try again."
  - [ ] APIError 400: "Your message couldn't be processed. Please try again."
  - [ ] APIError 500: "Something went wrong on our end. Please try again."
  - [ ] ValidationError: "Your message format is invalid. Please try again."
  - [ ] Generic error: "An unexpected error occurred. Please try again."

- [ ] Write integration tests (AC: 10)
  - [ ] Test full flow: type message ‚Üí send ‚Üí see optimistic update ‚Üí see response
  - [ ] Test error flow: send ‚Üí API fails ‚Üí see error toast ‚Üí message removed
  - [ ] Test retry flow: failed message ‚Üí click retry ‚Üí success
  - [ ] Test typing indicator appears during API call
  - [ ] Test typing indicator disappears after response
  - [ ] Mock API with success/error responses

- [ ] Manual end-to-end testing (AC: 10)
  - [ ] Test happy path: send message, receive response
  - [ ] Test billing keyword routing: "What are your prices?"
  - [ ] Test technical keyword routing: "I'm getting an error"
  - [ ] Test policy keyword routing: "What's your refund policy?"
  - [ ] Test network error: disconnect network, send message
  - [ ] Test backend error: stop backend, send message
  - [ ] Test retry after network error
  - [ ] Test multiple messages in sequence
  - [ ] Test panel collapse doesn't affect chat state
  - [ ] Test page refresh loses messages but keeps sessionId

## Dev Notes

### üö® CRITICAL: 3-Tier CSS Design Token System Requirements

**This story REQUIRES strict adherence to the 3-tier CSS design token system. Violations will result in PR rejection.**

[Source: docs/ux-design-tokens/css-tokens-usage.md, docs/ux-design-tokens/component-styling-guide.md]

#### Token System Architecture:
```
Layer 3: Component Tokens (--color-panel-bg) ‚Üê USE THESE FIRST
    ‚Üì references
Layer 2: Semantic Tokens (--color-bg-primary) ‚Üê FALLBACK ONLY
    ‚Üì references
Layer 1: Primitive Tokens (--token-color-slate-900) ‚Üê NEVER USE DIRECTLY
```

#### MANDATORY RULES:
1. **NEVER use Layer 1 primitive tokens** (`--token-color-*`) directly in components
2. **NEVER create new tokens without explicit approval** - Ask user first with clear justification
3. **ALWAYS use Component Tokens (Layer 3) first** - Only fall back to Semantic (Layer 2) if component token doesn't exist
4. **Use Tailwind opacity syntax** for transparency: `bg-panel-bg/90` (NEVER bake opacity into tokens)
5. **Use approved Tailwind utilities**: `bg-panel-bg`, `border-panel-border`, `text-error`

#### Available Component Tokens for Chat Interface:
```css
/* Panel Containers */
--color-panel-bg: #0f172a (Slate 900)
--color-panel-border: #374151 (Gray 700)

/* Status/Error Colors */
--color-error: #ef4444 (Red 500)
--color-warning: #f59e0b (Yellow 500)
--color-success: #22c55e (Green 500)

/* Text Colors */
--color-text-primary: #f9fafb (Gray 50)
--color-text-secondary: #d1d5db (Gray 300)
--color-text-muted: #4b5563 (Gray 600)

/* Spacing */
--space-2: 8px
--space-4: 16px
--space-6: 24px
```

#### Correct vs Incorrect Usage:
```tsx
// ‚úÖ CORRECT: Use Component Token
<div className="bg-panel-bg border-panel-border">

// ‚úÖ CORRECT: Use Semantic Token for error
<div className="text-error">

// ‚ùå WRONG: Primitive token
<div className="bg-[var(--token-color-slate-900)]">

// ‚ùå WRONG: Arbitrary hex value
<div className="bg-[#0f172a]">

// ‚ùå WRONG: Direct Tailwind color
<div className="bg-slate-900">
```

#### If You Need a New Token:
**STOP and ask the user for approval with this format:**
```
"I need to create a new token for [purpose]:
- Proposed name: --color-[category]-[usage]
- Proposed value: references var(--token-color-[primitive])
- Justification: [why existing tokens cannot be used]
- Can we get designer approval to add this token?"
```

**DO NOT proceed without user approval. Check if opacity modifiers can solve the need first.**

---

### Previous Story Context
- Story 2.7 created ChatProvider with sendMessage, messages, isProcessing state
- Story 2.6 created InputArea component
- Story 2.5 created MessageBubble, MessageList, TypingIndicator components
- Story 2.3 created custom error classes (APIError, NetworkError, etc.)

### Optimistic UI Pattern
[Source: docs/stories/epic-2-chat-interface.md#lines-281-317]

**Optimistic Update Flow:**
```typescript
async function sendMessage(content: string) {
  // 1. Optimistic update: add user message immediately
  const userMessage = { role: 'user', content, id: crypto.randomUUID() };
  dispatch({ type: 'ADD_MESSAGE', payload: userMessage });

  // 2. Set processing state
  dispatch({ type: 'SET_PROCESSING', payload: true });
  dispatch({ type: 'SET_TYPING_AGENT', payload: 'orchestrator' }); // Or predicted agent

  try {
    // 3. Call backend API
    const response = await chatAPI.sendMessage(content, sessionId);

    // 4. Add AI response
    const aiMessage = {
      role: 'assistant',
      content: response.message,
      agent: response.agent,
      confidence: response.confidence,
      id: crypto.randomUUID()
    };
    dispatch({ type: 'ADD_MESSAGE', payload: aiMessage });

  } catch (error) {
    // 5. Remove optimistic message on error
    dispatch({ type: 'REMOVE_MESSAGE', payload: userMessage.id });
    dispatch({ type: 'SET_ERROR', payload: error });
    showErrorToast(error);
  } finally {
    dispatch({ type: 'SET_PROCESSING', payload: false });
    dispatch({ type: 'SET_TYPING_AGENT', payload: null });
  }
}
```

### Error Handling Strategy
[Source: docs/architecture/17-error-handling-strategy.md#172-frontend-error-handling]

**Error Display:**
- Network errors: "Unable to connect to server. Please try again."
- Validation errors: "Invalid message format. Please try again."
- Server errors (500): "An error occurred. Our team has been notified."
- Timeout: "Request timed out. Please try again."

**Error Toast Pattern:**
```tsx
import { toast } from 'sonner'; // or shadcn toast

function showErrorToast(error: Error) {
  const message = getUserFriendlyMessage(error);

  toast.error(message, {
    action: {
      label: 'Retry',
      onClick: () => retryLastMessage(),
    },
  });
}

function getUserFriendlyMessage(error: Error): string {
  if (error instanceof NetworkError) {
    return "Couldn't reach the server. Check your connection and try again.";
  }
  if (error instanceof TimeoutError) {
    return "The request took too long. Please try again.";
  }
  if (error instanceof APIError) {
    if (error.statusCode >= 500) {
      return "Something went wrong on our end. Please try again.";
    }
    return "Your message couldn't be processed. Please try again.";
  }
  return "An unexpected error occurred. Please try again.";
}
```

### Component Integration
[Source: docs/architecture/6-components.md#61-frontend-components]

**ChatInterface Assembly:**
```tsx
'use client';

import { MessageList } from './message-list';
import { InputArea } from './input-area';
import { TypingIndicator } from './typing-indicator';
import { useChatContext } from '../providers/chat-provider';

export function ChatInterface() {
  const { messages, isProcessing, typingAgent, sendMessage, error } = useChatContext();

  return (
    <div className="flex flex-col h-full">
      <MessageList messages={messages} />
      {typingAgent && (
        <TypingIndicator
          agentName={getAgentName(typingAgent)}
          agentId={typingAgent}
        />
      )}
      <InputArea
        onSendMessage={sendMessage}
        isProcessing={isProcessing}
      />
    </div>
  );
}
```

### File Locations
[Source: docs/architecture/9-frontend-architecture.md#91-component-organization]

**Create/modify these files:**
```
orchestratai_client/src/components/
‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îî‚îÄ‚îÄ chat-interface.tsx       # NEW: Main chat orchestrator
‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îî‚îÄ‚îÄ chat-provider.tsx        # MODIFY: Add optimistic updates
‚îî‚îÄ‚îÄ lib/utils/
    ‚îî‚îÄ‚îÄ error-messages.ts         # NEW: Error message mapping
```

**Test files:**
```
orchestratai_client/src/components/chat/__tests__/
‚îî‚îÄ‚îÄ chat-interface.test.tsx
```

### Toast/Notification Library
[Source: docs/architecture/3-tech-stack.md]

Use shadcn/ui Sonner component (Toast):
```bash
bunx shadcn@latest add sonner
```

Or use built-in shadcn toast component.

### Technical Constraints
- React: 19.2
- shadcn/ui: 3.5.0 (Toast/Sonner)
- All components client components due to interactivity

### Coding Standards
[Source: docs/architecture/16-coding-standards.md]

- **Client Components:** All chat components need 'use client'
- **Error Handling:** Never silent failures, always inform user
- **User Experience:** Optimistic updates for perceived performance

### Testing

[Source: docs/architecture/15-testing-strategy.md]

**Test Framework:** Vitest with @testing-library/react
**Test Location:** `orchestratai_client/src/components/chat/__tests__/chat-interface.test.tsx`
**Test Type:** Integration tests (20% of pyramid)

**Test Pattern:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { ChatInterface } from '../chat-interface';
import { ChatProvider } from '../../providers/chat-provider';
import * as chatAPI from '@/lib/api/chat';

vi.mock('@/lib/api/chat');

describe('ChatInterface Integration', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('shows optimistic update then AI response', async () => {
    const user = userEvent.setup();

    const mockResponse = {
      message: 'AI Response',
      agent: 'orchestrator',
      confidence: 0.9,
      logs: [],
      metrics: { tokensUsed: 100, cost: 0.001, latency: 500 },
    };

    vi.mocked(chatAPI.sendMessage).mockResolvedValue(mockResponse);

    render(
      <ChatProvider>
        <ChatInterface />
      </ChatProvider>
    );

    // Type and send message
    const input = screen.getByPlaceholderText('Type your message...');
    await user.type(input, 'Hello');
    await user.click(screen.getByLabelText('Send message'));

    // Optimistic update: user message appears immediately
    expect(screen.getByText('Hello')).toBeInTheDocument();

    // Typing indicator appears
    await waitFor(() => {
      expect(screen.getByText(/is typing/)).toBeInTheDocument();
    });

    // AI response appears
    await waitFor(() => {
      expect(screen.getByText('AI Response')).toBeInTheDocument();
    });
  });

  it('removes optimistic message on error', async () => {
    const user = userEvent.setup();

    vi.mocked(chatAPI.sendMessage).mockRejectedValue(new Error('Network error'));

    render(
      <ChatProvider>
        <ChatInterface />
      </ChatProvider>
    );

    const input = screen.getByPlaceholderText('Type your message...');
    await user.type(input, 'Hello');
    await user.click(screen.getByLabelText('Send message'));

    // Optimistic update appears
    expect(screen.getByText('Hello')).toBeInTheDocument();

    // After error, message is removed
    await waitFor(() => {
      expect(screen.queryByText('Hello')).not.toBeInTheDocument();
    });

    // Error toast appears
    expect(screen.getByText(/error occurred/i)).toBeInTheDocument();
  });
});
```

### Manual Testing Checklist
[Source: docs/stories/epic-2-chat-interface.md#lines-353-375]

1. **Message Sending:**
   - User types "Hello" and clicks Send
   - User message appears instantly with right alignment
   - Typing indicator appears: "Orchestrator is typing..."
   - After 1-2 seconds, AI response appears

2. **Agent Attribution:**
   - Message "What are your pricing tiers?" routes to Billing Agent
   - AI response shows green "Billing Agent" badge
   - Confidence score displays: "95% confident"

3. **Error Handling:**
   - Simulate backend down (stop Docker container)
   - User sends message
   - Error toast appears: "Unable to connect to server"
   - User message is removed

4. **State Persistence:**
   - User sends 3 messages
   - User collapses left panel
   - Message history remains visible and scrollable
   - Page refresh: messages lost, sessionId persists

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

## QA Results
<!-- Populated by QA agent -->
