# Story 3.6: Build Log Entry Components (Query Analysis, Vector Search, Cache)

## Status
Draft

## Story
**As a** user,
**I want** to see detailed retrieval logs showing query analysis, vector search results, and cache operations,
**so that** I can understand how the system processes my requests and retrieves relevant information.

## Acceptance Criteria
1. RetrievalPanel container displays logs in reverse chronological order (newest first)
2. LogEntry component renders with timestamp in HH:MM:SS format
3. QueryAnalysisCard displays intent, confidence score, and target agent
4. VectorSearchCard shows collection name, chunks retrieved count, and latency
5. CacheOperationCard displays hit/miss status and hit rate percentage
6. Log entries have color-coded backgrounds (blue, purple, green, red)
7. Similarity scores display as colored progress bars
8. Document snippets truncate at 200 characters with "..."
9. RetrievalPanel scrolls independently from chat panel
10. Components use design tokens and shadcn/ui primitives

## Tasks / Subtasks

- [ ] Create LogEntry base component (AC: 2, 6)
  - [ ] Create file `orchestratai_client/src/components/panels/log-entry.tsx`
  - [ ] Mark as Client Component
  - [ ] Create LogEntryProps interface:
    ```typescript
    interface LogEntryProps {
      type: "query_analysis" | "vector_search" | "cache_operation" | "error";
      timestamp: Date;
      children: React.ReactNode;
    }
    ```
  - [ ] Format timestamp using `date-fns`: `format(timestamp, "HH:mm:ss")`
  - [ ] Map type to background color:
    - query_analysis ‚Üí "bg-blue-500/10"
    - vector_search ‚Üí "bg-purple-500/10"
    - cache_operation ‚Üí "bg-green-500/10"
    - error ‚Üí "bg-red-500/10"
  - [ ] Render Card with colored background, timestamp, and children

- [ ] Create QueryAnalysisCard component (AC: 3)
  - [ ] Create file `orchestratai_client/src/components/panels/query-analysis-card.tsx`
  - [ ] Create QueryAnalysisCardProps interface matching backend structure
  - [ ] Display intent text with "Detected Intent" label
  - [ ] Display confidence as percentage with progress bar
  - [ ] Display target agent with agent color badge
  - [ ] Show reasoning text in smaller font

- [ ] Create VectorSearchCard component (AC: 4, 7, 8)
  - [ ] Create file `orchestratai_client/src/components/panels/vector-search-card.tsx`
  - [ ] Create VectorSearchCardProps with chunks array
  - [ ] Display collection name and chunks count
  - [ ] Display search latency
  - [ ] Map over chunks and render DocumentPreview for each
  - [ ] DocumentPreview shows: source filename, truncated content, similarity bar

- [ ] Create CacheOperationCard component (AC: 5)
  - [ ] Create file `orchestratai_client/src/components/panels/cache-operation-card.tsx`
  - [ ] Create CacheOperationCardProps interface
  - [ ] Display hit/miss status with colored badge
  - [ ] Display hit rate as percentage with progress bar
  - [ ] Display cache size

- [ ] Create DocumentPreview component (AC: 8, 7)
  - [ ] Create file `orchestratai_client/src/components/panels/document-preview.tsx`
  - [ ] Create DocumentPreviewProps:
    ```typescript
    interface DocumentPreviewProps {
      source: string;
      content: string;
      similarity: number;
      onViewFull: () => void;  // Opens modal in Story 3.7
    }
    ```
  - [ ] Truncate content to 200 chars with `content.slice(0, 200) + "..."`
  - [ ] Render similarity as colored progress bar (shadcn Progress)
  - [ ] Color similarity: >0.8 green, 0.6-0.8 yellow, <0.6 red
  - [ ] Add "View Full" button (triggers onViewFull callback)

- [ ] Create RetrievalPanel container (AC: 1, 9)
  - [ ] Create file `orchestratai_client/src/components/panels/retrieval-panel.tsx`
  - [ ] Mark as Client Component
  - [ ] Use useChatLogs hook to get logs from ChatProvider
  - [ ] Sort logs by timestamp (newest first): `logs.sort((a, b) => b.timestamp - a.timestamp)`
  - [ ] Map over logs and render appropriate card component based on type
  - [ ] Wrap in ScrollArea component for independent scrolling
  - [ ] Add "Retrieval Logs" header

- [ ] Extend ChatProvider with log state (AC: 1)
  - [ ] Open `orchestratai_client/src/components/providers/chat-provider.tsx`
  - [ ] Add `retrievalLogs: RetrievalLog[]` to ChatState
  - [ ] Add actions: ADD_LOG_ENTRY, CLEAR_LOGS
  - [ ] Implement reducer cases
  - [ ] Add `addLogEntry` and `clearLogs` methods
  - [ ] Update sendMessage to add logs from API response

- [ ] Create useChatLogs hook
  - [ ] Create file `orchestratai_client/src/hooks/use-chat-logs.ts`
  - [ ] Export useChatLogs hook to access logs from context

- [ ] Install date-fns for timestamp formatting (AC: 2)
  - [ ] Run `cd orchestratai_client && bun add date-fns`
  - [ ] Import format function: `import { format } from "date-fns"`

- [ ] Install shadcn Progress component (AC: 7)
  - [ ] Run `bunx shadcn@latest add progress`
  - [ ] Use for similarity scores and hit rate display

- [ ] Write unit tests for log components (AC: 2-8)
  - [ ] Test LogEntry renders with correct background color
  - [ ] Test timestamp formats correctly
  - [ ] Test QueryAnalysisCard displays all fields
  - [ ] Test VectorSearchCard renders chunks
  - [ ] Test CacheOperationCard shows hit/miss
  - [ ] Test DocumentPreview truncates content at 200 chars
  - [ ] Test similarity bar colors (green/yellow/red thresholds)

- [ ] Write integration test for RetrievalPanel
  - [ ] Render RetrievalPanel with ChatProvider
  - [ ] Add multiple log entries
  - [ ] Assert logs display in reverse chronological order
  - [ ] Assert correct card type renders for each log type

## Dev Notes

### üö® CRITICAL: 3-Tier CSS Token System - NO ARBITRARY VALUES

**MANDATORY**: This story follows the strict 3-tier CSS token system. See Story 3.3 for complete guidelines.

**Quick Rules**:
1. ‚ùå NEVER use arbitrary colors: `bg-blue-500/10`, `border-l-blue-500`
2. ‚úÖ ALWAYS check if log component tokens exist first
3. üõë HALT if tokens missing - propose new tokens following mobile tabs pattern
4. ‚ùå DO NOT use `bg-blue-500/10`, `bg-purple-500/10`, `bg-green-500/10`, `bg-red-500/10`
5. ‚úÖ CREATE component tokens if approved: `--color-log-query-bg`, `--color-log-vector-bg`, etc.

**MANDATORY: Follow Mobile Tabs 3-Step Pattern** (Story 2.8, globals.css:455-458 + 566-574)

**STEP 1: Add Component Tokens to @theme** (globals.css ~line 456)
```css
/* === Retrieval Log Component Tokens === */
--color-log-entry-query-bg: var(--color-bg-tertiary);
--color-log-entry-query-border: var(--token-color-blue-600);
--color-log-entry-query-text: var(--token-color-blue-400);

--color-log-entry-vector-bg: var(--color-bg-tertiary);
--color-log-entry-vector-border: var(--token-color-purple-600);
--color-log-entry-vector-text: var(--token-color-purple-400);

--color-log-entry-cache-bg: var(--color-bg-tertiary);
--color-log-entry-cache-border: var(--token-color-green-600);
--color-log-entry-cache-text: var(--token-color-green-400);

--color-log-entry-error-bg: var(--color-bg-tertiary);
--color-log-entry-error-border: var(--token-color-red-600);
--color-log-entry-error-text: var(--token-color-red-400);
```

**STEP 2: Add Utility Classes to @layer utilities** (globals.css ~line 566)
```css
/* Retrieval Log Utilities */
.bg-log-query { background-color: var(--color-log-entry-query-bg); }
.border-l-log-query { border-left-color: var(--color-log-entry-query-border); }
.text-log-query { color: var(--color-log-entry-query-text); }

.bg-log-vector { background-color: var(--color-log-entry-vector-bg); }
.border-l-log-vector { border-left-color: var(--color-log-entry-vector-border); }
.text-log-vector { color: var(--color-log-entry-vector-text); }

.bg-log-cache { background-color: var(--color-log-entry-cache-bg); }
.border-l-log-cache { border-left-color: var(--color-log-entry-cache-border); }
.text-log-cache { color: var(--color-log-entry-cache-text); }

.bg-log-error { background-color: var(--color-log-entry-error-bg); }
.border-l-log-error { border-left-color: var(--color-log-entry-error-border); }
.text-log-error { color: var(--color-log-entry-error-text); }
```

**STEP 3: Use Utility Classes in Component**
```tsx
// ‚úÖ CORRECT
<Card className="bg-log-query border-l-4 border-l-log-query">

// ‚ùå WRONG
<Card className="bg-blue-500/10 border-l-blue-500">  // Arbitrary!
```

**Before Implementation**: HALT and ask user: "Log entry color tokens missing. May I add them following mobile tabs pattern (globals.css:455-458 + 566-574)?"

[Full details: Story 3.3 Dev Notes]

### Source Tree Info
[Source: docs/architecture/source-tree.md]
- Components: `orchestratai_client/src/components/panels/`
  - `retrieval-panel.tsx`
  - `log-entry.tsx`
  - `query-analysis-card.tsx`
  - `vector-search-card.tsx`
  - `cache-operation-card.tsx`
  - `document-preview.tsx`
- Hooks: `orchestratai_client/src/hooks/use-chat-logs.ts`

### Retrieval Log Structure
[Source: docs/stories/epic-3-agent-log-panels.md#Right Panel: Retrieval Log]

**Log Entry Types and Colors**:
1. **Query Analysis** (Blue): Intent classification, confidence, routing decision
2. **Vector Search** (Purple): Collection, chunks retrieved, similarity scores, latency
3. **Cache Operations** (Green): Hit/miss status, hit rate, cache size
4. **Errors** (Red): Error messages and details

### Query Analysis Display
```tsx
<Card className="bg-blue-500/10 border-l-4 border-l-blue-500">
  <CardHeader>
    <div className="flex items-center justify-between">
      <h4 className="font-semibold">Query Analysis</h4>
      <span className="text-xs text-text-tertiary">{formatTime(timestamp)}</span>
    </div>
  </CardHeader>
  <CardContent>
    <div className="space-y-2">
      <div>
        <span className="text-sm font-medium">Intent:</span>
        <span className="text-sm ml-2">{intent}</span>
      </div>
      <div>
        <span className="text-sm font-medium">Confidence:</span>
        <Progress value={confidence * 100} className="h-2" />
        <span className="text-xs">{(confidence * 100).toFixed(1)}%</span>
      </div>
      <div>
        <span className="text-sm font-medium">Target Agent:</span>
        <Badge className={agentColorClass}>{targetAgent}</Badge>
      </div>
      <p className="text-xs text-text-tertiary">{reasoning}</p>
    </div>
  </CardContent>
</Card>
```

### Document Snippet Truncation
[Source: docs/stories/epic-3-agent-log-panels.md#Retrieved Documents Preview]

**Requirements**:
- Truncate at 200 characters
- Add "..." if truncated
- Show source file name
- Display similarity score as colored bar
- "View Full" button opens modal (Story 3.7)

**Implementation**:
```typescript
function truncateContent(content: string, maxLength: number = 200): string {
  if (content.length <= maxLength) return content;
  return content.slice(0, maxLength) + "...";
}
```

### Similarity Score Color Mapping
```typescript
function getSimilarityColor(similarity: number): string {
  if (similarity >= 0.8) return "bg-green-500";
  if (similarity >= 0.6) return "bg-yellow-500";
  return "bg-red-500";
}
```

### Timestamp Formatting
[Source: docs/stories/epic-3-agent-log-panels.md#Right Panel]

**Format**: HH:MM:SS (24-hour format)
- Example: "14:23:45"
- Use `date-fns` format function: `format(new Date(timestamp), "HH:mm:ss")`

### RetrievalPanel Layout
```tsx
<div className="flex flex-col h-full">
  <div className="p-4 border-b">
    <h2 className="text-lg font-semibold">Retrieval Logs</h2>
  </div>
  <ScrollArea className="flex-1 p-4">
    <div className="space-y-3">
      {sortedLogs.map((log) => (
        <LogEntry key={log.id} type={log.type} timestamp={new Date(log.timestamp)}>
          {renderLogCard(log)}
        </LogEntry>
      ))}
    </div>
  </ScrollArea>
</div>
```

### ChatProvider Log State Extension
```typescript
interface ChatState {
  // ... existing fields
  retrievalLogs: RetrievalLog[];
}

type ChatAction =
  | // ... existing actions
  | { type: "ADD_LOG_ENTRIES"; payload: RetrievalLog[] }
  | { type: "CLEAR_LOGS" };
```

### Testing
[Source: docs/architecture/15-testing-strategy.md]

**Test Pattern**:
```typescript
describe('DocumentPreview', () => {
  it('truncates content at 200 characters', () => {
    const longContent = "a".repeat(300);
    render(<DocumentPreview content={longContent} source="test.md" similarity={0.9} onViewFull={vi.fn()} />);
    const preview = screen.getByText(/a{200}\.\.\./);
    expect(preview).toBeInTheDocument();
  });

  it('shows green progress bar for high similarity', () => {
    render(<DocumentPreview content="test" source="test.md" similarity={0.9} onViewFull={vi.fn()} />);
    const progressBar = screen.getByRole('progressbar');
    expect(progressBar).toHaveClass('bg-green-500');
  });
});
```

### Integration with Stories
- **Story 3.1-3.2**: Backend provides retrieval logs in response
- **Story 3.7**: DocumentPreview triggers modal via onViewFull callback

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation for Epic 3 | Scrum Master (Bob) |

## Dev Agent Record
<!-- Dev agent fills in during implementation -->

## QA Results
<!-- QA agent fills after validation -->
