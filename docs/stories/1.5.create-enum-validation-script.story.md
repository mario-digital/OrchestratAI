# Story 1.5: Create Enum Synchronization Validation Script

<!-- Powered by BMAD‚Ñ¢ Core -->

## Status

**Draft**

---

## Story

**As a** Developer,
**I want** an automated validation script that ensures TypeScript and Python enums stay perfectly synchronized,
**so that** frontend-backend type mismatches are caught before commit, preventing runtime errors and API contract breakage.

---

## Acceptance Criteria

1. Validation script file `scripts/validate-enums.ts` created
2. Script reads TypeScript enums from `orchestratai_client/src/lib/enums.ts`
3. Script reads Python enums from `orchestratai_api/src/models/enums.py`
4. Script parses TypeScript enums using regex: `export enum EnumName { ... }`
5. Script parses Python enums using regex: `class EnumName(str, Enum):`
6. Script compares enum names between TypeScript and Python
7. Script compares enum keys (e.g., IDLE, ROUTING, ACTIVE) between TS and Python
8. Script compares enum values (e.g., "idle", "routing", "active") between TS and Python
9. Script exits with code 0 if all enums match perfectly
10. Script exits with code 1 if any mismatches found
11. Script outputs clear error messages showing specific mismatches
12. Script added to `package.json` as `validate:enums` command
13. Script integrated into `test` npm script (runs before tests)
14. Script integrated into Husky pre-commit hook
15. Running `bun run validate:enums` successfully validates enums
16. Pre-commit hook prevents commits when enums are out of sync
17. Script output is clear and helpful (shows which enums/values differ)
18. Optional: GitHub Actions workflow created for CI validation

---

## Tasks / Subtasks

- [ ] **Task 1: Create Validation Script File** (AC: 1)
  - [ ] Create directory `scripts/` in project root if not exists
  - [ ] Create file `scripts/validate-enums.ts`
  - [ ] Add TypeScript shebang if needed for direct execution

- [ ] **Task 2: Implement TypeScript Enum Parser** (AC: 2, 4)
  - [ ] Import `readFileSync` from 'fs' and `join` from 'path'
  - [ ] Define `EnumDefinition` interface with `name` and `values` (Record<string, string>)
  - [ ] Implement `parseTSEnums(filePath: string): EnumDefinition[]` function
  - [ ] Use regex `/export enum (\w+)\s*{([^}]+)}/g` to match enum declarations
  - [ ] Use regex `/(\w+)\s*=\s*['"]([^'"]+)['"]/g` to extract key-value pairs
  - [ ] Return array of EnumDefinition objects
  - [ ] Test regex with sample TypeScript enum

- [ ] **Task 3: Implement Python Enum Parser** (AC: 3, 5)
  - [ ] Implement `parsePyEnums(filePath: string): EnumDefinition[]` function
  - [ ] Use regex `/class (\w+)\(.*?Enum\):([^]*?)(?=class |$)/g` to match enum classes
  - [ ] Use regex `/(\w+)\s*=\s*["']([^"']+)["']/g` to extract key-value pairs
  - [ ] Return array of EnumDefinition objects
  - [ ] Test regex with sample Python enum

- [ ] **Task 4: Implement Enum Comparison Logic** (AC: 6, 7, 8, 11, 17)
  - [ ] Implement `compareEnums(tsEnums, pyEnums): { success: boolean; errors: string[] }`
  - [ ] Create Map for TypeScript enums by name
  - [ ] Create Map for Python enums by name
  - [ ] Check if all TypeScript enums exist in Python
  - [ ] Check if all Python enums exist in TypeScript
  - [ ] For matching enums, compare keys (sorted alphabetically)
  - [ ] For matching enums, compare values for each key
  - [ ] Collect error messages with specific details (enum name, key, values)
  - [ ] Return success=true if errors array is empty
  - [ ] Format error messages with emoji indicators (‚ùå) and clear descriptions

- [ ] **Task 5: Implement Main Execution Logic** (AC: 9, 10, 11, 17)
  - [ ] Define file paths: `orchestratai_client/src/lib/enums.ts` and `orchestratai_api/src/models/enums.py`
  - [ ] Add console.log for validation start: "üîç Validating enum synchronization..."
  - [ ] Call parseTSEnums and parsePyEnums in try-catch block
  - [ ] Log number of enums found in each language
  - [ ] Call compareEnums function
  - [ ] If success: log "‚úÖ All enums are synchronized!" and exit(0)
  - [ ] If failure: log errors with console.error, add helpful message, exit(1)
  - [ ] Catch file read errors and exit(1) with clear error message

- [ ] **Task 6: Add Script to package.json** (AC: 12, 13, 15)
  - [ ] Open `package.json` in project root
  - [ ] Add script: `"validate:enums": "bun run scripts/validate-enums.ts"`
  - [ ] Update `test` script to: `"test": "bun run validate:enums && vitest"`
  - [ ] Optionally update `lint` script to include enum validation
  - [ ] Test running `bun run validate:enums` from command line

- [ ] **Task 7: Integrate with Husky Pre-Commit Hook** (AC: 14, 16)
  - [ ] Check if `.husky/pre-commit` exists (should exist from project setup)
  - [ ] Add enum validation to pre-commit hook before lint-staged
  - [ ] Add error handling with clear message if validation fails
  - [ ] Test pre-commit hook by making a dummy commit
  - [ ] Verify hook prevents commit when enums are out of sync

- [ ] **Task 8: Test Validation Script** (AC: 15, 16, 17)
  - [ ] Test with synchronized enums (should pass with exit 0)
  - [ ] Test with missing enum in Python (should fail with clear error)
  - [ ] Test with different enum keys (should fail showing key difference)
  - [ ] Test with different enum values (should fail showing value difference)
  - [ ] Test with missing enum in TypeScript (should fail with clear error)
  - [ ] Verify error messages are clear and actionable
  - [ ] Verify pre-commit hook blocks commits on failure

- [ ] **Task 9: Optional - Create GitHub Actions Workflow** (AC: 18)
  - [ ] Create file `.github/workflows/validate-enums.yml` if desired
  - [ ] Configure workflow to run on push and pull_request
  - [ ] Add steps: checkout, setup-bun, install, validate-enums
  - [ ] Verify workflow fails CI when enums are out of sync

---

## Dev Notes

### Previous Story Context

[Source: docs/stories/1.3.create-typescript-enums-zod-schemas.story.md, 1.4.create-python-enums-pydantic-schemas.story.md]

**Critical Dependencies:**
- **Story 1.3**: Created TypeScript enums in `orchestratai_client/src/lib/enums.ts`
- **Story 1.4**: Created Python enums in `orchestratai_api/src/models/enums.py`
- **This Story**: Validates that Story 1.3 and Story 1.4 enums match exactly

**Enums to Validate (7 total):**
1. AgentStatus (3 values: IDLE, ROUTING, ACTIVE)
2. AgentId (4 values: ORCHESTRATOR, BILLING, TECHNICAL, POLICY)
3. MessageRole (2 values: USER, ASSISTANT)
4. LogType (4 values: ROUTING, VECTOR_SEARCH, CACHE, DOCUMENTS)
5. LogStatus (3 values: SUCCESS, WARNING, ERROR)
6. RetrievalStrategy (3 values: PURE_RAG, PURE_CAG, HYBRID_RAG_CAG)
7. AgentColor (4 values: CYAN, GREEN, BLUE, PURPLE)

### Tech Stack Context

[Source: docs/architecture/3-tech-stack.md, docs/prd/orchestratai_prd_v2.md - Section 2]

**Validation Script Stack:**
- **Language**: TypeScript (runs with Bun runtime)
- **Runtime**: Bun 1.1+ (NOT Node.js - use `bun run` not `node`)
- **File System**: Node.js `fs` module (readFileSync)
- **Path Utilities**: Node.js `path` module (join)
- **Regex Engine**: JavaScript regex for parsing enums

**Why TypeScript for the Script?**
- Bun natively executes TypeScript without compilation
- Type safety for the validation script itself
- Consistent with frontend tooling
- Fast execution with Bun runtime

### Complete Script Implementation

[Source: docs/prd/orchestratai_prd_v2.md - Section 15.2]

**Full Script (Ready to Copy):**

```typescript
// scripts/validate-enums.ts
/**
 * Validates that TypeScript and Python enums are synchronized
 * Run with: bun run scripts/validate-enums.ts
 */

import { readFileSync } from 'fs';
import { join } from 'path';

interface EnumDefinition {
  name: string;
  values: Record<string, string>;
}

function parseTSEnums(filePath: string): EnumDefinition[] {
  const content = readFileSync(filePath, 'utf-8');
  const enums: EnumDefinition[] = [];

  // Match: export enum EnumName { ... }
  const enumRegex = /export enum (\w+)\s*{([^}]+)}/g;
  let match;

  while ((match = enumRegex.exec(content)) !== null) {
    const [, name, body] = match;
    const values: Record<string, string> = {};

    // Match: KEY = 'value',
    const valueRegex = /(\w+)\s*=\s*['"]([^'"]+)['"]/g;
    let valueMatch;

    while ((valueMatch = valueRegex.exec(body)) !== null) {
      values[valueMatch[1]] = valueMatch[2];
    }

    enums.push({ name, values });
  }

  return enums;
}

function parsePyEnums(filePath: string): EnumDefinition[] {
  const content = readFileSync(filePath, 'utf-8');
  const enums: EnumDefinition[] = [];

  // Match: class EnumName(str, Enum):
  const enumRegex = /class (\w+)\(.*?Enum\):([^]*?)(?=class |$)/g;
  let match;

  while ((match = enumRegex.exec(content)) !== null) {
    const [, name, body] = match;
    const values: Record<string, string> = {};

    // Match: KEY = "value"
    const valueRegex = /(\w+)\s*=\s*["']([^"']+)["']/g;
    let valueMatch;

    while ((valueMatch = valueRegex.exec(body)) !== null) {
      values[valueMatch[1]] = valueMatch[2];
    }

    enums.push({ name, values });
  }

  return enums;
}

function compareEnums(
  tsEnums: EnumDefinition[],
  pyEnums: EnumDefinition[]
): { success: boolean; errors: string[] } {
  const errors: string[] = [];

  // Create maps for easy lookup
  const tsMap = new Map(tsEnums.map(e => [e.name, e]));
  const pyMap = new Map(pyEnums.map(e => [e.name, e]));

  // Check TypeScript enums exist in Python
  for (const [name, tsEnum] of tsMap) {
    const pyEnum = pyMap.get(name);

    if (!pyEnum) {
      errors.push(`‚ùå Enum "${name}" exists in TypeScript but not in Python`);
      continue;
    }

    // Check values match
    const tsKeys = Object.keys(tsEnum.values).sort();
    const pyKeys = Object.keys(pyEnum.values).sort();

    if (tsKeys.join(',') !== pyKeys.join(',')) {
      errors.push(`‚ùå Enum "${name}" has different keys:\n  TS: ${tsKeys}\n  PY: ${pyKeys}`);
    }

    // Check value equality
    for (const key of tsKeys) {
      if (tsEnum.values[key] !== pyEnum.values[key]) {
        errors.push(
          `‚ùå Enum "${name}.${key}" has different values:\n  TS: "${tsEnum.values[key]}"\n  PY: "${pyEnum.values[key]}"`
        );
      }
    }
  }

  // Check Python enums exist in TypeScript
  for (const name of pyMap.keys()) {
    if (!tsMap.has(name)) {
      errors.push(`‚ùå Enum "${name}" exists in Python but not in TypeScript`);
    }
  }

  return {
    success: errors.length === 0,
    errors,
  };
}

// Main execution
const TS_ENUMS_PATH = join(process.cwd(), 'orchestratai_client/src/lib/enums.ts');
const PY_ENUMS_PATH = join(process.cwd(), 'orchestratai_api/src/models/enums.py');

console.log('üîç Validating enum synchronization...\n');

try {
  const tsEnums = parseTSEnums(TS_ENUMS_PATH);
  const pyEnums = parsePyEnums(PY_ENUMS_PATH);

  console.log(`Found ${tsEnums.length} TypeScript enums`);
  console.log(`Found ${pyEnums.length} Python enums\n`);

  const result = compareEnums(tsEnums, pyEnums);

  if (result.success) {
    console.log('‚úÖ All enums are synchronized!');
    process.exit(0);
  } else {
    console.error('‚ùå Enum synchronization failed:\n');
    result.errors.forEach(error => console.error(error));
    console.error('\nFix enum mismatches before committing.');
    process.exit(1);
  }
} catch (error) {
  console.error('‚ùå Error reading enum files:', error);
  process.exit(1);
}
```

### Package.json Integration

[Source: docs/prd/orchestratai_prd_v2.md - Section 15.3]

**Add to package.json scripts:**
```json
{
  "scripts": {
    "validate:enums": "bun run scripts/validate-enums.ts",
    "test": "bun run validate:enums && vitest",
    "lint": "bun run validate:enums && eslint ."
  }
}
```

**Why Run Before Tests and Lint?**
- Catches enum mismatches early in development
- Prevents broken builds from type mismatches
- Enforces synchronization as part of standard workflow
- Fast execution (<100ms) with minimal overhead

### Husky Pre-Commit Hook Integration

[Source: docs/prd/orchestratai_prd_v2.md - Section 15.3]

**Update `.husky/pre-commit`:**
```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run enum validation
bun run validate:enums || {
  echo ""
  echo "‚ùå Enum validation failed!"
  echo "Frontend and backend enums are out of sync."
  echo "Fix enum mismatches before committing."
  echo ""
  exit 1
}

# Run other checks
bun run lint-staged
```

**Hook Execution Order:**
1. Enum validation runs first (fast, critical check)
2. If enums are out of sync, commit is blocked immediately
3. Only if enums pass does lint-staged run
4. Prevents committing broken type synchronization

### GitHub Actions Workflow (Optional)

[Source: docs/prd/orchestratai_prd_v2.md - Section 15.3]

**`.github/workflows/validate-enums.yml`:**
```yaml
name: Validate Enums

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run validate:enums
```

**Why Add GitHub Actions?**
- Prevents enum mismatches from being merged in pull requests
- Catches issues even if pre-commit hook is bypassed
- Provides CI/CD confidence before deployment
- Free for public repositories

### Expected Script Behavior

[Source: docs/prd/orchestratai_prd_v2.md - Section 15.4]

**Success Case:**
```bash
$ bun run validate:enums
üîç Validating enum synchronization...

Found 7 TypeScript enums
Found 7 Python enums

‚úÖ All enums are synchronized!
```

**Failure Case - Missing Enum:**
```bash
$ bun run validate:enums
üîç Validating enum synchronization...

Found 7 TypeScript enums
Found 6 Python enums

‚ùå Enum synchronization failed:

‚ùå Enum "RetrievalStrategy" exists in TypeScript but not in Python

Fix enum mismatches before committing.
```

**Failure Case - Different Keys:**
```bash
$ bun run validate:enums
üîç Validating enum synchronization...

Found 7 TypeScript enums
Found 7 Python enums

‚ùå Enum synchronization failed:

‚ùå Enum "AgentStatus" has different keys:
  TS: ACTIVE,IDLE,ROUTING
  PY: ACTIVE,IDLE

Fix enum mismatches before committing.
```

**Failure Case - Different Values:**
```bash
$ bun run validate:enums
üîç Validating enum synchronization...

Found 7 TypeScript enums
Found 7 Python enums

‚ùå Enum synchronization failed:

‚ùå Enum "AgentId.POLICY" has different values:
  TS: "policy"
  PY: "policy_agent"

Fix enum mismatches before committing.
```

### File Structure Context

[Source: docs/architecture/source-tree.md]

**File Locations:**
```
orchestratai/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ validate-enums.ts          # THIS STORY
‚îú‚îÄ‚îÄ orchestratai_client/src/lib/
‚îÇ   ‚îî‚îÄ‚îÄ enums.ts                   # Story 1.3 (TypeScript enums)
‚îú‚îÄ‚îÄ orchestratai_api/src/models/
‚îÇ   ‚îî‚îÄ‚îÄ enums.py                   # Story 1.4 (Python enums)
‚îú‚îÄ‚îÄ .husky/
‚îÇ   ‚îî‚îÄ‚îÄ pre-commit                 # Update in this story
‚îú‚îÄ‚îÄ .github/workflows/
‚îÇ   ‚îî‚îÄ‚îÄ validate-enums.yml         # Optional - this story
‚îî‚îÄ‚îÄ package.json                   # Update scripts section
```

### Coding Standards Compliance

[Source: docs/architecture/16-coding-standards.md]

**Critical Rules:**
- **Enum Sync**: This script ENFORCES the enum synchronization rule
- **Pre-Commit Enforcement**: MUST block commits when enums are out of sync
- **Clear Error Messages**: MUST show which enums/values differ
- **Fast Execution**: MUST run quickly (<100ms) to avoid workflow disruption

### Testing Standards

[Source: docs/architecture/15-testing-strategy.md]

**Testing Approach for This Story:**
- **Manual validation** - Test script with various mismatch scenarios
- **Pre-commit hook testing** - Verify hook blocks commits
- **Validation checklist**:
  1. Script runs successfully with synchronized enums
  2. Script detects missing enums
  3. Script detects different enum keys
  4. Script detects different enum values
  5. Error messages are clear and actionable
  6. Pre-commit hook blocks commits on failure
  7. `bun run validate:enums` command works

**Future Testing** (Epic 2+):
- No automated tests needed for this script
- Script validates itself by validating enums
- Manual testing sufficient for validation script

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation for enum synchronization validation script | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*To be completed by QA Agent*
