# Story 2.5: Message Components (Bubble, List, Typing Indicator)

## Status
Draft

## Story
**As a** frontend developer,
**I want** reusable message components for displaying user and AI messages with agent attribution,
**so that** the chat interface can render conversations with proper styling, scrolling, and loading states.

## Acceptance Criteria
1. MessageBubble component renders user messages (right-aligned, blue styling)
2. MessageBubble component renders assistant messages (left-aligned, dark styling)
3. Assistant messages display agent badge with agent-specific color
4. Assistant messages display confidence score when provided
5. MessageList component renders scrollable list of messages
6. MessageList auto-scrolls to bottom when new message added
7. TypingIndicator component shows animated dots with agent name
8. All components use design tokens from Epic 1 (no arbitrary Tailwind values)
9. Components are accessible (proper ARIA labels, keyboard navigation)
10. Components tested with Vitest component tests

## Tasks / Subtasks

- [ ] Create MessageBubble component in `components/chat/message-bubble.tsx` (AC: 1, 2, 3, 4, 8, 9)
  - [ ] Define props interface: role, content, agent?, confidence?, timestamp?
  - [ ] Add 'use client' directive (interactive component)
  - [ ] Render different layouts based on role (user vs assistant)
  - [ ] User messages: right-aligned, use `bg-[var(--color-agent-primary)]` token
  - [ ] Assistant messages: left-aligned, use `bg-[var(--color-bg-secondary)]` token
  - [ ] Add agent badge for assistant messages using Badge component from shadcn
  - [ ] Color badge based on agent type using agent color tokens
  - [ ] Display confidence score as percentage if provided
  - [ ] Add aria-label for accessibility: "Message from {user|agent}"
  - [ ] Use design tokens for spacing, borders, typography

- [ ] Create agent color mapping utility (AC: 3, 8)
  - [ ] Create `lib/utils/agent-colors.ts`
  - [ ] Map AgentId to CSS variable names
  - [ ] orchestrator ‚Üí `--color-agent-orchestrator` (cyan)
  - [ ] billing ‚Üí `--color-agent-billing` (green)
  - [ ] technical ‚Üí `--color-agent-technical` (blue)
  - [ ] policy ‚Üí `--color-agent-policy` (purple)
  - [ ] Export `getAgentColor(agentId: AgentId): string` function

- [ ] Create MessageList component in `components/chat/message-list.tsx` (AC: 5, 6, 8, 9)
  - [ ] Define props interface: messages array, isProcessing boolean
  - [ ] Add 'use client' directive
  - [ ] Use shadcn ScrollArea component for scrollable container
  - [ ] Map messages to MessageBubble components
  - [ ] Use useRef and useEffect for auto-scroll to bottom
  - [ ] Scroll on: initial render, new message added, window resize
  - [ ] Add `scroll-behavior: smooth` for smooth scrolling
  - [ ] Set aria-label: "Chat message history"
  - [ ] Add aria-live="polite" for screen readers to announce new messages

- [ ] Implement auto-scroll logic (AC: 6)
  - [ ] Create ref: `const bottomRef = useRef<HTMLDivElement>(null)`
  - [ ] Add invisible div at bottom with ref
  - [ ] useEffect depends on [messages.length]
  - [ ] Call `bottomRef.current?.scrollIntoView({ behavior: 'smooth' })`
  - [ ] Only auto-scroll if user is near bottom (prevent scroll hijacking)
  - [ ] Calculate if user scrolled up: compare scrollTop + clientHeight vs scrollHeight

- [ ] Create TypingIndicator component in `components/chat/typing-indicator.tsx` (AC: 7, 8)
  - [ ] Define props interface: agentName string, agentId AgentId
  - [ ] Add 'use client' directive
  - [ ] Render three animated dots (bounce animation)
  - [ ] Display text: "{agentName} is typing..."
  - [ ] Use agent color for background/text color
  - [ ] Use `animation-duration` token for consistent timing
  - [ ] Add aria-live="assertive" for immediate screen reader announcement
  - [ ] Add aria-label: "{agentName} is composing a response"

- [ ] Add CSS animations for typing indicator (AC: 7)
  - [ ] Define @keyframes bounce in component or globals.css
  - [ ] Stagger animation delays for 3 dots (0ms, 160ms, 320ms)
  - [ ] Use `var(--animation-duration-normal)` token

- [ ] Create Message type interface (AC: 1, 2)
  - [ ] Define in `lib/types.ts` or `components/chat/types.ts`
  - [ ] Include: id, role, content, agent?, confidence?, timestamp?
  - [ ] Extend from ChatResponse fields where applicable

- [ ] Write component tests (AC: 10)
  - [ ] Test MessageBubble renders user message with correct styling
  - [ ] Test MessageBubble renders assistant message with agent badge
  - [ ] Test MessageBubble displays confidence score
  - [ ] Test MessageList renders array of messages
  - [ ] Test MessageList auto-scrolls when new message added
  - [ ] Test TypingIndicator displays correct agent name
  - [ ] Test TypingIndicator has animated dots
  - [ ] Mock IntersectionObserver for scroll tests

## Dev Notes

### üö® CRITICAL: 3-Tier CSS Design Token System Requirements

**This story REQUIRES strict adherence to the 3-tier CSS design token system. Violations will result in PR rejection.**

[Source: docs/ux-design-tokens/css-tokens-usage.md, docs/ux-design-tokens/component-styling-guide.md]

#### Token System Architecture:
```
Layer 3: Component Tokens (--color-message-user-bg) ‚Üê USE THESE FIRST
    ‚Üì references
Layer 2: Semantic Tokens (--color-bg-primary) ‚Üê FALLBACK ONLY
    ‚Üì references
Layer 1: Primitive Tokens (--token-color-blue-600) ‚Üê NEVER USE DIRECTLY
```

#### MANDATORY RULES:
1. **NEVER use Layer 1 primitive tokens** (`--token-color-*`) directly in components
2. **NEVER create new tokens without explicit approval** - Ask user first with clear justification
3. **ALWAYS use Component Tokens (Layer 3) first** - Only fall back to Semantic (Layer 2) if component token doesn't exist
4. **Use Tailwind opacity syntax** for transparency: `bg-agent-card-border-cyan/10` (NEVER bake opacity into tokens)
5. **Use approved Tailwind utilities**: `bg-message-user-bg`, `text-agent-card-text-cyan`, `border-agent-card-border-green`

#### Available Message Component Tokens:
```css
/* User Messages */
--color-message-user-bg: #2563eb (Blue 600)
--color-message-user-text: #f9fafb (Gray 50)

/* Assistant Messages */
--color-message-assistant-bg: #0f172a (Slate 900)
--color-message-assistant-text: #d1d5db (Gray 300)
--color-message-assistant-border: #374151 (Gray 700)

/* Agent Badges */
--color-agent-card-border-cyan: #0891b2 (Orchestrator)
--color-agent-card-border-green: #16a34a (Billing)
--color-agent-card-border-blue: #2563eb (Technical)
--color-agent-card-border-purple: #9333ea (Policy)
--color-agent-card-text-cyan: #22d3ee
--color-agent-card-text-green: #4ade80
--color-agent-card-text-blue: #60a5fa
--color-agent-card-text-purple: #c084fc
```

#### Correct vs Incorrect Usage:
```tsx
// ‚úÖ CORRECT: Use Component Token
<div className="bg-message-user-bg text-message-user-text">

// ‚úÖ CORRECT: Use Component Token with opacity
<div className="bg-agent-card-border-cyan/10">

// ‚ùå WRONG: Primitive token
<div className="bg-[var(--token-color-blue-600)]">

// ‚ùå WRONG: Arbitrary hex value
<div className="bg-[#2563eb]">

// ‚ùå WRONG: Direct Tailwind color
<div className="bg-blue-600">
```

#### If You Need a New Token:
**STOP and ask the user for approval with this format:**
```
"I need to create a new token for [purpose]:
- Proposed name: --color-[category]-[usage]
- Proposed value: references var(--token-color-[primitive])
- Justification: [why existing tokens cannot be used]
- Can we get designer approval to add this token?"
```

**DO NOT proceed without user approval. Check if opacity modifiers can solve the need first.**

---

### Previous Story Context
- Epic 1 created design token system with agent colors, spacing, animation tokens
- Epic 1 installed shadcn/ui components including Badge, ScrollArea
- Stories 2.1-2.4 created backend API and frontend client with ChatResponse type

### Component Specifications
[Source: docs/architecture/6-components.md#61-frontend-components, docs/stories/epic-2-chat-interface.md#lines-176-194]

**MessageBubble:**
- Variant: `user` (right-aligned, blue) | `assistant` (left-aligned, dark)
- Props: `{ role: MessageRole, content: string, agent?: AgentId, confidence?: number, timestamp?: Date }`
- Agent badge for assistant messages (colored per agent)
- Confidence score display (optional): "95% confident"

**MessageList:**
- Scrollable container with auto-scroll to bottom
- Maps Message array to MessageBubble components
- Smooth scroll behavior
- Max height with overflow-y-auto

**TypingIndicator:**
- Animated dots (3 dots bouncing)
- Agent-colored background
- Shows agent name: "Billing Agent is typing..."

### Design Token Usage
[Source: docs/stories/epic-1-foundation-design-system.md#lines-167-174]

**CRITICAL PATTERN:**
```tsx
// ‚úÖ CORRECT: Use CSS variable + Tailwind opacity
<div className="bg-[var(--color-bg-primary)]/90">

// ‚ùå WRONG: Direct Tailwind color
<div className="bg-slate-950">
```

**Agent Color Tokens (from Epic 1):**
- `--color-agent-orchestrator` (cyan-500)
- `--color-agent-billing` (green-500)
- `--color-agent-technical` (blue-500)
- `--color-agent-policy` (purple-500)

**Spacing Tokens:**
- Use `var(--spacing-2)`, `var(--spacing-4)`, etc. for padding/margin

**Animation Tokens:**
- `var(--animation-duration-normal)` for transitions

### File Locations
[Source: docs/architecture/9-frontend-architecture.md#91-component-organization]

**Create these files:**
```
orchestratai_client/src/components/chat/
‚îú‚îÄ‚îÄ message-bubble.tsx       # Individual message display
‚îú‚îÄ‚îÄ message-list.tsx         # Scrollable message container
‚îî‚îÄ‚îÄ typing-indicator.tsx     # Loading animation
```

**Utility files:**
```
orchestratai_client/src/lib/utils/
‚îî‚îÄ‚îÄ agent-colors.ts          # Agent color mapping
```

**Test files:**
```
orchestratai_client/src/components/chat/__tests__/
‚îú‚îÄ‚îÄ message-bubble.test.tsx
‚îú‚îÄ‚îÄ message-list.test.tsx
‚îî‚îÄ‚îÄ typing-indicator.test.tsx
```

### Component Implementation Patterns

**MessageBubble Example:**
```tsx
'use client';

import { Badge } from '@/components/ui/badge';
import { MessageRole, AgentId } from '@/lib/enums';
import { getAgentColor } from '@/lib/utils/agent-colors';

interface MessageBubbleProps {
  role: MessageRole;
  content: string;
  agent?: AgentId;
  confidence?: number;
}

export function MessageBubble({ role, content, agent, confidence }: MessageBubbleProps) {
  const isUser = role === MessageRole.USER;

  return (
    <div
      className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}
      aria-label={`Message from ${isUser ? 'user' : agent || 'assistant'}`}
    >
      <div
        className={`max-w-[70%] rounded-lg p-4 ${
          isUser
            ? 'bg-[var(--color-agent-primary)]'
            : 'bg-[var(--color-bg-secondary)]'
        }`}
      >
        {!isUser && agent && (
          <Badge style={{ backgroundColor: `var(${getAgentColor(agent)})` }}>
            {agent}
          </Badge>
        )}
        <p>{content}</p>
        {confidence && (
          <span className="text-sm opacity-70">
            {Math.round(confidence * 100)}% confident
          </span>
        )}
      </div>
    </div>
  );
}
```

**Auto-scroll Pattern:**
```tsx
'use client';

import { useEffect, useRef } from 'react';
import { ScrollArea } from '@/components/ui/scroll-area';

export function MessageList({ messages }: Props) {
  const bottomRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages.length]);

  return (
    <ScrollArea className="h-full" aria-label="Chat message history" aria-live="polite">
      {messages.map(msg => (
        <MessageBubble key={msg.id} {...msg} />
      ))}
      <div ref={bottomRef} />
    </ScrollArea>
  );
}
```

**TypingIndicator Pattern:**
```tsx
'use client';

import { AgentId } from '@/lib/enums';
import { getAgentColor } from '@/lib/utils/agent-colors';

export function TypingIndicator({ agentName, agentId }: Props) {
  return (
    <div
      className="flex items-center gap-2 p-4"
      style={{ color: `var(${getAgentColor(agentId)})` }}
      aria-live="assertive"
      aria-label={`${agentName} is composing a response`}
    >
      <span>{agentName} is typing</span>
      <div className="flex gap-1">
        <div className="h-2 w-2 rounded-full bg-current animate-bounce" style={{ animationDelay: '0ms' }} />
        <div className="h-2 w-2 rounded-full bg-current animate-bounce" style={{ animationDelay: '160ms' }} />
        <div className="h-2 w-2 rounded-full bg-current animate-bounce" style={{ animationDelay: '320ms' }} />
      </div>
    </div>
  );
}
```

### Technical Constraints
[Source: docs/architecture/3-tech-stack.md]

- React: 19.2
- Next.js: 15.5 (App Router)
- shadcn/ui: 3.5.0 (Badge, ScrollArea components)
- Tailwind CSS: 4.0
- Lucide React: Latest (for icons if needed)

### Coding Standards
[Source: docs/architecture/16-coding-standards.md]

- **Server Components First:** Default to Server Components, use `'use client'` only when needed (these components ARE client components due to interactivity)
- **Design Tokens:** Use ONLY token classes, NO arbitrary Tailwind values
- **Naming:** PascalCase for components (`MessageBubble`)

### Accessibility Requirements
- ARIA labels for all interactive elements
- Screen reader announcements for new messages (aria-live)
- Keyboard navigation support
- Sufficient color contrast (WCAG AA)

### Testing

[Source: docs/architecture/15-testing-strategy.md#152-test-examples]

**Test Framework:** Vitest with @testing-library/react
**Test Location:** `orchestratai_client/src/components/chat/__tests__/`
**Test Type:** Component tests (unit level, 70% of pyramid)

**Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { MessageBubble } from '../message-bubble';
import { MessageRole, AgentId } from '@/lib/enums';

describe('MessageBubble', () => {
  it('renders user messages right-aligned', () => {
    render(
      <MessageBubble
        role={MessageRole.USER}
        content="Hello"
      />
    );
    expect(screen.getByText('Hello')).toBeInTheDocument();
    expect(screen.getByLabelText('Message from user')).toBeInTheDocument();
  });

  it('renders assistant messages with agent badge', () => {
    render(
      <MessageBubble
        role={MessageRole.ASSISTANT}
        content="Response"
        agent={AgentId.BILLING}
        confidence={0.95}
      />
    );
    expect(screen.getByText('billing')).toBeInTheDocument();
    expect(screen.getByText('95% confident')).toBeInTheDocument();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

## QA Results
<!-- Populated by QA agent -->
