# Story 1.3: Create TypeScript Enums and Zod Schemas

<!-- Powered by BMAD™ Core -->

## Status

**Draft**

---

## Story

**As a** Frontend Developer,
**I want** to establish a type-safe validation pipeline with TypeScript enums and Zod schemas for all data models,
**so that** the application has runtime type safety, automatic type inference, and prevention of invalid data propagation from the backend API.

---

## Acceptance Criteria

1. TypeScript enum file `orchestratai_client/src/lib/enums.ts` created with 7 enums defined
2. Enum `AgentStatus` defines states: IDLE, ROUTING, ACTIVE
3. Enum `AgentId` defines agents: ORCHESTRATOR, BILLING, TECHNICAL, POLICY
4. Enum `MessageRole` defines roles: USER, ASSISTANT
5. Enum `LogType` defines types: ROUTING, VECTOR_SEARCH, CACHE, DOCUMENTS
6. Enum `LogStatus` defines states: SUCCESS, WARNING, ERROR
7. Enum `RetrievalStrategy` defines: PURE_RAG, PURE_CAG, HYBRID_RAG_CAG
8. Enum `AgentColor` defines: CYAN, GREEN, BLUE, PURPLE
9. Zod schema file `orchestratai_client/src/lib/schemas.ts` created with validation schemas
10. ChatRequest schema validates message (1-2000 chars) and session_id (UUID format)
11. ChatResponse schema validates complete API response structure
12. Agent schema validates agent data model
13. Message schema validates message data model
14. RetrievalLog schema validates retrieval log structure
15. Types file `orchestratai_client/src/lib/types.ts` exports inferred types from Zod schemas
16. All Zod schemas use `.strict()` to prevent unknown fields
17. TypeScript compilation succeeds with zero errors
18. Zod validates sample payloads correctly (manual test in console)

---

## Tasks / Subtasks

- [ ] **Task 1: Create TypeScript Enums File** (AC: 1-8)
  - [ ] Create file `orchestratai_client/src/lib/enums.ts`
  - [ ] Define `AgentStatus` enum with values: IDLE = 'idle', ROUTING = 'routing', ACTIVE = 'active'
  - [ ] Define `AgentId` enum with values: ORCHESTRATOR = 'orchestrator', BILLING = 'billing', TECHNICAL = 'technical', POLICY = 'policy'
  - [ ] Define `MessageRole` enum with values: USER = 'user', ASSISTANT = 'assistant'
  - [ ] Define `LogType` enum with values: ROUTING = 'routing', VECTOR_SEARCH = 'vector_search', CACHE = 'cache', DOCUMENTS = 'documents'
  - [ ] Define `LogStatus` enum with values: SUCCESS = 'success', WARNING = 'warning', ERROR = 'error'
  - [ ] Define `RetrievalStrategy` enum with values: PURE_RAG = 'Pure RAG', PURE_CAG = 'Pure CAG', HYBRID_RAG_CAG = 'Hybrid RAG/CAG'
  - [ ] Define `AgentColor` enum with values: CYAN = 'cyan', GREEN = 'green', BLUE = 'blue', PURPLE = 'purple'
  - [ ] Add JSDoc comments explaining enum purpose and usage

- [ ] **Task 2: Create Zod Validation Schemas** (AC: 9-16)
  - [ ] Create file `orchestratai_client/src/lib/schemas.ts`
  - [ ] Import Zod and all enums
  - [ ] Create `ChatRequestSchema` with message (min 1, max 2000 chars) and session_id (UUID regex)
  - [ ] Create `ChatMetricsSchema` with tokensUsed (>=0), cost (>=0), latency (>=0 ms)
  - [ ] Create `DocumentChunkSchema` with id, content, similarity (0-1), source, metadata (optional)
  - [ ] Create `RetrievalLogSchema` with id, type (LogType enum), title, data, timestamp, status (LogStatus enum), chunks (optional)
  - [ ] Create `MessageSchema` with id, role (MessageRole enum), content, agent (optional AgentId enum), confidence (optional 0-1), timestamp, sessionId
  - [ ] Create `AgentSchema` with id (AgentId enum), name, status (AgentStatus enum), model, strategy (optional RetrievalStrategy enum), color (AgentColor enum), tokensUsed, cost, cached (optional boolean)
  - [ ] Create `ChatResponseSchema` with message, agent (AgentId enum), confidence (0-1), logs (array of RetrievalLog), metrics (ChatMetrics)
  - [ ] Add `.strict()` to all schemas to reject unknown properties
  - [ ] Add descriptive error messages using `.describe()` method

- [ ] **Task 3: Create TypeScript Types File** (AC: 15)
  - [ ] Create file `orchestratai_client/src/lib/types.ts`
  - [ ] Import all Zod schemas
  - [ ] Export inferred type `ChatRequest` using `z.infer<typeof ChatRequestSchema>`
  - [ ] Export inferred type `ChatResponse` using `z.infer<typeof ChatResponseSchema>`
  - [ ] Export inferred type `Agent` using `z.infer<typeof AgentSchema>`
  - [ ] Export inferred type `Message` using `z.infer<typeof MessageSchema>`
  - [ ] Export inferred type `RetrievalLog` using `z.infer<typeof RetrievalLogSchema>`
  - [ ] Export inferred type `ChatMetrics` using `z.infer<typeof ChatMetricsSchema>`
  - [ ] Export inferred type `DocumentChunk` using `z.infer<typeof DocumentChunkSchema>`
  - [ ] Re-export all enums for convenience

- [ ] **Task 4: Validate TypeScript Compilation** (AC: 17)
  - [ ] Run `bunx tsc --noEmit --project orchestratai_client/tsconfig.json`
  - [ ] Verify zero TypeScript errors
  - [ ] Fix any type errors if found
  - [ ] Confirm strict mode compilation passes

- [ ] **Task 5: Manual Validation Testing** (AC: 18)
  - [ ] Create sample valid ChatRequest payload
  - [ ] Create sample valid ChatResponse payload
  - [ ] Test Zod schema validation in Node.js console or test file
  - [ ] Verify valid payloads pass validation
  - [ ] Test invalid payloads (missing fields, wrong types, extra fields)
  - [ ] Verify Zod rejects invalid payloads with clear error messages

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.2.create-token-file-structure.story.md - Completion Notes]

**Key Learnings from Story 1.2:**
- **TypeScript Compilation Command**: Use `bunx tsc --noEmit --project orchestratai_client/tsconfig.json` for validation
- **Bun Package Manager**: Use `bun add` for dependencies (NOT npm/yarn)
- **Zero Technical Debt Standard**: All code must pass TypeScript strict mode with zero errors
- **File Naming Convention**: Use kebab-case for all TypeScript utility files (e.g., `enums.ts`, `schemas.ts`)
- **Design Token System Already Complete**: Story 1.2 verified full 3-layer token system is functional

### Tech Stack Context

[Source: docs/prd/orchestratai_prd_v2.md - Section 2]

**TypeScript & Validation Stack:**
- **TypeScript**: v5.x with strict mode enabled
- **Zod**: v3.x for runtime validation (to be installed in this story)
- **Package Manager**: Bun (use `bun add zod` for installation)
- **Type Philosophy**: Single source of truth via Zod schema inference

**Why Zod?**
- Runtime validation prevents invalid API data from propagating
- Automatic TypeScript type inference (DRY principle - define schema once, get types free)
- Better error messages than manual validation
- Composable schemas for complex data structures

### Enum Definitions

[Source: docs/prd/orchestratai_prd_v2.md - Section 6.1]

**Complete Enum Specifications:**

```typescript
// AgentStatus - Represents current state of an AI agent
export enum AgentStatus {
  IDLE = 'idle',         // Agent waiting for work
  ROUTING = 'routing',   // Orchestrator routing query
  ACTIVE = 'active',     // Agent actively processing
}

// AgentId - Unique identifier for each agent type
export enum AgentId {
  ORCHESTRATOR = 'orchestrator',  // Router agent
  BILLING = 'billing',            // Billing support
  TECHNICAL = 'technical',        // Technical support
  POLICY = 'policy',              // Policy & compliance
}

// MessageRole - Chat message sender type
export enum MessageRole {
  USER = 'user',              // User-sent message
  ASSISTANT = 'assistant',    // AI-generated response
}

// LogType - Category of retrieval operation log
export enum LogType {
  ROUTING = 'routing',               // Query routing decision
  VECTOR_SEARCH = 'vector_search',   // Vector DB search
  CACHE = 'cache',                   // Cache operation
  DOCUMENTS = 'documents',           // Document retrieval
}

// LogStatus - Status indicator for logs
export enum LogStatus {
  SUCCESS = 'success',  // Operation succeeded
  WARNING = 'warning',  // Operation succeeded with warnings
  ERROR = 'error',      // Operation failed
}

// RetrievalStrategy - RAG/CAG approach used by agent
export enum RetrievalStrategy {
  PURE_RAG = 'Pure RAG',              // Retrieval-Augmented Generation only
  PURE_CAG = 'Pure CAG',              // Context-Augmented Generation only
  HYBRID_RAG_CAG = 'Hybrid RAG/CAG',  // Combined approach
}

// AgentColor - UI color coding for agents
export enum AgentColor {
  CYAN = 'cyan',      // Orchestrator
  GREEN = 'green',    // Billing
  BLUE = 'blue',      // Technical
  PURPLE = 'purple',  // Policy
}
```

### Zod Schema Specifications

[Source: docs/prd/orchestratai_prd_v2.md - Section 6.2]

**ChatRequest Schema:**
- `message`: string, min 1 char, max 2000 chars
- `session_id`: string, UUID v4 format (regex validation)

**ChatResponse Schema:**
- `message`: string (AI response text)
- `agent`: AgentId enum
- `confidence`: number, 0.0 to 1.0
- `logs`: array of RetrievalLog
- `metrics`: ChatMetrics object

**Agent Schema:**
- `id`: AgentId enum
- `name`: string
- `status`: AgentStatus enum
- `model`: string (e.g., "OpenAI GPT-4o")
- `strategy`: RetrievalStrategy enum (optional)
- `color`: AgentColor enum
- `tokensUsed`: number (>=0)
- `cost`: number (>=0)
- `cached`: boolean (optional)

**Message Schema:**
- `id`: string (UUID)
- `role`: MessageRole enum
- `content`: string
- `agent`: AgentId enum (optional, only for assistant messages)
- `confidence`: number 0.0-1.0 (optional)
- `timestamp`: Date
- `sessionId`: string (UUID)

**RetrievalLog Schema:**
- `id`: string (UUID)
- `type`: LogType enum
- `title`: string
- `data`: object (any key-value pairs)
- `timestamp`: string (ISO 8601)
- `status`: LogStatus enum
- `chunks`: array of DocumentChunk (optional)

**DocumentChunk Schema:**
- `id`: number
- `content`: string
- `similarity`: number (0.0 to 1.0)
- `source`: string
- `metadata`: object (optional)

**ChatMetrics Schema:**
- `tokensUsed`: number (>=0)
- `cost`: number (>=0, USD)
- `latency`: number (>=0, milliseconds)

### Data Model Context

[Source: docs/architecture/4-data-models.md]

**Data Model Relationships:**
- ChatSession contains multiple Messages
- Messages trigger RetrievalLogs
- RetrievalLogs can include DocumentChunks
- Agents produce Messages
- All relationships maintained through UUID foreign keys

**Type Safety Philosophy:**
1. Define Zod schema as single source of truth
2. Infer TypeScript types automatically
3. Use enums for all constant values
4. Validate at API boundaries (request/response)
5. Never trust external data without validation

### File Structure

[Source: docs/architecture/source-tree.md]

**File Locations:**
```
orchestratai_client/src/lib/
├── enums.ts          # TypeScript enum definitions (THIS STORY)
├── schemas.ts        # Zod validation schemas (THIS STORY)
├── types.ts          # Type exports from Zod inference (THIS STORY)
├── api-client.ts     # HTTP client (Epic 2)
├── errors.ts         # Custom error classes (Epic 2)
└── utils.ts          # Utility functions (future)
```

**Naming Convention:**
- Files: kebab-case (e.g., `enums.ts`, `schemas.ts`)
- Types/Interfaces: PascalCase (e.g., `ChatRequest`, `Agent`)
- Enums: PascalCase (e.g., `AgentStatus`, `MessageRole`)
- Enum values: SCREAMING_SNAKE_CASE for keys, lowercase strings for values

### Zod Best Practices

[Source: docs/prd/orchestratai_prd_v2.md - Section 6.2]

**Critical Patterns:**

```typescript
// ✅ CORRECT: Use .strict() to prevent extra fields
export const ChatRequestSchema = z.object({
  message: z.string().min(1).max(2000),
  session_id: z.string().uuid(),
}).strict();

// ✅ CORRECT: Use enum validation
export const AgentSchema = z.object({
  id: z.nativeEnum(AgentId),
  status: z.nativeEnum(AgentStatus),
  // ...
});

// ✅ CORRECT: Use .describe() for better error messages
export const ChatRequestSchema = z.object({
  message: z.string().min(1).max(2000).describe('User message content'),
  session_id: z.string().uuid().describe('Chat session UUID'),
}).strict();

// ✅ CORRECT: Nested schemas for complex objects
export const ChatResponseSchema = z.object({
  message: z.string(),
  agent: z.nativeEnum(AgentId),
  confidence: z.number().min(0).max(1),
  logs: z.array(RetrievalLogSchema),
  metrics: ChatMetricsSchema,
}).strict();
```

**Validation Usage Pattern:**
```typescript
// Parse (throws error if invalid)
const validData = ChatRequestSchema.parse(untrustedData);

// SafeParse (returns success/error object)
const result = ChatRequestSchema.safeParse(untrustedData);
if (result.success) {
  const validData = result.data;
} else {
  console.error(result.error);
}
```

### Coding Standards Compliance

[Source: docs/architecture/16-coding-standards.md]

**Critical Rules:**
- **Type Sharing**: These types will later move to `packages/shared` (Epic 2+)
- **Enum Sync**: Python enums MUST mirror these TypeScript enums exactly (Story 1.4)
- **No Type Duplication**: Define types once, import everywhere
- **Strict Mode**: All Zod schemas MUST use `.strict()` to reject unknown fields

**Naming Conventions:**
- Enums: PascalCase (e.g., `AgentStatus`)
- Types: PascalCase (e.g., `ChatRequest`)
- Schema constants: PascalCase + "Schema" suffix (e.g., `ChatRequestSchema`)

### Testing Standards

[Source: docs/architecture/15-testing-strategy.md]

**Testing Approach for This Story:**
- **Manual validation ONLY** - No unit tests required for enum/schema definition
- **Validation checklist**:
  1. TypeScript compilation succeeds (`bunx tsc --noEmit`)
  2. Zod validates sample payloads correctly
  3. Invalid payloads rejected with clear error messages
  4. Enum values match specification exactly

**Future Testing** (Epic 2+):
- Unit tests will validate API client usage of schemas
- Integration tests will validate end-to-end type flow
- Test location: `orchestratai_client/tests/unit/lib/`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation for TypeScript enums and Zod schemas | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

---

## QA Results

*To be completed by QA Agent*
