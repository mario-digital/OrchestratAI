# <!-- Powered by BMAD™ Core -->

## Status
to be done later

## Story
**As a** mobile user,
**I want** smooth tab transitions with optional swipe gestures,
**so that** I can navigate between panels naturally like native mobile apps

## Acceptance Criteria
1. Tapping a tab smoothly transitions to the corresponding panel
2. Tab switch animation completes in < 100ms
3. Swipe right gesture switches to the previous tab (Chat ← Agents ← Logs)
4. Swipe left gesture switches to the next tab (Chat → Agents → Logs)
5. Swipe threshold is 50px minimum to trigger tab change
6. Partial swipes that don't meet threshold spring back to original position
7. Active panel has visible slide-in animation
8. No animation jank (maintains 60fps during transitions)
9. Swipe gestures work on touch devices (iOS Safari, Chrome Android)
10. Desktop remains unchanged (no swipe, click only)

## Tasks / Subtasks

- [ ] Task 1: Create SwipeHandler component with touch detection (AC: 3, 4, 5, 6, 9)
  - [ ] Create `components/mobile/swipe-handler.tsx` file
  - [ ] Implement onTouchStart handler to capture initial touch position
  - [ ] Implement onTouchMove handler to track swipe distance
  - [ ] Implement onTouchEnd handler to determine if threshold met
  - [ ] Calculate swipe direction (left vs right)
  - [ ] Trigger tab change callback if swipe exceeds 50px threshold
  - [ ] Add spring-back animation for partial swipes (< 50px)
  - [ ] Prevent vertical scroll during horizontal swipe
  - [ ] Write unit tests for swipe detection logic

- [ ] Task 2: Add animation utilities using Framer Motion (AC: 1, 2, 7, 8)
  - [ ] Install framer-motion: `bun add framer-motion`
  - [ ] Create animation variants for tab transitions
  - [ ] Define slide-in-left animation (opacity 0→1, translateX -20px→0)
  - [ ] Define slide-in-right animation (opacity 0→1, translateX 20px→0)
  - [ ] Set animation duration to 100ms with ease-out curve
  - [ ] Ensure animations use GPU acceleration (transform, opacity only)
  - [ ] Test animations maintain 60fps on low-end devices

- [ ] Task 3: Update TabPanel to support animations (AC: 1, 7)
  - [ ] Wrap TabPanel content in Framer Motion `<motion.div>`
  - [ ] Add initial, animate, exit animation states
  - [ ] Apply appropriate animation variant based on tab direction
  - [ ] Use AnimatePresence for smooth exit animations
  - [ ] Add key prop to force re-mount on tab change
  - [ ] Write tests for animation presence

- [ ] Task 4: Integrate SwipeHandler into page layout (AC: 3, 4, 10)
  - [ ] Wrap mobile panel area with SwipeHandler component
  - [ ] Connect swipe callbacks to tab state setter
  - [ ] Prevent swipe on first tab (Chat) when swiping right (no previous tab)
  - [ ] Prevent swipe on last tab (Logs) when swiping left (no next tab)
  - [ ] Ensure SwipeHandler only active on mobile (< 768px)
  - [ ] Test edge cases (rapid swipes, multi-touch)

- [ ] Task 5: Add visual feedback during swipe (AC: 6, 7)
  - [ ] Show panel preview during active swipe
  - [ ] Add drag resistance when approaching tab boundaries
  - [ ] Display subtle shadow/overlay during swipe
  - [ ] Update tab bar active indicator in real-time during swipe
  - [ ] Ensure visual feedback doesn't cause layout shift

- [ ] Task 6: Performance optimization (AC: 2, 8)
  - [ ] Use `requestAnimationFrame` for smooth animations
  - [ ] Throttle touch move events (every 16ms for 60fps)
  - [ ] Use `will-change: transform` CSS hint for animated elements
  - [ ] Ensure no unnecessary re-renders during swipe
  - [ ] Profile with Chrome DevTools Performance tab
  - [ ] Verify 60fps on iPhone 12 and Samsung Galaxy S21

- [ ] Task 7: Cross-browser and device testing (AC: 9, 10)
  - [ ] Test on iOS Safari (iPhone 12, 14 Pro)
  - [ ] Test on Chrome Android (Samsung Galaxy, Pixel)
  - [ ] Test on desktop Chrome (ensure no swipe behavior)
  - [ ] Test on tablet breakpoint (768px+, should use desktop layout)
  - [ ] Verify touch events don't conflict with scroll
  - [ ] Test with iOS VoiceOver (ensure accessibility maintained)

- [ ] Task 8: Add integration tests (AC: All)
  - [ ] Test tab change via tap
  - [ ] Test tab change via swipe gesture (mock touch events)
  - [ ] Test animation completion
  - [ ] Test swipe threshold (49px no change, 51px changes)
  - [ ] Test boundary conditions (first/last tab)
  - [ ] Verify no console errors or warnings

## Dev Notes

### Previous Story Context
From Story 4.1 (Build Tab Navigation):
- TabNavigation component with 3 tabs (Chat, Agents, Logs)
- TabPanel wrapper for conditional rendering
- useMobile hook for breakpoint detection
- Active tab state managed in page.tsx
- Accessibility structure (ARIA roles) already implemented

### Animation Library
**[Source: Epic 4 spec, architecture/3-tech-stack.md]**
- Install Framer Motion: `bun add framer-motion` (recommended for smooth animations)
- Alternative: CSS transitions with Tailwind (lighter weight but less control)
- Recommendation: Use Framer Motion for professional polish

### Touch Event Handling
**[Source: Epic 4 spec]**
- Browser APIs: `TouchEvent` interface with `touches`, `changedTouches`
- Key properties:
  - `touchStart.clientX` - Initial touch X position
  - `touchMove.clientX` - Current touch X position
  - `touchEnd.clientX` - Final touch X position
- Calculate delta: `touchEnd.clientX - touchStart.clientX`
- Positive delta = swipe right (go to previous tab)
- Negative delta = swipe left (go to next tab)

### Swipe Detection Logic
```typescript
// Example from Epic 4 spec
const handleTouchStart = (e: TouchEvent) => {
  setTouchStart(e.touches[0].clientX);
};

const handleTouchEnd = (e: TouchEvent) => {
  const touchEnd = e.changedTouches[0].clientX;
  const delta = touchEnd - touchStart;

  if (Math.abs(delta) > SWIPE_THRESHOLD) {
    if (delta > 0 && currentTabIndex > 0) {
      // Swipe right - go to previous tab
      setActiveTab(tabs[currentTabIndex - 1].id);
    } else if (delta < 0 && currentTabIndex < tabs.length - 1) {
      // Swipe left - go to next tab
      setActiveTab(tabs[currentTabIndex + 1].id);
    }
  }
};
```

### Framer Motion Animation Variants
**[Source: Epic 4 spec]**
```typescript
const slideVariants = {
  enterFromRight: {
    opacity: 0,
    x: 20,
  },
  enterFromLeft: {
    opacity: 0,
    x: -20,
  },
  center: {
    opacity: 1,
    x: 0,
  },
  exitToRight: {
    opacity: 0,
    x: 20,
  },
  exitToLeft: {
    opacity: 0,
    x: -20,
  },
};

const transition = {
  duration: 0.1, // 100ms
  ease: 'easeOut',
};
```

### Performance Best Practices
**[Source: Web Performance Guidelines]**
- Only animate `transform` and `opacity` (GPU accelerated)
- Avoid animating `width`, `height`, `left`, `top` (triggers layout)
- Use `will-change: transform` sparingly (adds memory overhead)
- Remove `will-change` after animation completes
- Throttle touch events: Maximum 1 event per 16ms (60fps)
- Use passive event listeners for scroll performance: `{ passive: true }`

### Preventing Scroll During Swipe
**[Source: Touch Event Handling]**
```typescript
const handleTouchMove = (e: TouchEvent) => {
  const deltaX = Math.abs(e.touches[0].clientX - touchStart);
  const deltaY = Math.abs(e.touches[0].clientY - touchStartY);

  // If horizontal swipe detected, prevent vertical scroll
  if (deltaX > deltaY) {
    e.preventDefault(); // Prevent scroll
  }

  // Track position for visual feedback
  setSwipeDistance(e.touches[0].clientX - touchStart);
};
```
⚠️ **Important**: Add `{ passive: false }` to touchmove listener to allow `preventDefault()`

### Component Structure
**[Source: architecture/9-frontend-architecture.md, Story 4.1]**
```
orchestratai_client/src/
├── components/mobile/
│   ├── tab-navigation.tsx       # From Story 4.1
│   ├── tab-panel.tsx            # From Story 4.1 - UPDATE
│   ├── swipe-handler.tsx        # NEW
│   └── __tests__/
│       ├── tab-navigation.test.tsx
│       ├── tab-panel.test.tsx
│       └── swipe-handler.test.tsx  # NEW
└── hooks/
    └── use-mobile.ts            # From Story 4.1
```

### Accessibility Considerations
**[Source: WCAG 2.1, Epic 4 spec]**
- Swipe gestures are OPTIONAL enhancement (nice-to-have)
- All functionality must remain accessible via tap/click
- Screen reader users rely on tab navigation, not swipes
- Ensure swipe doesn't interfere with VoiceOver/TalkBack gestures
- Test with iOS VoiceOver enabled (swipe behavior should not break)

### Testing Touch Events
**[Source: Testing Library]**
```typescript
// Mock touch events in tests
const createTouchEvent = (clientX: number) => ({
  touches: [{ clientX }],
  changedTouches: [{ clientX }],
  preventDefault: jest.fn(),
});

it('triggers tab change on swipe left', () => {
  const handleChange = jest.fn();
  render(<SwipeHandler onSwipe={handleChange}>{children}</SwipeHandler>);

  const element = screen.getByTestId('swipe-area');
  fireEvent.touchStart(element, createTouchEvent(200));
  fireEvent.touchEnd(element, createTouchEvent(100)); // 100px left swipe

  expect(handleChange).toHaveBeenCalledWith('next');
});
```

### Swipe Constants
**[Source: Epic 4 spec, UX best practices]**
```typescript
const SWIPE_THRESHOLD = 50; // Minimum pixels to trigger tab change
const SWIPE_VELOCITY_THRESHOLD = 0.5; // Optional: pixels per ms
const ANIMATION_DURATION = 100; // ms
const THROTTLE_MS = 16; // 60fps
```

### Integration with TabPanel
**[Source: Story 4.1, Framer Motion docs]**
- Update TabPanel to accept `direction` prop ('left' | 'right')
- Use direction to determine animation variant
- Wrap children in `<AnimatePresence mode="wait">`
- Add unique `key` prop to force re-mount: `key={activeTab}`

### Browser Support
**[Source: architecture/3-tech-stack.md, MDN]**
- Touch Events supported: iOS Safari 2+, Chrome Android, all modern mobile browsers
- Framer Motion supported: All modern browsers (ES6+)
- Fallback: If Touch Events unavailable, component works without swipe (tap only)
- Desktop browsers: Touch events ignored, click events work normally

### Mobile Viewport Testing
**[Source: Epic 4 testing strategy]**
- Test on physical devices (iPhone, Android phone)
- Use Chrome DevTools device emulation with touch simulation
- Test viewports: 320px (iPhone SE), 375px (iPhone 12), 390px (iPhone 14 Pro)
- Test landscape orientation (swipe still works)
- Test with iOS "Reduce Motion" setting (disable animations, instant transitions)

### Testing

**[Source: architecture/15-testing-strategy.md]**

**Test File Locations:**
- `orchestratai_client/src/components/mobile/__tests__/swipe-handler.test.tsx`
- Update: `orchestratai_client/src/components/mobile/__tests__/tab-panel.test.tsx` (add animation tests)

**Testing Framework:**
- Vitest for unit tests
- React Testing Library for component tests
- Mock `framer-motion` for faster tests (optional)
- Mock Touch Events using `createTouchEvent` helper

**Test Coverage Requirements:**
- Minimum 90% coverage required
- Test swipe threshold (edge cases: 49px, 50px, 51px)
- Test boundary conditions (first tab, last tab)
- Test animation completion (use `waitFor`)
- Test performance (no excessive re-renders)

**Example Test Structure:**
```typescript
describe('SwipeHandler', () => {
  it('does not change tab on swipe < 50px', () => {
    const handleSwipe = jest.fn();
    render(<SwipeHandler onSwipe={handleSwipe}>{content}</SwipeHandler>);

    const element = screen.getByTestId('swipe-area');
    fireEvent.touchStart(element, createTouchEvent(100));
    fireEvent.touchEnd(element, createTouchEvent(51)); // 49px swipe

    expect(handleSwipe).not.toHaveBeenCalled();
  });

  it('changes tab on swipe >= 50px', () => {
    const handleSwipe = jest.fn();
    render(<SwipeHandler onSwipe={handleSwipe}>{content}</SwipeHandler>);

    const element = screen.getByTestId('swipe-area');
    fireEvent.touchStart(element, createTouchEvent(100));
    fireEvent.touchEnd(element, createTouchEvent(49)); // 51px swipe

    expect(handleSwipe).toHaveBeenCalledWith('next');
  });

  it('prevents swipe right on first tab', () => {
    render(<SwipeHandler currentIndex={0} onSwipe={jest.fn()}>{content}</SwipeHandler>);

    const element = screen.getByTestId('swipe-area');
    fireEvent.touchStart(element, createTouchEvent(100));
    fireEvent.touchEnd(element, createTouchEvent(200)); // Swipe right

    expect(handleSwipe).not.toHaveBeenCalled();
  });
});
```

### Styling Standards
**[Source: architecture/16-coding-standards.md]**
- Use design token classes ONLY
- Animation timing: Use `var(--transition-fast)` if token exists, otherwise hardcode 100ms
- Easing: Use `ease-out` for entry animations, `ease-in` for exit animations
- Never use arbitrary Tailwind values for animation

### Dependencies to Install
**[Source: Epic 4 spec]**
```bash
bun add framer-motion  # Animation library
```

### Performance Metrics
**[Source: Epic 4 Non-Functional Requirements]**
- Tab switch animation: < 100ms completion time
- Touch event processing: < 10ms per event
- Frame rate during animation: 60fps (no dropped frames)
- Memory: No memory leaks from event listeners (verify with Chrome DevTools Memory profiler)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
