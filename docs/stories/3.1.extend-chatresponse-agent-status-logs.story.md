# Story 3.1: Extend ChatResponse Model with Agent Status and Retrieval Logs

## Status
Ready for development

## Story
**As a** backend developer,
**I want** the ChatResponse model to include agent_status mapping and enriched retrieval_logs,
**so that** the frontend can display real-time agent status updates and detailed retrieval operations in the UI panels.

## Acceptance Criteria
1. ChatResponse schema includes `agent_status` field (dict mapping AgentId to AgentStatus)
2. ChatResponse schema includes enriched `metrics` with cache_status field
3. AgentStatus enum includes states: IDLE, ROUTING, ACTIVE, COMPLETE
4. RetrievalLog data structure supports polymorphic data for different log types
5. New data structures defined for QueryAnalysis, VectorSearch, and CacheOperation
6. All new schemas have proper Pydantic validation
7. Schemas include field descriptions and constraints
8. Backend type definitions match Epic 3 specifications
9. All existing tests pass with schema updates
10. New schema fields are backward compatible with Epic 2 chat endpoint

## Tasks / Subtasks

- [ ] Update AgentStatus enum with new states (AC: 3)
  - [ ] Add ROUTING state to AgentStatus enum in `orchestratai_api/src/models/enums.py`
  - [ ] Add ACTIVE state to AgentStatus enum
  - [ ] Add COMPLETE state to AgentStatus enum
  - [ ] Verify IDLE state already exists from Epic 1
  - [ ] Update frontend enum sync: Add matching states to `orchestratai_client/src/lib/enums.ts`
  - [ ] Run `bun run validate:enums` to verify synchronization

- [ ] Extend ChatMetrics schema (AC: 2)
  - [ ] Add `cache_status` field to ChatMetrics in `orchestratai_api/src/models/schemas.py`
  - [ ] Set field type as `Literal["hit", "miss", "none"]`
  - [ ] Add Field description: "Cache hit/miss status for this request"
  - [ ] Set default value to "none"

- [ ] Add agent_status field to ChatResponse (AC: 1)
  - [ ] Add `agent_status` field to ChatResponse schema
  - [ ] Set type as `dict[AgentId, AgentStatus]`
  - [ ] Add Field description: "Current status of all agents in the system"
  - [ ] Document expected structure: `{"orchestrator": "ROUTING", "billing": "ACTIVE", ...}`

- [ ] Create QueryAnalysis data structure (AC: 5)
  - [ ] Create QueryAnalysis Pydantic model in `orchestratai_api/src/models/schemas.py`
  - [ ] Add `intent` field (str) - "Billing inquiry detected"
  - [ ] Add `confidence` field (float, 0-1) - confidence score
  - [ ] Add `target_agent` field (AgentId) - which agent will handle this
  - [ ] Add `reasoning` field (str) - why this agent was selected
  - [ ] Add proper Field validators and descriptions

- [ ] Create VectorSearch data structure (AC: 5)
  - [ ] Create VectorSearch Pydantic model in `orchestratai_api/src/models/schemas.py`
  - [ ] Add `collection` field (str) - vector DB collection name
  - [ ] Add `chunks_retrieved` field (int, ge=0) - number of chunks found
  - [ ] Add `chunks` field (list[DocumentChunk]) - the actual chunks
  - [ ] Add `latency` field (int, ge=0) - search time in milliseconds
  - [ ] Add proper Field validators and descriptions

- [ ] Create CacheOperation data structure (AC: 5)
  - [ ] Create CacheOperation Pydantic model in `orchestratai_api/src/models/schemas.py`
  - [ ] Add `status` field (Literal["hit", "miss"]) - cache result
  - [ ] Add `hit_rate` field (float, 0-1) - percentage of cache hits
  - [ ] Add `size` field (str) - cache size like "2.3 MB"
  - [ ] Add proper Field validators and descriptions

- [ ] Update RetrievalLog to support polymorphic data (AC: 4)
  - [ ] Review current RetrievalLog.data field (should be dict[str, Any])
  - [ ] Add documentation explaining polymorphic structure
  - [ ] Document data field content for type="query_analysis" → QueryAnalysis
  - [ ] Document data field content for type="vector_search" → VectorSearch
  - [ ] Document data field content for type="cache_operation" → CacheOperation
  - [ ] No code changes needed if data is already dict[str, Any]

- [ ] Add schema documentation (AC: 7)
  - [ ] Add docstrings to QueryAnalysis model
  - [ ] Add docstrings to VectorSearch model
  - [ ] Add docstrings to CacheOperation model
  - [ ] Add docstrings to updated ChatResponse fields
  - [ ] Add docstrings to updated ChatMetrics fields

- [ ] Write unit tests for new schemas (AC: 9)
  - [ ] Test AgentStatus enum has all 4 states
  - [ ] Test ChatMetrics with cache_status field
  - [ ] Test ChatResponse with agent_status field
  - [ ] Test QueryAnalysis validation (valid and invalid cases)
  - [ ] Test VectorSearch validation (valid and invalid cases)
  - [ ] Test CacheOperation validation (valid and invalid cases)
  - [ ] Test RetrievalLog with polymorphic data for each type
  - [ ] Add tests to `orchestratai_api/tests/test_schemas.py`

- [ ] Run integration tests to verify backward compatibility (AC: 10)
  - [ ] Run existing Epic 2 chat endpoint tests
  - [ ] Verify all tests pass with schema updates
  - [ ] Run `uv run pytest tests/` to validate
  - [ ] Fix any breaking changes if tests fail

## Dev Notes

### Source Tree Info
[Source: docs/architecture/source-tree.md#Backend]
- Backend models location: `orchestratai_api/src/models/`
- Enums file: `orchestratai_api/src/models/enums.py`
- Schemas file: `orchestratai_api/src/models/schemas.py`
- Tests location: `orchestratai_api/tests/test_schemas.py`

### Data Models Reference
[Source: docs/architecture/4-data-models.md]

**AgentStatus Enum** (NEW states to add):
- IDLE (already exists)
- ROUTING (new) - Orchestrator is analyzing and routing the query
- ACTIVE (new) - Agent is currently processing the request
- COMPLETE (new) - Agent has finished processing

**ChatMetrics Extension**:
```python
class ChatMetrics(BaseModel):
    tokensUsed: int = Field(..., ge=0)
    cost: float = Field(..., ge=0)
    latency: int = Field(..., ge=0)
    cache_status: Literal["hit", "miss", "none"] = Field("none")  # NEW
```

**ChatResponse Extension**:
```python
class ChatResponse(BaseModel):
    message: str
    agent: AgentId
    confidence: float
    logs: list[RetrievalLog]
    metrics: ChatMetrics
    agent_status: dict[AgentId, AgentStatus]  # NEW - maps all 4 agents to their states
```

**QueryAnalysis Structure**:
```python
class QueryAnalysis(BaseModel):
    intent: str = Field(..., description="Detected user intent")
    confidence: float = Field(..., ge=0, le=1, description="Intent confidence score")
    target_agent: AgentId = Field(..., description="Selected agent")
    reasoning: str = Field(..., description="Routing reasoning")
```

**VectorSearch Structure**:
```python
class VectorSearch(BaseModel):
    collection: str = Field(..., description="Vector DB collection name")
    chunks_retrieved: int = Field(..., ge=0, description="Number of chunks found")
    chunks: list[DocumentChunk] = Field(..., description="Retrieved document chunks")
    latency: int = Field(..., ge=0, description="Search latency in ms")
```

**CacheOperation Structure**:
```python
class CacheOperation(BaseModel):
    status: Literal["hit", "miss"] = Field(..., description="Cache result")
    hit_rate: float = Field(..., ge=0, le=1, description="Overall cache hit rate")
    size: str = Field(..., description="Cache size (e.g., '2.3 MB')")
```

### Epic 3 Technical Specifications
[Source: docs/stories/epic-3-agent-log-panels.md#Backend Response Enhancement]

The backend `/api/chat` endpoint should return enhanced response structure:
- `agent_status`: Dictionary showing all 4 agents (orchestrator, billing, technical, policy) and their current states
- Example: `{"orchestrator": "IDLE", "billing": "ACTIVE", "technical": "IDLE", "policy": "IDLE"}`
- The agent that processes the request should be in ACTIVE or COMPLETE state
- Orchestrator should transition: IDLE → ROUTING → IDLE during processing

### Enum Synchronization
[Source: docs/architecture/16-coding-standards.md#Critical Rules]
- **CRITICAL**: Frontend and backend enums MUST stay synchronized
- After adding ROUTING, ACTIVE, COMPLETE to backend AgentStatus enum
- Must add identical values to `orchestratai_client/src/lib/enums.ts`
- Run `bun run validate:enums` before committing
- Husky pre-commit hook will enforce this

### Existing Schemas to Extend
[Source: orchestratai_api/src/models/schemas.py]

Current ChatResponse structure (Epic 2):
```python
class ChatResponse(BaseModel):
    message: str = Field(..., description="Assistant response content")
    agent: AgentId = Field(..., description="Agent that handled request")
    confidence: float = Field(..., ge=0, le=1, description="Response confidence score")
    logs: list[RetrievalLog] = Field(..., description="Retrieval operation logs")
    metrics: ChatMetrics = Field(..., description="Performance metrics")
```

Current ChatMetrics structure (Epic 2):
```python
class ChatMetrics(BaseModel):
    tokensUsed: int = Field(..., ge=0, description="Total tokens consumed")
    cost: float = Field(..., ge=0, description="Cost in USD")
    latency: int = Field(..., ge=0, description="Response time in milliseconds")
```

Current RetrievalLog structure:
```python
class RetrievalLog(BaseModel):
    id: str = Field(..., description="Log entry UUID")
    type: LogType = Field(..., description="Type of retrieval operation")
    title: str = Field(..., description="Human-readable log title")
    data: dict[str, Any] = Field(..., description="Operation-specific data")  # Polymorphic!
    timestamp: str = Field(..., description="ISO 8601 timestamp")
    status: LogStatus = Field(..., description="Operation result status")
    chunks: list[DocumentChunk] | None = Field(None, description="Retrieved document chunks")
```

**Note**: RetrievalLog.data is already polymorphic (dict[str, Any]), which allows different structures for different log types. The new QueryAnalysis, VectorSearch, and CacheOperation models define the **shape** of data for each log type but don't replace the dict structure.

### Backward Compatibility Strategy
[Source: docs/stories/epic-3-agent-log-panels.md#Backend Updates Required]
- No new endpoints required - reuse `/api/chat` from Epic 2
- New fields are **additions** not replacements
- Existing fields must maintain same types and validation
- Mock service (Story 3.2) will populate the new fields
- Frontend will gracefully handle missing new fields during transition

### Testing
[Source: docs/architecture/15-testing-strategy.md]

**Test Location**: `orchestratai_api/tests/test_schemas.py`

**Test Framework**: pytest 8.0+

**Test Coverage Target**: 90%+

**Example Test Pattern**:
```python
def test_query_analysis_valid():
    """Test QueryAnalysis with valid data"""
    data = {
        "intent": "Billing inquiry detected",
        "confidence": 0.95,
        "target_agent": AgentId.BILLING,
        "reasoning": "Keywords matched billing domain"
    }
    analysis = QueryAnalysis(**data)
    assert analysis.intent == "Billing inquiry detected"
    assert analysis.confidence == 0.95

def test_query_analysis_invalid_confidence():
    """Test QueryAnalysis rejects invalid confidence score"""
    with pytest.raises(ValidationError):
        QueryAnalysis(
            intent="Test",
            confidence=1.5,  # Invalid: must be 0-1
            target_agent=AgentId.BILLING,
            reasoning="Test"
        )
```

Run tests with: `cd orchestratai_api && uv run pytest tests/test_schemas.py -v`

### Coding Standards
[Source: docs/architecture/16-coding-standards.md]
- **Naming**: Use snake_case for Python functions and variables
- **Type Hints**: All functions must have type hints
- **Docstrings**: All Pydantic models must have class-level docstrings
- **Validation**: Use Pydantic Field with constraints (ge, le, min_length, etc.)
- **Enums**: Always import from `src.models.enums`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation for Epic 3 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
<!-- Dev agent fills this in during implementation -->

### Debug Log References
<!-- Dev agent references debug logs here -->

### Completion Notes
<!-- Dev agent notes during implementation -->

### File List
<!-- Dev agent lists all modified files -->

## QA Results
<!-- QA agent fills this after validation -->
