# Story 2.6: Message Input Area with Send Functionality

## Status
Draft

## Story
**As a** user,
**I want** a text input area with a send button that allows me to type and submit messages,
**so that** I can interact with the AI agents through a familiar chat interface.

## Acceptance Criteria
1. Textarea input expands as user types (max 5 lines)
2. Send button displays with icon (Lucide SendHorizonal)
3. Enter key sends message (Shift+Enter for new line)
4. Send button disabled when input is empty or processing
5. Input clears after successful message send
6. Textarea has placeholder text: "Type your message..."
7. Send button has aria-label for accessibility
8. Input area uses design tokens for styling
9. Character count displays when approaching limit (1800+ chars)
10. Component tested with Vitest component and interaction tests

## Tasks / Subtasks

- [ ] Create InputArea component in `components/chat/input-area.tsx` (AC: 1, 2, 6, 7, 8)
  - [ ] Add 'use client' directive (interactive component)
  - [ ] Define props interface: onSendMessage, isProcessing, disabled?
  - [ ] Create state: `const [message, setMessage] = useState('')`
  - [ ] Use Textarea from shadcn/ui for auto-expanding input
  - [ ] Set maxRows={5} for 5-line max height
  - [ ] Add placeholder: "Type your message..."
  - [ ] Import SendHorizonal icon from lucide-react
  - [ ] Create Button with icon and aria-label: "Send message"
  - [ ] Use design tokens for spacing, borders, colors
  - [ ] Layout: flexbox with textarea left, button right

- [ ] Implement message length validation (AC: 4, 9)
  - [ ] Define MAX_MESSAGE_LENGTH constant (2000 chars)
  - [ ] Disable send if message.trim().length === 0
  - [ ] Disable send if message.length > MAX_MESSAGE_LENGTH
  - [ ] Show character counter when message.length >= 1800
  - [ ] Display as: "{length}/2000" with warning color when over 1800
  - [ ] Use design token for warning color

- [ ] Implement keyboard shortcuts (AC: 3)
  - [ ] Add onKeyDown handler to Textarea
  - [ ] Check for Enter key without Shift key
  - [ ] If Enter (no Shift): preventDefault and call handleSend
  - [ ] If Shift+Enter: allow default (new line)
  - [ ] Ensure keyboard shortcuts work when input is focused

- [ ] Implement send message handler (AC: 4, 5)
  - [ ] Create handleSend function
  - [ ] Trim message before validation
  - [ ] Return early if message is empty or isProcessing
  - [ ] Call onSendMessage(message.trim())
  - [ ] Clear input: setMessage('')
  - [ ] Refocus textarea after send

- [ ] Handle disabled states (AC: 4)
  - [ ] Disable button when isProcessing prop is true
  - [ ] Disable button when message is empty (after trim)
  - [ ] Disable button when disabled prop is true
  - [ ] Disable button when message exceeds max length
  - [ ] Show loading spinner in button when isProcessing
  - [ ] Add visual opacity to disabled button

- [ ] Add loading indicator to button (AC: 4)
  - [ ] Import Loader2 icon from lucide-react
  - [ ] Conditionally render Loader2 when isProcessing, SendHorizonal otherwise
  - [ ] Add `animate-spin` class to Loader2
  - [ ] Update aria-label when processing: "Sending message..."

- [ ] Style with design tokens (AC: 8)
  - [ ] Textarea: `bg-[var(--color-bg-secondary)]`
  - [ ] Border: `border-[var(--color-border)]`
  - [ ] Focus ring: `focus:ring-[var(--color-accent)]`
  - [ ] Button: `bg-[var(--color-agent-primary)]`
  - [ ] Spacing: use `var(--spacing-*)` tokens
  - [ ] Border radius: use `var(--radius-*)` tokens

- [ ] Write component tests (AC: 10)
  - [ ] Test textarea renders with placeholder
  - [ ] Test send button is disabled when input is empty
  - [ ] Test send button is enabled when input has text
  - [ ] Test onSendMessage called when send button clicked
  - [ ] Test onSendMessage called when Enter key pressed
  - [ ] Test Shift+Enter does NOT send message (adds new line)
  - [ ] Test input clears after successful send
  - [ ] Test send button disabled when isProcessing is true
  - [ ] Test character counter appears when length >= 1800
  - [ ] Test send button disabled when message exceeds 2000 chars
  - [ ] Use userEvent from @testing-library/user-event for interactions

## Dev Notes

### üö® CRITICAL: 3-Tier CSS Design Token System Requirements

**This story REQUIRES strict adherence to the 3-tier CSS design token system. Violations will result in PR rejection.**

[Source: docs/ux-design-tokens/css-tokens-usage.md, docs/ux-design-tokens/component-styling-guide.md]

#### Token System Architecture:
```
Layer 3: Component Tokens (--color-input-bg) ‚Üê USE THESE FIRST
    ‚Üì references
Layer 2: Semantic Tokens (--color-bg-primary) ‚Üê FALLBACK ONLY
    ‚Üì references
Layer 1: Primitive Tokens (--token-color-slate-900) ‚Üê NEVER USE DIRECTLY
```

#### MANDATORY RULES:
1. **NEVER use Layer 1 primitive tokens** (`--token-color-*`) directly in components
2. **NEVER create new tokens without explicit approval** - Ask user first with clear justification
3. **ALWAYS use Component Tokens (Layer 3) first** - Only fall back to Semantic (Layer 2) if component token doesn't exist
4. **Use Tailwind opacity syntax** for transparency: `bg-input-bg/50` (NEVER bake opacity into tokens)
5. **Use approved Tailwind utilities**: `bg-input-bg`, `border-input-border`, `text-button-primary-text`

#### Available Input Component Tokens:
```css
/* Form Inputs */
--color-input-bg: #0f172a (Slate 900)
--color-input-border: #374151 (Gray 700)
--color-input-border-hover: #4b5563 (Gray 600)
--color-input-border-focus: #06b6d4 (Cyan 500)
--color-input-text: #f9fafb (Gray 50)
--color-input-placeholder: #4b5563 (Gray 600)

/* Buttons */
--color-button-primary-bg: #0891b2 (Cyan 600)
--color-button-primary-hover: #06b6d4 (Cyan 500)
--color-button-primary-text: #f9fafb (Gray 50)

/* Spacing */
--space-2: 8px
--space-4: 16px
--space-6: 24px

/* Border Radius */
--radius-sm: 4px
--radius-md: 8px
```

#### Correct vs Incorrect Usage:
```tsx
// ‚úÖ CORRECT: Use Component Token
<Textarea className="bg-input-bg border-input-border focus:border-input-border-focus">

// ‚úÖ CORRECT: Use Button Token
<Button className="bg-button-primary-bg hover:bg-button-primary-hover">

// ‚ùå WRONG: Primitive token
<Textarea className="bg-[var(--token-color-slate-900)]">

// ‚ùå WRONG: Arbitrary hex value
<Textarea className="bg-[#0f172a]">

// ‚ùå WRONG: Direct Tailwind color
<Textarea className="bg-slate-900">
```

#### If You Need a New Token:
**STOP and ask the user for approval with this format:**
```
"I need to create a new token for [purpose]:
- Proposed name: --color-[category]-[usage]
- Proposed value: references var(--token-color-[primitive])
- Justification: [why existing tokens cannot be used]
- Can we get designer approval to add this token?"
```

**DO NOT proceed without user approval. Check if opacity modifiers can solve the need first.**

---

### Previous Story Context
- Epic 1 installed shadcn/ui components including Button, Input
- Epic 1 created design token system with color, spacing, radius tokens
- Story 2.5 created message display components
- Story 2.7 will create ChatProvider with sendMessage handler

### Component Specifications
[Source: docs/stories/epic-2-chat-interface.md#lines-184-188]

**InputArea:**
- Textarea auto-expands to 5 lines max
- Send button with icon (Lucide `SendHorizonal`)
- Enter key sends (Shift+Enter for new line)
- Disabled state while processing

### Design Token Usage
[Source: docs/stories/epic-1-foundation-design-system.md#lines-167-174]

**Use CSS variables for all styling:**
```tsx
className="bg-[var(--color-bg-secondary)] border-[var(--color-border)]"
```

**Available tokens:**
- Colors: `--color-bg-primary`, `--color-bg-secondary`, `--color-border`, `--color-accent`, `--color-agent-primary`
- Spacing: `--spacing-2`, `--spacing-4`, `--spacing-6`
- Border radius: `--radius-sm`, `--radius-md`, `--radius-lg`

### File Locations
[Source: docs/architecture/9-frontend-architecture.md#91-component-organization]

**Create this file:**
```
orchestratai_client/src/components/chat/
‚îî‚îÄ‚îÄ input-area.tsx           # Message input + send button
```

**Test file:**
```
orchestratai_client/src/components/chat/__tests__/
‚îî‚îÄ‚îÄ input-area.test.tsx
```

### Component Implementation Pattern

```tsx
'use client';

import { useState, KeyboardEvent } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { SendHorizonal, Loader2 } from 'lucide-react';

interface InputAreaProps {
  onSendMessage: (message: string) => void;
  isProcessing: boolean;
  disabled?: boolean;
}

const MAX_MESSAGE_LENGTH = 2000;
const CHAR_WARNING_THRESHOLD = 1800;

export function InputArea({ onSendMessage, isProcessing, disabled = false }: InputAreaProps) {
  const [message, setMessage] = useState('');

  const trimmedMessage = message.trim();
  const isOverLimit = message.length > MAX_MESSAGE_LENGTH;
  const showCharCount = message.length >= CHAR_WARNING_THRESHOLD;
  const canSend = trimmedMessage.length > 0 && !isProcessing && !disabled && !isOverLimit;

  const handleSend = () => {
    if (!canSend) return;

    onSendMessage(trimmedMessage);
    setMessage('');
  };

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  return (
    <div className="flex gap-2 p-4 border-t border-[var(--color-border)]">
      <div className="flex-1">
        <Textarea
          value={message}
          onChange={(e) => setMessage(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Type your message..."
          maxRows={5}
          className="bg-[var(--color-bg-secondary)] resize-none"
          disabled={disabled}
        />
        {showCharCount && (
          <span className={`text-sm ${isOverLimit ? 'text-red-500' : 'text-gray-500'}`}>
            {message.length}/{MAX_MESSAGE_LENGTH}
          </span>
        )}
      </div>
      <Button
        onClick={handleSend}
        disabled={!canSend}
        aria-label={isProcessing ? 'Sending message...' : 'Send message'}
        className="bg-[var(--color-agent-primary)]"
      >
        {isProcessing ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SendHorizonal className="h-4 w-4" />
        )}
      </Button>
    </div>
  );
}
```

### Textarea Auto-expand
The shadcn Textarea component supports auto-expansion with the `maxRows` prop. This automatically grows the textarea as the user types, up to the specified number of rows.

### Technical Constraints
[Source: docs/architecture/3-tech-stack.md]

- React: 19.2
- shadcn/ui: 3.5.0 (Button, Textarea)
- Lucide React: Latest (SendHorizonal, Loader2 icons)
- Tailwind CSS: 4.0

### Coding Standards
[Source: docs/architecture/16-coding-standards.md]

- **Design Tokens:** Use ONLY token classes, NO arbitrary Tailwind values (except for spacing where tokens don't exist)
- **Client Components:** Add 'use client' directive for interactive components
- **Naming:** PascalCase for components, camelCase for functions

### Accessibility Requirements
- ARIA labels for button states
- Keyboard navigation (Enter/Shift+Enter)
- Focus management (refocus after send)
- Disabled state clearly indicated
- Character limit warnings

### Testing

[Source: docs/architecture/15-testing-strategy.md#152-test-examples]

**Test Framework:** Vitest with @testing-library/react and @testing-library/user-event
**Test Location:** `orchestratai_client/src/components/chat/__tests__/input-area.test.tsx`
**Test Type:** Component tests with user interactions

**Test Pattern:**
```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { InputArea } from '../input-area';

describe('InputArea', () => {
  const mockSendMessage = vi.fn();

  it('renders textarea and send button', () => {
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    expect(screen.getByPlaceholderText('Type your message...')).toBeInTheDocument();
    expect(screen.getByLabelText('Send message')).toBeInTheDocument();
  });

  it('sends message when send button clicked', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'Hello');
    await user.click(screen.getByLabelText('Send message'));

    expect(mockSendMessage).toHaveBeenCalledWith('Hello');
  });

  it('sends message when Enter key pressed', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'Hello{Enter}');

    expect(mockSendMessage).toHaveBeenCalledWith('Hello');
  });

  it('does not send when Shift+Enter pressed', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'Hello{Shift>}{Enter}{/Shift}');

    expect(mockSendMessage).not.toHaveBeenCalled();
  });

  it('disables send button when input is empty', () => {
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    expect(screen.getByLabelText('Send message')).toBeDisabled();
  });

  it('disables send button when processing', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={true} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'Hello');

    expect(screen.getByLabelText('Sending message...')).toBeDisabled();
  });

  it('shows character count when approaching limit', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'a'.repeat(1850));

    expect(screen.getByText(/1850\/2000/)).toBeInTheDocument();
  });

  it('disables send when message exceeds max length', async () => {
    const user = userEvent.setup();
    render(<InputArea onSendMessage={mockSendMessage} isProcessing={false} />);

    const textarea = screen.getByPlaceholderText('Type your message...');
    await user.type(textarea, 'a'.repeat(2100));

    expect(screen.getByLabelText('Send message')).toBeDisabled();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

## QA Results
<!-- Populated by QA agent -->
