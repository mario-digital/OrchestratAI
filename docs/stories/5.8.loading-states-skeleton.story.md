# <!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** developer,
**I want** to analyze and optimize the application bundle size and performance,
**so that** the application loads quickly and achieves Lighthouse score ≥90

## Acceptance Criteria
1. Install `@next/bundle-analyzer`
2. Run bundle analysis and identify large chunks
3. Main bundle <200KB gzipped
4. Implement code splitting for optional features
5. Lighthouse Performance score ≥90
6. First Contentful Paint (FCP) <1.5s
7. Largest Contentful Paint (LCP) <2.5s
8. Time to Interactive (TTI) <3.0s
9. Cumulative Layout Shift (CLS) <0.1
10. Tree-shaking verified (no dead code)
11. Dynamic imports for heavy components
12. Performance metrics tracked in CI

## Tasks / Subtasks

- [ ] Task 1: Install and configure bundle analyzer (AC: 1, 2)
  - [ ] Run: `bun add -d @next/bundle-analyzer`
  - [ ] Open `orchestratai_client/next.config.ts`
  - [ ] Import withBundleAnalyzer
  - [ ] Wrap Next config with analyzer
  - [ ] Enable with ANALYZE environment variable
  - [ ] Add npm script: `"analyze": "ANALYZE=true bun run build"`
  - [ ] Run analysis and review output

- [ ] Task 2: Analyze bundle and identify optimization targets (AC: 2, 10)
  - [ ] Run `bun run analyze`
  - [ ] Open bundle visualization in browser
  - [ ] Identify largest chunks (>50KB)
  - [ ] List third-party libraries by size
  - [ ] Check for duplicate dependencies
  - [ ] Verify tree-shaking working
  - [ ] Document findings in story

- [ ] Task 3: Implement dynamic imports for Modal components (AC: 4, 11)
  - [ ] Identify all Modal components (ShortcutsHelp, DocumentPreview, etc.)
  - [ ] Replace static imports with dynamic()
  - [ ] Use next/dynamic for code splitting
  - [ ] Test modals still work
  - [ ] Verify separate chunks created
  - [ ] Check bundle size reduction

- [ ] Task 4: Implement dynamic imports for React Flow (if used) (AC: 4, 11)
  - [ ] Check if react-flow-renderer is used
  - [ ] If yes: Replace with dynamic import
  - [ ] Add loading prop with skeleton
  - [ ] Test graph visualization still works
  - [ ] Verify chunk separation

- [ ] Task 5: Add React.memo to expensive components (AC: 4)
  - [ ] Profile components with React DevTools Profiler
  - [ ] Identify components that re-render frequently
  - [ ] Wrap with React.memo:
    - AgentCard
    - MessageBubble
    - LogEntry components
  - [ ] Add custom comparison function if needed
  - [ ] Test no regressions

- [ ] Task 6: Optimize third-party libraries (AC: 3, 10)
  - [ ] Review Framer Motion bundle size
  - [ ] Consider replacing large libraries:
    - Use date-fns/esm instead of moment
    - Use lucide-react icons (tree-shakeable)
  - [ ] Remove unused dependencies
  - [ ] Verify imports use tree-shakeable paths
  - [ ] Re-run bundle analysis

- [ ] Task 7: Configure HTTP caching headers (AC: 5)
  - [ ] Open `orchestratai_client/next.config.ts`
  - [ ] Add headers configuration
  - [ ] Cache static assets (1 year)
  - [ ] Cache API responses (appropriate TTL)
  - [ ] Add ETag support
  - [ ] Test with Network tab

- [ ] Task 8: Optimize images (if any) (AC: 3, 7)
  - [ ] Use next/image for all images
  - [ ] Add width and height attributes
  - [ ] Use WebP format
  - [ ] Add blur placeholder
  - [ ] Lazy load below-fold images
  - [ ] Verify LCP improvement

- [ ] Task 9: Run Lighthouse audit (AC: 5, 6, 7, 8, 9)
  - [ ] Open Chrome DevTools → Lighthouse
  - [ ] Run audit on production build
  - [ ] Review Performance score (target: ≥90)
  - [ ] Review Core Web Vitals:
    - FCP < 1.5s
    - LCP < 2.5s
    - TTI < 3.0s
    - CLS < 0.1
  - [ ] Document results
  - [ ] Identify improvement areas

- [ ] Task 10: Fix Lighthouse recommendations (AC: 5, 6, 7, 8, 9)
  - [ ] Address critical issues first
  - [ ] Implement recommendations:
    - Remove unused JavaScript
    - Minify CSS
    - Reduce render-blocking resources
    - Optimize font loading
  - [ ] Re-run Lighthouse
  - [ ] Verify score ≥90

- [ ] Task 11: Set up Lighthouse CI (AC: 12)
  - [ ] Create `.github/workflows/lighthouse.yml`
  - [ ] Install @lhci/cli
  - [ ] Configure lighthouserc.js
  - [ ] Set performance budgets
  - [ ] Run on every PR
  - [ ] Fail build if score < 90

- [ ] Task 12: Document optimization results (AC: All)
  - [ ] Create performance report:
    - Before/after bundle sizes
    - Before/after Lighthouse scores
    - Before/after Core Web Vitals
  - [ ] Add to story Dev Agent Record
  - [ ] Update architecture docs with best practices

- [ ] Task 13: Write performance regression tests (AC: 12)
  - [ ] Test bundle size doesn't exceed thresholds
  - [ ] Test no duplicate dependencies
  - [ ] Test main bundle < 200KB gzipped
  - [ ] Test dynamic imports load correctly
  - [ ] Achieve 90%+ coverage

## Dev Notes

### Previous Story Context
From Story 4.2 (Tab Switching):
- Framer Motion installed (large library)
- Animations add bundle size

From Story 5.1, 5.2 (Animations):
- More Framer Motion usage
- Potential for code splitting

From Story 5.7 (Virtualization):
- react-window library added
- Performance improvements for large lists

### Architecture References

**Next.js Optimization** [Source: Next.js docs]
- Built-in code splitting (automatic)
- Image optimization with next/image
- Font optimization with next/font
- Dynamic imports with next/dynamic
- Tree-shaking enabled by default

**Bundle Analysis** [Source: @next/bundle-analyzer]
- Visualizes bundle composition
- Identifies large dependencies
- Shows code splitting effectiveness
- Helps prioritize optimizations

**Performance Budgets** [Source: Web performance best practices]
- Main bundle: < 200KB gzipped
- Total JavaScript: < 500KB gzipped
- First Load JS: < 300KB
- Lazy-loaded chunks: < 50KB each

### Code Examples

**Bundle Analyzer Setup** (next.config.ts):
```typescript
import type { NextConfig } from 'next';
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

const nextConfig: NextConfig = {
  // Existing config
  reactStrictMode: true,
  swcMinify: true,

  // Performance optimizations
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },

  // HTTP headers for caching
  async headers() {
    return [
      {
        source: '/:all*(svg|jpg|png|webp|woff|woff2)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
      {
        source: '/_next/static/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ];
  },
};

export default withBundleAnalyzer(nextConfig);
```

**Dynamic Import for Modal** (Before):
```typescript
import { ShortcutsHelp } from '@/components/modals/shortcuts-help';

export function Layout() {
  return (
    <>
      {showModal && <ShortcutsHelp />}
    </>
  );
}
```

**Dynamic Import for Modal** (After):
```typescript
import dynamic from 'next/dynamic';

const ShortcutsHelp = dynamic(
  () => import('@/components/modals/shortcuts-help').then(mod => ({
    default: mod.ShortcutsHelp,
  })),
  {
    loading: () => <div>Loading...</div>,
    ssr: false, // Don't render on server (modal not needed for SEO)
  }
);

export function Layout() {
  return (
    <>
      {showModal && <ShortcutsHelp />}
    </>
  );
}
```

**React.memo Optimization** (Before):
```typescript
export function AgentCard({ agent, status, metrics }: Props) {
  return <div>{/* content */}</div>;
}
```

**React.memo Optimization** (After):
```typescript
import React from 'react';

export const AgentCard = React.memo(
  function AgentCard({ agent, status, metrics }: Props) {
    return <div>{/* content */}</div>;
  },
  (prevProps, nextProps) => {
    // Custom comparison
    return (
      prevProps.agent === nextProps.agent &&
      prevProps.status === nextProps.status &&
      prevProps.metrics.tokens === nextProps.metrics.tokens
    );
  }
);
```

**Tree-Shakeable Imports** (Before):
```typescript
import { format, parse, addDays } from 'date-fns';
```

**Tree-Shakeable Imports** (After):
```typescript
import format from 'date-fns/format';
import parse from 'date-fns/parse';
import addDays from 'date-fns/addDays';
```

**Lighthouse CI Configuration** (lighthouserc.js):
```javascript
module.exports = {
  ci: {
    collect: {
      startServerCommand: 'bun run build && bun run start',
      url: ['http://localhost:3000'],
      numberOfRuns: 3,
    },
    assert: {
      assertions: {
        'categories:performance': ['error', { minScore: 0.9 }],
        'first-contentful-paint': ['error', { maxNumericValue: 1500 }],
        'largest-contentful-paint': ['error', { maxNumericValue: 2500 }],
        'cumulative-layout-shift': ['error', { maxNumericValue: 0.1 }],
        'total-blocking-time': ['error', { maxNumericValue: 300 }],
      },
    },
    upload: {
      target: 'temporary-public-storage',
    },
  },
};
```

**GitHub Actions Workflow** (.github/workflows/lighthouse.yml):
```yaml
name: Lighthouse CI

on:
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install
        working-directory: orchestratai_client

      - name: Build application
        run: bun run build
        working-directory: orchestratai_client

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        working-directory: orchestratai_client
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-results
          path: .lighthouseci
```

**Performance Budget Monitoring**:
```json
{
  "budgets": [
    {
      "path": "/*",
      "timings": [
        {
          "metric": "interactive",
          "budget": 3000
        },
        {
          "metric": "first-contentful-paint",
          "budget": 1500
        }
      ],
      "resourceSizes": [
        {
          "resourceType": "script",
          "budget": 200
        },
        {
          "resourceType": "total",
          "budget": 500
        }
      ]
    }
  ]
}
```

**Webpack Bundle Analyzer Output** (example findings):
```
Total Bundle Size: 450KB (180KB gzipped)

Largest Dependencies:
1. framer-motion: 85KB (30KB gzipped)
2. react-window: 8KB (3KB gzipped)
3. sonner: 12KB (4KB gzipped)
4. uuid: 6KB (2KB gzipped)

Recommendations:
- ✅ Tree-shaking working (no unused exports)
- ⚠️ Framer Motion is large (consider lazy loading)
- ✅ No duplicate dependencies
- ⚠️ Modal components in main bundle (split them out)
```

**Font Optimization** (app/layout.tsx):
```typescript
import { Inter } from 'next/font/google';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap', // Show fallback font while loading
  variable: '--font-inter',
});

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en" className={inter.variable}>
      <body>{children}</body>
    </html>
  );
}
```

**Image Optimization** (example):
```typescript
import Image from 'next/image';

export function Logo() {
  return (
    <Image
      src="/logo.png"
      alt="OrchestratAI Logo"
      width={200}
      height={50}
      priority // Load immediately (above fold)
      placeholder="blur"
      blurDataURL="data:image/png;base64,..." // Low-res placeholder
    />
  );
}
```

**Test Example** (tests/bundle-size.test.ts):
```typescript
import { readFileSync, statSync } from 'fs';
import { join } from 'path';
import { gzipSync } from 'zlib';

describe('Bundle size', () => {
  const buildDir = join(__dirname, '../../.next');

  it('main bundle is less than 200KB gzipped', () => {
    const mainBundlePath = join(buildDir, 'static/chunks/main.js');
    const content = readFileSync(mainBundlePath);
    const gzipped = gzipSync(content);

    expect(gzipped.length).toBeLessThan(200 * 1024); // 200KB
  });

  it('no duplicate dependencies in bundle', () => {
    // Read webpack stats
    const statsPath = join(buildDir, 'analyze/client.json');
    const stats = JSON.parse(readFileSync(statsPath, 'utf-8'));

    // Check for duplicate modules
    const moduleNames = stats.modules.map((m: any) => m.name);
    const duplicates = moduleNames.filter(
      (name: string, index: number) => moduleNames.indexOf(name) !== index
    );

    expect(duplicates).toHaveLength(0);
  });
});
```

### File Structure
[Source: architecture/source-tree.md]

```
orchestratai_client/
├── next.config.ts                      # UPDATE: Add bundle analyzer
├── lighthouserc.js                     # NEW: Lighthouse CI config
├── .github/
│   └── workflows/
│       └── lighthouse.yml              # NEW: Lighthouse CI workflow
├── src/
│   ├── components/
│   │   └── modals/
│   │       └── shortcuts-help.tsx      # UPDATE: Export for dynamic import
│   └── __tests__/
│       └── bundle-size.test.ts         # NEW: Bundle size tests
└── package.json                        # UPDATE: Add analyze script
```

### Integration Points
- Affects entire application (global optimization)
- May require updates to multiple components
- CI/CD integration for continuous monitoring
- Works alongside all other Epic 5 stories

### Testing Requirements
- **Bundle Analysis**: Manual review of bundle composition
- **Lighthouse Audit**: Score ≥90 required
- **Automated Tests**: Bundle size regression tests
- **CI Integration**: Lighthouse CI on every PR
- **Coverage Target**: 90%+ for new test files

**Testing Checklist:**
- [ ] Bundle analyzer runs successfully
- [ ] Main bundle < 200KB gzipped
- [ ] Dynamic imports create separate chunks
- [ ] No duplicate dependencies
- [ ] Lighthouse Performance score ≥90
- [ ] FCP < 1.5s
- [ ] LCP < 2.5s
- [ ] TTI < 3.0s
- [ ] CLS < 0.1
- [ ] Lighthouse CI passes in GitHub Actions

### Performance Considerations

**Before Optimization:**
- Bundle size: ~500KB gzipped
- Lighthouse score: ~75
- FCP: 2.5s
- LCP: 3.8s
- TTI: 4.2s

**After Optimization (Target):**
- Bundle size: <200KB gzipped
- Lighthouse score: ≥90
- FCP: <1.5s
- LCP: <2.5s
- TTI: <3.0s

**Key Optimizations:**
1. Code splitting (dynamic imports) - saves ~100KB
2. Tree-shaking (remove unused code) - saves ~50KB
3. React.memo (reduce re-renders) - improves runtime performance
4. Image optimization - improves LCP
5. HTTP caching - improves repeat visits

### Accessibility Guidelines
N/A (Performance optimization doesn't affect accessibility)
However: Ensure optimizations don't break existing accessibility features

### Browser Compatibility
- **Dynamic imports**: All modern browsers (ES2020+)
- **next/image**: Works everywhere (fallback to <img>)
- **HTTP/2**: 97% support (better for multiple small chunks)

### Common Performance Anti-Patterns to Avoid

**❌ Don't:**
- Import entire library: `import _ from 'lodash'`
- Use large moment.js: Use date-fns instead
- Inline large SVGs in JSX (use next/image)
- Block rendering with synchronous scripts
- Use layout-triggering CSS animations

**✅ Do:**
- Tree-shakeable imports: `import debounce from 'lodash/debounce'`
- Use date-fns (14x smaller than moment)
- Optimize images with next/image
- Use async/defer for scripts
- Use transform/opacity animations (GPU accelerated)

### Performance Monitoring Tools

**Development:**
- Next.js Build Output (shows bundle sizes)
- Chrome DevTools → Performance tab
- React DevTools → Profiler
- Webpack Bundle Analyzer

**Production:**
- Lighthouse CI (automated)
- Web Vitals (real user metrics)
- Sentry Performance Monitoring
- Google Analytics (Core Web Vitals report)

**Recommended Setup:**
```typescript
// lib/web-vitals.ts
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

export function reportWebVitals() {
  getCLS(console.log);
  getFID(console.log);
  getFCP(console.log);
  getLCP(console.log);
  getTTFB(console.log);
}

// app/layout.tsx
import { reportWebVitals } from '@/lib/web-vitals';

useEffect(() => {
  reportWebVitals();
}, []);
```

### Dependencies
```json
{
  "devDependencies": {
    "@next/bundle-analyzer": "^14.0.0",
    "@lhci/cli": "^0.13.0",
    "web-vitals": "^3.5.0"
  }
}
```

Install with:
```bash
cd orchestratai_client
bun add -d @next/bundle-analyzer @lhci/cli web-vitals
```

### Expected Bundle Breakdown (After Optimization)

```
Main Bundle (client.js): 150KB gzipped
├── React + React DOM: 45KB
├── Next.js runtime: 35KB
├── App code: 40KB
├── Design tokens + CSS: 15KB
└── Other dependencies: 15KB

Lazy-Loaded Chunks:
├── Modals (shortcuts-help): 8KB
├── Framer Motion (animations): 30KB
├── React Window (virtualization): 3KB
└── Other dynamic imports: ~20KB each

Total First Load JS: ~150KB gzipped ✅
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
