# <!-- Powered by BMAD™ Core -->

## Status
Draft

## Story
**As a** user with motion sensitivity or vestibular disorders,
**I want** all animations to be disabled when I have "reduce motion" enabled in my OS,
**so that** I can use the application without discomfort or nausea

## Acceptance Criteria
1. Detect `prefers-reduced-motion: reduce` media query
2. All Framer Motion animations disabled when reduce motion active
3. Panel transitions instant (no animation)
4. Message appear instantly (no fade-slide)
5. Tab switching instant (no slide)
6. Hover effects reduced to simple opacity change
7. Page still fully functional with animations off
8. CSS animations also respect reduce motion preference

## Tasks / Subtasks

- [ ] Task 1: Create useReducedMotion hook (AC: 1, 2)
  - [ ] Create `orchestratai_client/src/hooks/use-reduced-motion.ts`
  - [ ] Import useState and useEffect from React
  - [ ] Implement media query: `window.matchMedia('(prefers-reduced-motion: reduce)')`
  - [ ] Set up state to track reduce motion preference
  - [ ] Add event listener for preference changes
  - [ ] Clean up listener on unmount
  - [ ] Export hook with boolean return value
  - [ ] Add JSDoc documentation

- [ ] Task 2: Update animations library with reduced motion support (AC: 2, 3, 4, 5, 6)
  - [ ] Open `orchestratai_client/src/lib/animations.ts`
  - [ ] Add `reducedMotion` parameter to all variant functions
  - [ ] Update `fadeSlideUp` to skip animation when reduced motion enabled
  - [ ] Update `panelSlide` to skip animation when reduced motion enabled
  - [ ] Update `staggerContainer` to skip stagger when reduced motion enabled
  - [ ] Update `cardHover` to use opacity only when reduced motion enabled
  - [ ] Update `bounceAnimation` to skip animation when reduced motion enabled
  - [ ] Export helper function `getVariant(variant, reducedMotion)`

- [ ] Task 3: Create motion context provider (AC: 2, 7)
  - [ ] Create `orchestratai_client/src/contexts/motion-context.tsx`
  - [ ] Import useReducedMotion hook
  - [ ] Create MotionContext with reducedMotion boolean
  - [ ] Create MotionProvider component
  - [ ] Export useMotion hook for consuming components
  - [ ] Add provider to root layout

- [ ] Task 4: Update MessageBubble component (AC: 4)
  - [ ] Open `orchestratai_client/src/components/chat/message-bubble.tsx`
  - [ ] Import useMotion hook
  - [ ] Get reducedMotion value from context
  - [ ] Conditionally apply fadeSlideUp variant
  - [ ] If reducedMotion: render without motion wrapper
  - [ ] If normal: render with motion.div and fadeSlideUp
  - [ ] Test instant appearance with reduce motion enabled

- [ ] Task 5: Update CollapsiblePanel component (AC: 3)
  - [ ] Open `orchestratai_client/src/components/panels/collapsible-panel.tsx`
  - [ ] Import useMotion hook
  - [ ] Get reducedMotion value from context
  - [ ] Conditionally apply panelSlide variant
  - [ ] If reducedMotion: instant show/hide (no spring animation)
  - [ ] If normal: use spring animation
  - [ ] Test instant collapse/expand

- [ ] Task 6: Update ThreePanelLayout component (AC: 3)
  - [ ] Open `orchestratai_client/src/components/layout/three-panel-layout.tsx`
  - [ ] Import useMotion hook
  - [ ] Get reducedMotion value from context
  - [ ] Conditionally apply staggerContainer variant
  - [ ] If reducedMotion: panels appear instantly (no stagger)
  - [ ] If normal: staggered reveal
  - [ ] Test instant panel appearance

- [ ] Task 7: Update AgentCard hover effects (AC: 6)
  - [ ] Open `orchestratai_client/src/components/panels/agent-card.tsx`
  - [ ] Import useMotion hook
  - [ ] Get reducedMotion value from context
  - [ ] If reducedMotion: use simple opacity hover (0.8)
  - [ ] If normal: use full cardHover variant (scale + shadow)
  - [ ] Test reduced hover effect

- [ ] Task 8: Update TypingIndicator component (AC: 2)
  - [ ] Open `orchestratai_client/src/components/chat/typing-indicator.tsx`
  - [ ] Import useMotion hook
  - [ ] Get reducedMotion value from context
  - [ ] If reducedMotion: show static dots (no bounce)
  - [ ] If normal: use bounceAnimation
  - [ ] Test static typing indicator

- [ ] Task 9: Add global CSS rule for reduced motion (AC: 8)
  - [ ] Open `orchestratai_client/src/app/globals.css`
  - [ ] Add `@media (prefers-reduced-motion: reduce)` rule
  - [ ] Set all animations to 0.01ms duration
  - [ ] Set transition-duration to 0.01ms
  - [ ] Limit animation-iteration-count to 1
  - [ ] Test CSS animations respect preference

- [ ] Task 10: Test reduced motion functionality (AC: 1-8)
  - [ ] Enable reduce motion in OS settings
  - [ ] Test all animations disabled
  - [ ] Test page remains fully functional
  - [ ] Test hover effects use opacity only
  - [ ] Disable reduce motion in OS settings
  - [ ] Test all animations work normally
  - [ ] Test dynamic preference change works

- [ ] Task 11: Write comprehensive tests (AC: All)
  - [ ] Test useReducedMotion hook detects preference
  - [ ] Test motion context provides correct value
  - [ ] Test components render without animations when reduced motion
  - [ ] Test components render with animations when normal
  - [ ] Test preference change updates components
  - [ ] Mock window.matchMedia in tests
  - [ ] Achieve 90%+ coverage

## Dev Notes

### Previous Story Context
From Story 5.1 (Message & Panel Animations):
- All animation variants defined in `lib/animations.ts`
- Components use Framer Motion for animations
- MessageBubble, CollapsiblePanel, ThreePanelLayout all animated

From Story 5.2 (Agent Card Hover Effects):
- AgentCard uses cardHover variant
- TypingIndicator uses bounceAnimation
- Touch device detection already implemented

### Architecture References

**Accessibility Requirements** [Source: WCAG 2.1 Level AA]
- WCAG 2.1 Success Criterion 2.3.3: Animation from Interactions (Level AAA)
- Users must be able to disable non-essential animations
- Respect OS-level `prefers-reduced-motion` setting
- Application must remain fully functional without animations

**prefers-reduced-motion Media Query** [Source: MDN Web Docs]
```css
@media (prefers-reduced-motion: reduce) {
  /* Reduce or disable animations */
}
```

**Browser Support:**
- Chrome 74+
- Firefox 63+
- Safari 10.1+
- Edge 79+
- 94% global support (Can I Use)

### Code Examples

**useReducedMotion Hook** (hooks/use-reduced-motion.ts):
```typescript
'use client';

import { useState, useEffect } from 'react';

/**
 * Detects if user has enabled "reduce motion" preference in OS
 * Respects WCAG 2.1 accessibility guidelines
 *
 * @returns boolean - true if user prefers reduced motion
 */
export function useReducedMotion(): boolean {
  const [prefersReduced, setPrefersReduced] = useState(false);

  useEffect(() => {
    // Check if window is defined (SSR safety)
    if (typeof window === 'undefined') return;

    const query = window.matchMedia('(prefers-reduced-motion: reduce)');
    setPrefersReduced(query.matches);

    const handleChange = (event: MediaQueryListEvent) => {
      setPrefersReduced(event.matches);
    };

    // Modern browsers
    query.addEventListener('change', handleChange);

    return () => {
      query.removeEventListener('change', handleChange);
    };
  }, []);

  return prefersReduced;
}
```

**Motion Context** (contexts/motion-context.tsx):
```typescript
'use client';

import { createContext, useContext, ReactNode } from 'react';
import { useReducedMotion } from '@/hooks/use-reduced-motion';

interface MotionContextValue {
  reducedMotion: boolean;
}

const MotionContext = createContext<MotionContextValue>({
  reducedMotion: false,
});

/**
 * Provides reduced motion preference to all components
 * Use this instead of calling useReducedMotion directly
 * (avoids multiple media query listeners)
 */
export function MotionProvider({ children }: { children: ReactNode }) {
  const reducedMotion = useReducedMotion();

  return (
    <MotionContext.Provider value={{ reducedMotion }}>
      {children}
    </MotionContext.Provider>
  );
}

/**
 * Hook to access motion preference in components
 * @returns {boolean} reducedMotion - true if user prefers reduced motion
 */
export function useMotion() {
  const context = useContext(MotionContext);
  if (context === undefined) {
    throw new Error('useMotion must be used within MotionProvider');
  }
  return context;
}
```

**Updated Animations Library** (lib/animations.ts):
```typescript
import type { Variants, Transition } from 'framer-motion';

/**
 * Helper function to get animation variant based on reduced motion preference
 * @param variant - The animation variant object
 * @param reducedMotion - Whether reduced motion is enabled
 * @returns Modified variant or instant transition
 */
export function getVariant(variant: Variants, reducedMotion: boolean): Variants {
  if (reducedMotion) {
    // Return instant transition (no animation)
    return {
      initial: variant.animate,
      animate: variant.animate,
      exit: variant.animate,
      transition: { duration: 0 },
    };
  }
  return variant;
}

/**
 * Fade in with slide up motion
 * Respects reduced motion preference
 */
export const fadeSlideUp: Variants = {
  initial: {
    opacity: 0,
    y: 20,
  },
  animate: {
    opacity: 1,
    y: 0,
  },
  exit: {
    opacity: 0,
    y: -20,
  },
  transition: {
    duration: 0.3,
    ease: 'easeOut',
  } as Transition,
};

/**
 * Panel slide with spring physics
 * Respects reduced motion preference
 */
export const panelSlide: Variants = {
  initial: {
    x: -300,
    opacity: 0,
  },
  animate: {
    x: 0,
    opacity: 1,
  },
  exit: {
    x: -300,
    opacity: 0,
  },
  transition: {
    type: 'spring',
    stiffness: 300,
    damping: 30,
  } as Transition,
};

/**
 * Stagger children animations
 * Respects reduced motion preference
 */
export const staggerContainer: Variants = {
  animate: {
    transition: {
      staggerChildren: 0.1,
    },
  },
};

/**
 * Card hover effect
 * Reduced to opacity change when reduced motion enabled
 */
export const cardHover: Variants = {
  hover: {
    scale: 1.02,
    boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
    transition: {
      duration: 0.2,
    },
  },
};

/**
 * Reduced hover effect (opacity only)
 * Used when reduced motion is enabled
 */
export const cardHoverReduced: Variants = {
  hover: {
    opacity: 0.8,
    transition: {
      duration: 0.2,
    },
  },
};

/**
 * Bouncing animation for typing indicator dots
 * Respects reduced motion preference
 */
export const bounceAnimation: Variants = {
  initial: {
    y: 0,
  },
  animate: {
    y: [0, -10, 0],
    transition: {
      duration: 0.6,
      ease: 'easeInOut',
      repeat: Infinity,
      repeatDelay: 0,
    },
  },
};
```

**Updated MessageBubble** (components/chat/message-bubble.tsx):
```typescript
'use client';

import { motion } from 'framer-motion';
import { fadeSlideUp, getVariant } from '@/lib/animations';
import { useMotion } from '@/contexts/motion-context';
import type { Message } from '@/lib/types';

interface MessageBubbleProps {
  message: Message;
}

export function MessageBubble({ message }: MessageBubbleProps) {
  const { reducedMotion } = useMotion();

  // If reduced motion, render without animation wrapper
  if (reducedMotion) {
    return (
      <div
        className={`message-bubble ${message.role}`}
        key={message.id}
      >
        {/* message content */}
      </div>
    );
  }

  // Normal animation
  return (
    <motion.div
      {...fadeSlideUp}
      key={message.id}
      className={`message-bubble ${message.role}`}
    >
      {/* message content */}
    </motion.div>
  );
}
```

**Updated AgentCard with Reduced Hover** (components/panels/agent-card.tsx):
```typescript
'use client';

import { motion } from 'framer-motion';
import { cardHover, cardHoverReduced } from '@/lib/animations';
import { useIsTouchDevice } from '@/hooks/use-is-touch-device';
import { useMotion } from '@/contexts/motion-context';

export function AgentCard(props: AgentCardProps) {
  const isTouch = useIsTouchDevice();
  const { reducedMotion } = useMotion();

  // Determine which hover effect to use
  const hoverVariant = reducedMotion ? cardHoverReduced : cardHover;
  const shouldHover = !isTouch;

  return (
    <motion.div
      className={`agent-card ${props.agent.toLowerCase()}`}
      whileHover={shouldHover ? hoverVariant : undefined}
      role="article"
    >
      {/* card content */}
    </motion.div>
  );
}
```

**Global CSS Rule** (app/globals.css):
```css
/**
 * Respect prefers-reduced-motion preference
 * Disable all animations and transitions for users with motion sensitivity
 * WCAG 2.1 Level AAA compliance
 */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}
```

**Alternative CSS (more specific)**:
```css
@media (prefers-reduced-motion: reduce) {
  /* Disable Framer Motion animations */
  [data-framer-motion] {
    animation: none !important;
    transition: none !important;
  }

  /* Disable CSS animations */
  .animate-shimmer,
  .animate-bounce,
  .animate-pulse {
    animation: none !important;
  }

  /* Instant transitions */
  * {
    transition-duration: 0s !important;
  }
}
```

**Test Example** (hooks/__tests__/use-reduced-motion.test.ts):
```typescript
import { renderHook } from '@testing-library/react';
import { useReducedMotion } from '../use-reduced-motion';

describe('useReducedMotion', () => {
  let matchMediaMock: jest.Mock;

  beforeEach(() => {
    matchMediaMock = jest.fn();
    window.matchMedia = matchMediaMock;
  });

  it('returns false when reduce motion is not enabled', () => {
    matchMediaMock.mockReturnValue({
      matches: false,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
    });

    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(false);
  });

  it('returns true when reduce motion is enabled', () => {
    matchMediaMock.mockReturnValue({
      matches: true,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
    });

    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(true);
  });

  it('updates when preference changes', () => {
    let changeHandler: (event: MediaQueryListEvent) => void;

    matchMediaMock.mockReturnValue({
      matches: false,
      addEventListener: jest.fn((event, handler) => {
        changeHandler = handler;
      }),
      removeEventListener: jest.fn(),
    });

    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(false);

    // Simulate preference change
    changeHandler!({ matches: true } as MediaQueryListEvent);
    expect(result.current).toBe(true);
  });
});
```

### Root Layout Integration

**Update Root Layout** (app/layout.tsx):
```typescript
import { MotionProvider } from '@/contexts/motion-context';

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body>
        <MotionProvider>
          {children}
        </MotionProvider>
      </body>
    </html>
  );
}
```

### File Structure
[Source: architecture/source-tree.md]

```
orchestratai_client/src/
├── hooks/
│   ├── use-reduced-motion.ts           # NEW: Detect reduce motion preference
│   └── __tests__/
│       └── use-reduced-motion.test.ts  # NEW: Hook tests
├── contexts/
│   ├── motion-context.tsx              # NEW: Motion context provider
│   └── __tests__/
│       └── motion-context.test.tsx     # NEW: Context tests
├── lib/
│   └── animations.ts                   # UPDATE: Add reduced motion variants
├── app/
│   ├── layout.tsx                      # UPDATE: Add MotionProvider
│   └── globals.css                     # UPDATE: Add reduced motion CSS
└── components/
    ├── chat/
    │   ├── message-bubble.tsx          # UPDATE: Respect reduced motion
    │   └── typing-indicator.tsx        # UPDATE: Respect reduced motion
    ├── panels/
    │   ├── agent-card.tsx              # UPDATE: Reduced hover effect
    │   └── collapsible-panel.tsx       # UPDATE: Instant transitions
    └── layout/
        └── three-panel-layout.tsx      # UPDATE: No stagger animation
```

### Integration Points
- Integrates with ALL animations from Stories 5.1 and 5.2
- Wraps entire app with MotionProvider
- Components conditionally render based on reduced motion preference
- Global CSS rule as fallback for any missed animations

### Testing Requirements
- **Unit Tests**: useReducedMotion hook, MotionContext
- **Component Tests**: All animated components with reduced motion enabled/disabled
- **Integration Tests**: Preference change updates all components
- **Coverage Target**: 90%+
- **Manual Testing**: Test with OS reduce motion setting

**Testing Checklist:**
- [ ] Hook detects reduce motion preference
- [ ] Context provides correct value
- [ ] MessageBubble appears instantly
- [ ] Panels transition instantly
- [ ] Hover effects use opacity only
- [ ] Page remains fully functional
- [ ] Preference change updates dynamically

### Performance Considerations
- Single media query listener (in MotionProvider, not each component)
- Reduced motion improves performance (no animation calculations)
- CSS rule catches any animations not handled by React
- No layout shifts (elements appear in final position)

### Accessibility Guidelines
**[Source: WCAG 2.1]**

**Success Criterion 2.3.3: Animation from Interactions (Level AAA)**
- Motion animation triggered by interaction can be disabled
- Unless animation is essential to functionality

**Success Criterion 2.2.2: Pause, Stop, Hide (Level A)**
- Users can pause, stop, or hide moving content

**Implementation:**
- ✅ Detect OS preference automatically
- ✅ No user action required
- ✅ All animations disabled when preference enabled
- ✅ Application remains fully functional
- ✅ Hover effects reduced to opacity (still provides feedback)

**Testing with Screen Readers:**
- Animations should not interfere with screen reader announcements
- Test with VoiceOver (Mac) and NVDA (Windows)
- Verify ARIA live regions still announce correctly

### Browser Compatibility
- **prefers-reduced-motion**: 94% global support
  - Chrome 74+ (April 2019)
  - Firefox 63+ (October 2018)
  - Safari 10.1+ (March 2017)
  - Edge 79+ (January 2020)

**Fallback Strategy:**
- Older browsers ignore media query (animations work normally)
- No polyfill needed (progressive enhancement)
- Global CSS rule ensures all animations respect preference

### How to Test Manually

**macOS:**
1. System Settings → Accessibility → Display
2. Enable "Reduce motion"
3. Reload application
4. Verify all animations disabled

**Windows:**
1. Settings → Ease of Access → Display
2. Enable "Show animations in Windows"
3. Reload application
4. Verify all animations disabled

**DevTools:**
```javascript
// Emulate reduce motion in Chrome DevTools
// Open DevTools → Command Palette (Cmd+Shift+P)
// Type "Show Rendering"
// Check "Emulate CSS media feature prefers-reduced-motion"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->
