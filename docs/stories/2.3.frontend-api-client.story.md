# Story 2.3: Frontend API Client with Error Handling

## Status
Draft

## Story
**As a** frontend developer,
**I want** a type-safe API client with comprehensive error handling and retry logic,
**so that** all HTTP requests to the backend are validated, errors are properly classified, and the application handles network failures gracefully.

## Acceptance Criteria
1. Base API client class created in `lib/api-client.ts` with generic request method
2. Custom error classes created: `APIError`, `ValidationError`, `NetworkError`, `TimeoutError`
3. All API responses validated against expected types (using TypeScript generics)
4. Request timeout implemented (30 seconds default, configurable)
5. Automatic retry logic for network errors (max 3 attempts with exponential backoff)
6. Environment variable `NEXT_PUBLIC_API_URL` used for base URL configuration
7. Request/response logging in development mode only
8. Error responses include status code, message, and optional details

## Tasks / Subtasks

- [ ] Create custom error classes in `orchestratai_client/src/lib/errors.ts` (AC: 2, 8)
  - [ ] Define base `APIError` class with statusCode, message, details properties
  - [ ] Define `ValidationError` extending APIError for schema validation failures
  - [ ] Define `NetworkError` extending APIError for fetch failures
  - [ ] Define `TimeoutError` extending APIError for request timeouts
  - [ ] Add proper error name assignment in constructors
  - [ ] Add type definitions for error details

- [ ] Create base API client in `orchestratai_client/src/lib/api-client.ts` (AC: 1, 3, 4, 6, 7)
  - [ ] Define `APIClient` class with baseUrl property
  - [ ] Read baseUrl from `process.env.NEXT_PUBLIC_API_URL` or default to 'http://localhost:8000'
  - [ ] Implement generic `request<T>()` method with timeout support
  - [ ] Use AbortController for 30-second timeout
  - [ ] Parse and type-check response JSON
  - [ ] Throw `APIError` for non-2xx status codes
  - [ ] Add development-only console logging (check process.env.NODE_ENV)

- [ ] Implement HTTP method helpers (AC: 1)
  - [ ] Implement `get<T>(endpoint: string)` method
  - [ ] Implement `post<T>(endpoint: string, data: unknown)` method
  - [ ] Implement `put<T>(endpoint: string, data: unknown)` method
  - [ ] Implement `delete<T>(endpoint: string)` method
  - [ ] All methods use generic `request<T>()` internally

- [ ] Implement retry logic with exponential backoff (AC: 5)
  - [ ] Create `retryWithBackoff()` helper function
  - [ ] Retry only on network errors (not 4xx/5xx responses)
  - [ ] Max 3 retry attempts
  - [ ] Exponential backoff: 1s, 2s, 4s delays
  - [ ] Wrap `request()` method with retry logic
  - [ ] Log retry attempts in development mode

- [ ] Add request/response interceptors (AC: 7)
  - [ ] Create `logRequest()` helper (logs in dev mode only)
  - [ ] Create `logResponse()` helper (logs in dev mode only)
  - [ ] Log endpoint, method, status code, response time
  - [ ] Conditionally call loggers based on NODE_ENV

- [ ] Write unit tests for API client (AC: 2, 4, 5)
  - [ ] Test successful request returns typed data
  - [ ] Test 4xx error throws APIError with correct status code
  - [ ] Test 5xx error throws APIError
  - [ ] Test network failure throws NetworkError
  - [ ] Test timeout throws TimeoutError after 30s
  - [ ] Test retry logic attempts 3 times for network errors
  - [ ] Test retry does NOT occur for 4xx/5xx errors
  - [ ] Mock fetch with Vitest

- [ ] Create singleton API client instance (AC: 1)
  - [ ] Export default instance: `export const apiClient = new APIClient()`
  - [ ] Export class for testing: `export { APIClient }`

## Dev Notes

### Previous Story Context
- Story 2.1 and 2.2 created backend with Pydantic models and /api/chat endpoint
- Backend returns JSON matching ChatResponse schema
- Epic 1 created TypeScript enums and Zod schemas in `lib/enums.ts` and `lib/schemas.ts`

### Frontend Architecture Pattern
[Source: docs/architecture/9-frontend-architecture.md#93-api-client]

**API Client Structure:**
```typescript
// lib/api-client.ts
export class APIClient {
  private baseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

  async request<T>(endpoint: string, options: RequestInit): Promise<T> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);

    try {
      const response = await fetch(`${this.baseUrl}${endpoint}`, {
        ...options,
        signal: controller.signal,
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        const errorText = await response.text();
        throw new APIError(response.status, errorText);
      }

      return await response.json() as T;
    } catch (error) {
      if (error instanceof DOMException && error.name === 'AbortError') {
        throw new TimeoutError('Request timed out after 30 seconds');
      }
      throw error;
    }
  }

  async post<T>(endpoint: string, data: unknown): Promise<T> {
    return this.request<T>(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
  }
}

export const apiClient = new APIClient();
```

### Error Handling Strategy
[Source: docs/architecture/17-error-handling-strategy.md#172-frontend-error-handling]

**Custom Error Classes:**
```typescript
// lib/errors.ts
export class APIError extends Error {
  constructor(
    public statusCode: number,
    message: string,
    public details?: unknown
  ) {
    super(message);
    this.name = 'APIError';
  }
}

export class ValidationError extends Error {
  constructor(message: string, public errors: unknown) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class NetworkError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'NetworkError';
  }
}

export class TimeoutError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'TimeoutError';
  }
}
```

### Retry Logic Pattern
Exponential backoff with max 3 attempts:

```typescript
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries = 3
): Promise<T> {
  let lastError: Error;

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;

      // Only retry on network errors, not API errors (4xx/5xx)
      if (error instanceof APIError) {
        throw error;
      }

      if (attempt < maxRetries - 1) {
        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  throw lastError!;
}
```

### File Locations
[Source: docs/architecture/9-frontend-architecture.md#91-component-organization]

**Create these files:**
```
orchestratai_client/src/lib/
├── api-client.ts         # Base HTTP client class
└── errors.ts             # Custom error classes
```

**Test files:**
```
orchestratai_client/src/lib/
└── __tests__/
    └── api-client.test.ts
```

### Technical Constraints
[Source: docs/architecture/3-tech-stack.md]

- TypeScript: 5.6+
- Runtime: Bun 1.1+
- Testing: Vitest
- No external HTTP libraries (use native fetch)

### Environment Variables
[Source: docs/architecture/12-development-workflow.md#124-environment-variables]

**Frontend .env.local:**
```
NEXT_PUBLIC_API_URL=http://localhost:8000
```

**Docker network (Server Components):**
API accessible at `http://backend:8000` (internal Docker network).

**Browser (Client Components):**
API accessible at `http://localhost:8000` (exposed port).

### Coding Standards
[Source: docs/architecture/16-coding-standards.md#161-critical-rules]

- **Naming:** camelCase for functions (`sendMessage`), PascalCase for classes (`APIClient`)
- **Error handling:** Use custom error classes, never silent failures
- **Type safety:** All request/response must be typed with generics

### Testing

[Source: docs/architecture/15-testing-strategy.md#152-test-examples]

**Test Framework:** Vitest
**Test Location:** `orchestratai_client/src/lib/__tests__/api-client.test.ts`
**Test Type:** Unit tests (70% of test pyramid)

**Test Pattern:**
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { APIClient, APIError, NetworkError, TimeoutError } from '../api-client';

describe('APIClient', () => {
  let apiClient: APIClient;

  beforeEach(() => {
    apiClient = new APIClient();
    vi.clearAllMocks();
  });

  it('should make successful GET request', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: async () => ({ data: 'test' }),
    });

    const result = await apiClient.get('/test');
    expect(result).toEqual({ data: 'test' });
  });

  it('should throw APIError on 4xx response', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      ok: false,
      status: 400,
      text: async () => 'Bad Request',
    });

    await expect(apiClient.get('/test')).rejects.toThrow(APIError);
  });

  it('should retry on network error', async () => {
    global.fetch = vi.fn()
      .mockRejectedValueOnce(new Error('Network error'))
      .mockRejectedValueOnce(new Error('Network error'))
      .mockResolvedValue({ ok: true, json: async () => ({ data: 'test' }) });

    const result = await apiClient.get('/test');
    expect(global.fetch).toHaveBeenCalledTimes(3);
    expect(result).toEqual({ data: 'test' });
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

## QA Results
<!-- Populated by QA agent -->
