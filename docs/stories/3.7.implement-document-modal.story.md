# Story 3.7: Implement Document Preview Modal with Full Text Viewer

## Status
Draft

## Story
**As a** user,
**I want** to click "View Full" on document snippets to see the complete text in a modal,
**so that** I can read the full context of retrieved documents without cluttering the retrieval log.

## Acceptance Criteria
1. DocumentModal component renders using shadcn/ui Dialog
2. Modal displays document source filename as title
3. Modal shows similarity score as percentage
4. Full document content displays in monospace font with preserved formatting
5. Modal has max width (3xl) and max height (80vh)
6. Modal content scrolls if document is long
7. Modal closes via X button, Esc key, or clicking outside
8. Modal has proper accessibility (keyboard navigation, focus trap)
9. DocumentPreview "View Full" button opens modal with correct document
10. Modal state managed locally in DocumentPreview component

## Tasks / Subtasks

- [ ] Install shadcn Dialog component (AC: 1)
  - [ ] Run `cd orchestratai_client && bunx shadcn@latest add dialog`
  - [ ] Verify installation in `components.json` and `components/ui/dialog.tsx`

- [ ] Create DocumentModal component (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create file `orchestratai_client/src/components/panels/document-modal.tsx`
  - [ ] Mark as Client Component
  - [ ] Create DocumentModalProps interface:
    ```typescript
    interface DocumentModalProps {
      isOpen: boolean;
      onClose: () => void;
      document: {
        source: string;
        content: string;
        similarity: number;
      } | null;
    }
    ```
  - [ ] Import Dialog components: Dialog, DialogContent, DialogHeader, DialogTitle
  - [ ] Set Dialog open state to isOpen prop
  - [ ] Set onOpenChange to onClose callback
  - [ ] Render DialogContent with max-w-3xl and max-h-[80vh]
  - [ ] Add overflow-y-auto to content area
  - [ ] Display source as DialogTitle
  - [ ] Display similarity percentage with Badge
  - [ ] Render content in <pre> tag with whitespace-pre-wrap and font-mono

- [ ] Update DocumentPreview with modal state (AC: 9, 10)
  - [ ] Open `orchestratai_client/src/components/panels/document-preview.tsx`
  - [ ] Add useState for modal: `const [isModalOpen, setIsModalOpen] = useState(false)`
  - [ ] Remove onViewFull prop (manage state locally)
  - [ ] Change "View Full" button onClick to `setIsModalOpen(true)`
  - [ ] Render DocumentModal component below preview
  - [ ] Pass isModalOpen, onClose, and document props to modal

- [ ] Style modal content area (AC: 4, 5, 6)
  - [ ] Apply Tailwind classes to content wrapper:
    - `max-w-3xl`: Limit modal width
    - `max-h-[80vh]`: Limit modal height to 80% viewport
    - `overflow-y-auto`: Enable scrolling for long content
  - [ ] Apply content text styling:
    - `whitespace-pre-wrap`: Preserve line breaks and wrapping
    - `font-mono`: Monospace font for readability
    - `text-sm`: Smaller text for content density
    - `p-4`: Padding around content

- [ ] Add similarity badge to modal header (AC: 3)
  - [ ] Display similarity as percentage: `{(similarity * 100).toFixed(1)}%`
  - [ ] Use shadcn Badge component with color coding:
    - ≥80% → green Badge
    - 60-79% → yellow Badge
    - <60% → red Badge
  - [ ] Position badge next to title using flex layout

- [ ] Implement modal accessibility (AC: 7, 8)
  - [ ] shadcn Dialog already handles:
    - Focus trap (focus stays in modal)
    - Esc key closes modal
    - Click outside closes modal
    - ARIA attributes (role="dialog", aria-labelledby, etc.)
  - [ ] Verify keyboard navigation works (Tab through elements)
  - [ ] Verify screen reader announces modal properly

- [ ] Handle null document state (AC: 9)
  - [ ] In DocumentModal, check if document is null
  - [ ] Return null early if document is null (don't render)
  - [ ] Prevents errors if modal opened without document

- [ ] Write unit tests for DocumentModal (AC: 1-8)
  - [ ] Create test file `orchestratai_client/tests/unit/components/panels/document-modal.test.tsx`
  - [ ] Test modal renders when isOpen is true
  - [ ] Test modal doesn't render when isOpen is false
  - [ ] Test displays document source as title
  - [ ] Test displays similarity percentage
  - [ ] Test displays full content
  - [ ] Test onClose called when close button clicked
  - [ ] Test onClose called when Escape pressed
  - [ ] Test content scrolls when document is long

- [ ] Write integration test for modal interaction (AC: 9, 10)
  - [ ] Create test file `orchestratai_client/tests/integration/document-modal-interaction.test.tsx`
  - [ ] Render DocumentPreview with long document content
  - [ ] Click "View Full" button
  - [ ] Assert modal opens and displays full content
  - [ ] Click close button
  - [ ] Assert modal closes

- [ ] Update DocumentPreview interface (AC: 9, 10)
  - [ ] Remove onViewFull prop from DocumentPreviewProps
  - [ ] Modal state now managed internally
  - [ ] Update Story 3.6 documentation if needed

## Dev Notes

### 🚨 CRITICAL: 3-Tier CSS Token System - NO ARBITRARY VALUES

**MANDATORY**: This story follows the strict 3-tier CSS token system. See Story 3.3 for complete guidelines.

**Quick Rules**:
1. ❌ NEVER use arbitrary colors for similarity badges: `bg-green-500/20`, `text-green-700`
2. ✅ Reuse existing semantic tokens: `--color-success`, `--color-warning`, `--color-error`
3. 🛑 If modal-specific tokens needed, HALT and ask user permission
4. ✅ Use existing: `text-text-tertiary`, `font-mono`, spacing tokens

**Likely Safe to Use** (already semantic):
```css
bg-success/20 text-success  /* High similarity >= 0.8 */
bg-warning/20 text-warning  /* Medium similarity 0.6-0.8 */
bg-error/20 text-error      /* Low similarity < 0.6 */
```

[Full details: Story 3.3 Dev Notes]

### Source Tree Info
[Source: docs/architecture/source-tree.md]
- Component: `orchestratai_client/src/components/panels/document-modal.tsx`
- Update: `orchestratai_client/src/components/panels/document-preview.tsx`
- Tests: `orchestratai_client/tests/unit/components/panels/document-modal.test.tsx`

### Modal Specifications
[Source: docs/stories/epic-3-agent-log-panels.md#Document Modal Implementation]

**Modal Structure**:
```tsx
<Dialog open={isOpen} onOpenChange={onClose}>
  <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
    <DialogHeader>
      <div className="flex items-center justify-between">
        <DialogTitle>{document.source}</DialogTitle>
        <Badge className={getSimilarityBadgeColor(document.similarity)}>
          {(document.similarity * 100).toFixed(1)}%
        </Badge>
      </div>
    </DialogHeader>
    <div className="mt-4 p-4">
      <pre className="whitespace-pre-wrap font-mono text-sm">
        {document.content}
      </pre>
    </div>
  </DialogContent>
</Dialog>
```

### Similarity Badge Colors
```typescript
function getSimilarityBadgeColor(similarity: number): string {
  if (similarity >= 0.8) return "bg-green-500/20 text-green-700";
  if (similarity >= 0.6) return "bg-yellow-500/20 text-yellow-700";
  return "bg-red-500/20 text-red-700";
}
```

### shadcn/ui Dialog Component
[Source: docs/architecture/3-tech-stack.md]

**Installation**: `bunx shadcn@latest add dialog`

**Built-in Features**:
- Focus trap (focus locked inside modal)
- Esc key handling (closes modal)
- Click outside handling (closes modal)
- ARIA attributes (role="dialog", aria-labelledby, etc.)
- Keyboard navigation (Tab cycles through interactive elements)

**Usage**:
```tsx
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
```

### Content Formatting
[Source: docs/stories/epic-3-agent-log-panels.md#Document Modal]

**Requirements**:
- Use monospace font for readability (`font-mono`)
- Preserve whitespace and line breaks (`whitespace-pre-wrap`)
- Allow horizontal wrapping (no `whitespace-pre`)
- Smaller font size for density (`text-sm`)
- Padding for breathing room (`p-4`)

**Why whitespace-pre-wrap?**
- `whitespace-pre`: Preserves whitespace but doesn't wrap (causes horizontal scroll)
- `whitespace-pre-wrap`: Preserves whitespace AND wraps text (best for long documents)

### Modal State Management Pattern
[Source: Epic 3 Technical Decisions]

**Local State vs Context**:
- Modal state managed **locally** in DocumentPreview component
- Reason: Modal is UI-specific, not global application state
- Each DocumentPreview can have its own modal

**Pattern**:
```tsx
function DocumentPreview({ source, content, similarity }: DocumentPreviewProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);

  return (
    <>
      <div className="border rounded p-2">
        <p className="text-xs text-text-tertiary">{source}</p>
        <p className="text-sm">{truncateContent(content)}</p>
        <button onClick={() => setIsModalOpen(true)}>View Full</button>
      </div>

      <DocumentModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        document={{ source, content, similarity }}
      />
    </>
  );
}
```

### Testing Strategy
[Source: docs/architecture/15-testing-strategy.md]

**Unit Tests** (document-modal.test.tsx):
```typescript
describe('DocumentModal', () => {
  const mockDocument = {
    source: "pricing_faq.md",
    content: "Full document content here...",
    similarity: 0.92,
  };

  it('renders when isOpen is true', () => {
    render(
      <DocumentModal
        isOpen={true}
        onClose={vi.fn()}
        document={mockDocument}
      />
    );
    expect(screen.getByText("pricing_faq.md")).toBeInTheDocument();
    expect(screen.getByText(/Full document content/)).toBeInTheDocument();
  });

  it('does not render when isOpen is false', () => {
    render(
      <DocumentModal
        isOpen={false}
        onClose={vi.fn()}
        document={mockDocument}
      />
    );
    expect(screen.queryByText("pricing_faq.md")).not.toBeInTheDocument();
  });

  it('displays similarity percentage', () => {
    render(
      <DocumentModal
        isOpen={true}
        onClose={vi.fn()}
        document={mockDocument}
      />
    );
    expect(screen.getByText("92.0%")).toBeInTheDocument();
  });
});
```

**Integration Tests** (document-modal-interaction.test.tsx):
```typescript
describe('DocumentModal interaction', () => {
  it('opens modal when View Full clicked', async () => {
    const user = userEvent.setup();
    render(
      <DocumentPreview
        source="test.md"
        content="a".repeat(300)
        similarity={0.9}
      />
    );

    const viewButton = screen.getByText("View Full");
    await user.click(viewButton);

    expect(screen.getByRole('dialog')).toBeInTheDocument();
    expect(screen.getByText("test.md")).toBeInTheDocument();
  });
});
```

### Accessibility Considerations
[Source: docs/stories/epic-3-agent-log-panels.md#Non-Functional Requirements]

**Modal Accessibility Checklist**:
- ✅ Modal has role="dialog" (shadcn provides)
- ✅ DialogTitle provides aria-labelledby (shadcn provides)
- ✅ Focus trapped inside modal (shadcn provides)
- ✅ Esc key closes modal (shadcn provides)
- ✅ Screen reader announces modal opening (shadcn provides)
- ✅ Keyboard navigation works (Tab through elements)

shadcn Dialog component handles all these requirements automatically.

### Integration with Story 3.6
- Story 3.6 creates DocumentPreview component
- This story adds DocumentModal component
- Updates DocumentPreview to use local modal state
- No changes to RetrievalPanel or other components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Initial story creation for Epic 3 | Scrum Master (Bob) |

## Dev Agent Record
<!-- Dev agent fills in during implementation -->

## QA Results
<!-- QA agent fills after validation -->
